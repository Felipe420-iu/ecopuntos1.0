<!-- Sidebar Admin Simplificado Corregido -->
<div class="admin-sidebar">
    <div class="sidebar-header">
        {% load static %}
        <img src="{% static 'core/img/eco.jpg' %}" alt="Admin Logo" class="admin-logo">
        <h5 class="mb-0">Panel Administrativo</h5>
        <small class="text-muted">Eco Puntos</small>
    </div>
    
    <div class="sidebar-content">
        <ul class="nav flex-column mt-4">
            <!-- üìä DASHBOARD -->
            <li class="nav-item">
                <a class="nav-link active" href="{% url 'paneladmin' %}">
                    <i class="fas fa-chart-pie"></i> Dashboard
                </a>
            </li>
            
            <!-- üë• GESTI√ìN USUARIOS -->
            <li class="nav-item dropdown-menu-item">
                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="collapse" data-bs-target="#usuariosSubmenu" aria-expanded="false" aria-controls="usuariosSubmenu">
                    <i class="fas fa-users"></i> 
                    <span>Gesti√≥n Usuarios</span>
                    <span class="notification-badge">5</span>
                    <i class="fas fa-chevron-down ms-auto dropdown-arrow"></i>
                </a>
                <div class="collapse" id="usuariosSubmenu">
                    <ul class="submenu list-unstyled">
                        <li><a class="nav-link submenu-link" href="{% url 'usuarioadmin' %}"><i class="fas fa-list"></i> Lista de Usuarios</a></li>
                        <li><a class="nav-link submenu-link" href="{% url 'monitor_sesiones' %}"><i class="fas fa-desktop"></i> Monitor de Sesiones</a></li>
                    </ul>
                </div>
            </li>
            
            <!-- üîÑ OPERACIONES -->
            <li class="nav-item dropdown-menu-item">
                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="collapse" data-bs-target="#operacionesSubmenu" aria-expanded="false" aria-controls="operacionesSubmenu">
                    <i class="fas fa-cogs"></i> 
                    <span>Operaciones</span>
                    <i class="fas fa-chevron-down ms-auto dropdown-arrow"></i>
                </a>
                <div class="collapse" id="operacionesSubmenu">
                    <ul class="submenu list-unstyled">
                        <li><a class="nav-link submenu-link" href="{% url 'canjeadmin' %}"><i class="fas fa-exchange-alt"></i> Gesti√≥n Canjes</a></li>
                        <li><a class="nav-link submenu-link" href="{% url 'retiroadmin' %}"><i class="fas fa-money-bill-wave"></i> Procesar Retiros</a></li>
                        <li><a class="nav-link submenu-link" href="{% url 'stock_recompensas' %}"><i class="fas fa-boxes"></i> Stock de Recompensas</a></li>
                    </ul>
                </div>
            </li>
            
            <!-- üí¨ SOPORTE Y CHAT -->
            <li class="nav-item dropdown-menu-item">
                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="collapse" data-bs-target="#soporteSubmenu" aria-expanded="false" aria-controls="soporteSubmenu">
                    <i class="fas fa-comments"></i> 
                    <span>Soporte</span>
                    <span class="notification-badge" id="chat-notifications" style="display: none;">0</span>
                    <i class="fas fa-chevron-down ms-auto dropdown-arrow"></i>
                </a>
                <div class="collapse" id="soporteSubmenu">
                    <ul class="submenu list-unstyled">
                        <li><a class="nav-link submenu-link" href="{% url 'listar_solicitudes_soporte' %}"><i class="fas fa-headset"></i> Solicitudes Soporte</a></li>
                    </ul>
                </div>
            </li>
            
            <!-- üó∫Ô∏è LOG√çSTICA -->
            <li class="nav-item">
                <a class="nav-link" href="{% url 'rutas' %}">
                    <i class="fas fa-route"></i> Rutas
                </a>
            </li>
            
            <!-- ‚öôÔ∏è SISTEMA -->
            <li class="nav-item dropdown-menu-item">
                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="collapse" data-bs-target="#sistemaSubmenu" aria-expanded="false" aria-controls="sistemaSubmenu">
                    <i class="fas fa-server"></i> 
                    <span>Sistema</span>
                    <i class="fas fa-chevron-down ms-auto dropdown-arrow"></i>
                </a>
                <div class="collapse" id="sistemaSubmenu">
                    <ul class="submenu list-unstyled">
                        <li><a class="nav-link submenu-link" href="{% url 'estadisticasadmin' %}"><i class="fas fa-chart-line"></i> Estad√≠sticas</a></li>
                    </ul>
                </div>
            </li>
            
            <!-- üö™ CERRAR SESI√ìN -->
            <li class="nav-item mt-auto">
                <a class="nav-link text-danger" href="#" data-bs-toggle="modal" data-bs-target="#logoutAdminModal">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </a>
            </li>
        </ul>
    </div>
</div>

<style>
/* Estilos corregidos para sidebar */
.admin-sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 100vh;
    background: #fff;
    border-right: 1px solid #e9ecef;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
}

/* Responsive sidebar */
@media (max-width: 768px) {
    .admin-sidebar {
        transform: translateX(-100%);
    }
    
    .admin-sidebar.show {
        transform: translateX(0);
    }
}

.admin-sidebar .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    background: white;
    color: #333;
    text-align: center;
    flex-shrink: 0;
}

.admin-sidebar .sidebar-header .admin-logo {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-bottom: 10px;
    border: 3px solid rgba(46, 204, 113, 0.3);
}

.admin-sidebar .sidebar-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 0;
}

/* Personalizar la barra de scroll */
.admin-sidebar .sidebar-content::-webkit-scrollbar {
    width: 6px;
}

.admin-sidebar .sidebar-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.admin-sidebar .sidebar-content::-webkit-scrollbar-thumb {
    background: #2ecc71;
    border-radius: 3px;
}

.admin-sidebar .sidebar-content::-webkit-scrollbar-thumb:hover {
    background: #27ae60;
}

/* Navegaci√≥n principal */
.admin-sidebar .nav {
    padding: 10px 0;
}

.admin-sidebar .nav-item {
    margin-bottom: 2px;
}

.admin-sidebar .nav-link {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: #6c757d;
    text-decoration: none;
    transition: all 0.3s ease;
    border-radius: 0;
    border: none;
    background: none;
    position: relative;
}

.admin-sidebar .nav-link:hover {
    background-color: rgba(46, 204, 113, 0.1);
    color: #2ecc71;
    border-left: 4px solid #2ecc71;
    padding-left: 16px;
}

.admin-sidebar .nav-link.active {
    background-color: rgba(46, 204, 113, 0.2);
    border-left: 4px solid #2ecc71;
    color: #2ecc71;
    font-weight: 600;
    padding-left: 16px;
}

.admin-sidebar .nav-link i {
    margin-right: 15px;
    font-size: 1.1rem;
    width: 20px;
    text-align: center;
}

/* Dropdowns */
.admin-sidebar .dropdown-menu-item .nav-link {
    justify-content: space-between;
    cursor: pointer;
}

.admin-sidebar .dropdown-toggle::after {
    display: none;
}

.admin-sidebar .dropdown-arrow {
    transition: transform 0.3s ease;
    font-size: 0.8rem;
    margin-left: auto;
}

.admin-sidebar .dropdown-toggle[aria-expanded="true"] .dropdown-arrow {
    transform: rotate(180deg);
}

/* Submen√∫s */
.admin-sidebar .collapse {
    transition: height 0.35s ease;
    overflow: visible;
}

.admin-sidebar .submenu {
    padding: 0;
    margin: 0;
    background-color: rgba(248, 249, 250, 0.8);
    border-left: 3px solid rgba(46, 204, 113, 0.3);
}

.admin-sidebar .submenu li {
    margin: 0;
}

.admin-sidebar .submenu-link {
    display: flex;
    align-items: center;
    padding: 10px 20px 10px 40px;
    font-size: 0.9rem;
    color: #6c757d;
    transition: all 0.3s ease;
    text-decoration: none;
    border-left: none;
}

.admin-sidebar .submenu-link:hover {
    background-color: rgba(46, 204, 113, 0.15);
    color: #2ecc71;
    padding-left: 45px;
    border-left: 3px solid #2ecc71;
}

.admin-sidebar .submenu-link i {
    width: 16px;
    margin-right: 10px;
    font-size: 0.8rem;
}

/* Notificaciones */
.admin-sidebar .notification-badge {
    position: absolute;
    top: 8px;
    right: 30px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s infinite;
    z-index: 10;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
}

/* Ajustar el contenido principal - REMOVIDO para evitar desplazamiento */
/* El contenido principal ya no tendr√° margin-left autom√°tico */

/* Responsive */
@media (max-width: 768px) {
    .admin-sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
    }
    
    .admin-sidebar.show {
        transform: translateX(0);
    }
    
    .admin-sidebar .submenu-link {
        padding: 8px 15px 8px 35px;
        font-size: 0.85rem;
    }
    
    .admin-sidebar .notification-badge {
        right: 25px;
        width: 16px;
        height: 16px;
        font-size: 9px;
    }
}

/* Bot√≥n para toggle en m√≥vil */
.sidebar-toggle {
    display: none;
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1001;
    background: #2ecc71;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 1.2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

@media (max-width: 768px) {
    .sidebar-toggle {
        display: block;
    }
}

/* Overlay para m√≥vil */
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
}

@media (max-width: 768px) {
    .sidebar-overlay.show {
        display: block;
    }
}
</style>

<!-- Bot√≥n toggle para m√≥vil -->
<button class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- Overlay para m√≥vil -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- Script optimizado -->
<script>
// Toggle sidebar en m√≥vil
function toggleSidebar() {
    const sidebar = document.querySelector('.admin-sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    
    if (sidebar && overlay) {
        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Verificar que Bootstrap est√© cargado
    if (typeof bootstrap === 'undefined') {
        console.warn('Bootstrap no est√° cargado, usando funcionalidad b√°sica');
        initBasicCollapse();
        return;
    }
    
    initBootstrapCollapse();
});

function initBootstrapCollapse() {
    // Inicializar componentes collapse de Bootstrap
    const collapseElements = document.querySelectorAll('.admin-sidebar .collapse');
    collapseElements.forEach(function(element) {
        const existingInstance = bootstrap.Collapse.getInstance(element);
        if (existingInstance) {
            existingInstance.dispose();
        }
        
        new bootstrap.Collapse(element, {
            toggle: false
        });
    });
    
    // Manejar clicks en dropdowns
    const dropdownToggles = document.querySelectorAll('.admin-sidebar [data-bs-toggle="collapse"]');
    dropdownToggles.forEach(function(toggle) {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const targetSelector = this.getAttribute('data-bs-target');
            const target = document.querySelector(targetSelector);
            const arrow = this.querySelector('.dropdown-arrow');
            
            if (!target) return;
            
            const collapseInstance = bootstrap.Collapse.getInstance(target);
            if (!collapseInstance) return;
            
            // Cerrar otros men√∫s
            closeOtherMenus(target);
            
            // Toggle men√∫ actual
            if (target.classList.contains('show')) {
                collapseInstance.hide();
                this.setAttribute('aria-expanded', 'false');
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            } else {
                collapseInstance.show();
                this.setAttribute('aria-expanded', 'true');
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            }
        });
    });
}

function initBasicCollapse() {
    // Funcionalidad b√°sica sin Bootstrap
    const dropdownToggles = document.querySelectorAll('.admin-sidebar [data-bs-toggle="collapse"]');
    dropdownToggles.forEach(function(toggle) {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const targetSelector = this.getAttribute('data-bs-target');
            const target = document.querySelector(targetSelector);
            const arrow = this.querySelector('.dropdown-arrow');
            
            if (!target) return;
            
            // Cerrar otros men√∫s
            closeOtherMenus(target);
            
            // Toggle men√∫ actual
            if (target.classList.contains('show')) {
                target.classList.remove('show');
                this.setAttribute('aria-expanded', 'false');
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            } else {
                target.classList.add('show');
                this.setAttribute('aria-expanded', 'true');
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            }
        });
    });
}

function closeOtherMenus(currentTarget) {
    const otherCollapses = document.querySelectorAll('.admin-sidebar .collapse.show');
    otherCollapses.forEach(function(otherCollapse) {
        if (otherCollapse !== currentTarget) {
            otherCollapse.classList.remove('show');
            const otherToggle = document.querySelector(`[data-bs-target="#${otherCollapse.id}"]`);
            if (otherToggle) {
                otherToggle.setAttribute('aria-expanded', 'false');
                const otherArrow = otherToggle.querySelector('.dropdown-arrow');
                if (otherArrow) {
                    otherArrow.style.transform = 'rotate(0deg)';
                }
            }
        }
    });
}

// Cerrar sidebar en m√≥vil al hacer click en un enlace
document.addEventListener('click', function(e) {
    if (e.target.closest('.admin-sidebar .nav-link:not(.dropdown-toggle)')) {
        if (window.innerWidth <= 768) {
            toggleSidebar();
        }
    }
});
</script>