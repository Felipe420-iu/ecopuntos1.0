{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Canjes | Eco Puntos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Toastr CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            padding: 0;
            {% if user.role == 'conductor' %}
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            {% endif %}
        }
        /* Eliminar estilos de fondo de imagen */
        body::before {
            display: none;
        }
        .container, .table-container {
            position: relative;
            z-index: 1;
        }
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            {% if user.role == 'conductor' %}
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            {% else %}
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            {% endif %}
            margin-bottom: 30px;
        }
        {% if user.role == 'conductor' %}
        .custom-table thead {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .custom-table thead th {
            border: none;
            padding: 15px;
            font-weight: 600;
        }
        h1, h2, h3 {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .badge.bg-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
        }
        .badge.bg-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }
        {% else %}
        .custom-table th {
            background: #f8f9fa;
            padding: 15px;
            font-weight: 600;
        }
        {% endif %}
        .custom-table td {
            padding: 15px;
            vertical-align: middle;
        }
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        /* Efecto visual para filas actualizadas */
        .table-success {
            background-color: rgba(40, 167, 69, 0.1) !important;
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <!-- Barra de navegación superior -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary" style="margin-bottom:0;">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% if user.role == 'conductor' %}{% url 'panel_conductor' %}{% else %}{% url 'paneladmin' %}{% endif %}">
                <i class="fas fa-leaf me-2"></i>Eco Puntos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarAdmin">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarAdmin">
                <ul class="navbar-nav me-auto">
                    {% if user.role != 'conductor' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'usuarioadmin' %}">
                            <i class="fas fa-users me-1"></i>Usuarios
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'canjeadmin' %}">
                            <i class="fas fa-exchange-alt me-1"></i>Canjes
                        </a>
                    </li>
                    {% if user.role != 'conductor' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'retiroadmin' %}">
                            <i class="fas fa-chart-bar me-1"></i>Retiros 
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'estadisticasadmin' %}">
                            <i class="fas fa-chart-bar me-1"></i>Estadísticas
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'rutas' %}">
                            <i class="fas fa-route me-1"></i>Rutas 
                        </a>
                    </li>
                    {% if user.role != 'conductor' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'stock_recompensas' %}">
                            <i class="fas fa-boxes me-1"></i>Stock
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'monitor_sesiones' %}">
                            <i class="fas fa-desktop me-1"></i>Monitor de Sesiones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'listar_solicitudes_soporte' %}">
                            <i class="fas fa-headset me-1"></i>Solicitudes Soporte
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <div class="d-flex">
                    <a href="{% if user.role == 'conductor' %}{% url 'panel_conductor' %}{% else %}{% url 'paneladmin' %}{% endif %}" class="btn btn-outline-light me-2">
                        <i class="fas fa-arrow-left me-1"></i>Volver
                    </a>
                    <a href="{% url 'logout' %}" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesión
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Scripts necesarios -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <div class="container">
        <!-- Canjes Pendientes -->
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>Canjes Pendientes
                    <span class="badge bg-warning text-dark ms-2">{{ pending_exchanges|length }}</span>
                </h5>
            </div>
            <div class="table-responsive">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Material</th>
                            <th>Peso (kg)</th>
                            <th>Puntos</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Comprobante</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exchange in pending_exchanges %}
                        <tr>
                            <td>#{{ exchange.id }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm me-2">
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 32px; height: 32px; font-size: 12px; color: white;">
                                            {{ exchange.usuario.username|first|upper }}
                                        </div>
                                    </div>
                                    {{ exchange.usuario.username }}
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-recycle me-1"></i>{{ exchange.material.nombre }}
                                </span>
                            </td>
                            <td class="canje-peso">{{ exchange.peso }}</td>
                            <td class="canje-puntos">
                                <span class="fw-bold text-success">{{ exchange.puntos }}</span>
                            </td>
                            <td class="canje-estado">
                                <span class="status-badge bg-warning text-dark">
                                    <i class="fas fa-clock me-1"></i>Pendiente
                                </span>
                            </td>
                            <td>{{ exchange.fecha_solicitud|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if exchange.comprobante %}
                                    <a href="{{ exchange.comprobante.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-file-image"></i> Ver
                                    </a>
                                {% else %}
                                    <span class="text-muted">Sin comprobante</span>
                                {% endif %}
                            </td>
                            <td class="canje-acciones">
                                <button type="button" class="btn btn-success btn-sm approve-btn" 
                                        data-bs-toggle="modal"
                                        data-bs-target="#pesoModal"
                                        data-id="{{ exchange.id }}"
                                        data-material="{{ exchange.material.nombre }}"
                                        data-usuario="{{ exchange.usuario.username }}"
                                        data-peso-actual="{{ exchange.peso }}"
                                        data-puntos-por-kilo="{{ exchange.material.puntos_por_kilo }}">
                                    <i class="fas fa-balance-scale"></i> Pesar y Aprobar
                                </button>
                                <button type="button" class="btn btn-danger btn-sm action-btn" 
                                        data-id="{{ exchange.id }}" 
                                        data-action="rechazar">
                                    <i class="fas fa-times"></i> Rechazar
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                No hay canjes pendientes para mostrar.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Historial de Canjes Procesados -->
        <div class="table-container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historial de Canjes Procesados</h5>
                <div class="d-flex gap-3">
                    <!-- Filtro por estado -->
                    <select id="statusFilter" class="form-select" style="width: auto;">
                        <option value="">Todos los estados</option>
                        <option value="aprobado">Aprobados</option>
                        <option value="rechazado">Rechazados</option>
                    </select>
                    <!-- Buscador -->
                    <div class="input-group" style="width: 300px;">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchHistory" class="form-control" placeholder="Buscar por usuario, material o ID...">
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table custom-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>ID Canje</th>
                            <th>Usuario</th>
                            <th>Material</th>
                            <th>Peso (kg)</th>
                            <th>Puntos</th>
                            <th>Estado</th>
                            <th>Fecha Solicitud</th>
                            <th>Fecha Procesado</th>
                            <th>Comprobante</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        {% for exchange in processed_exchanges %}
                        <tr class="history-row" data-status="{{ exchange.estado }}" data-search="{{ exchange.usuario.username|lower }} {{ exchange.material.nombre|lower }} {{ exchange.id }}">
                            <td>{{ exchange.id }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm me-2">
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 12px; color: white;">
                                            {{ exchange.usuario.username|first|upper }}
                                        </div>
                                    </div>
                                    {{ exchange.usuario.username }}
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-recycle me-1"></i>{{ exchange.material.nombre }}
                                </span>
                            </td>
                            <td>{{ exchange.peso }}</td>
                            <td>
                                <span class="fw-bold text-success">{{ exchange.puntos }}</span>
                            </td>
                            <td>
                                <span class="status-badge {% if exchange.estado == 'aprobado' %}bg-success{% else %}bg-danger{% endif %}">
                                    {% if exchange.estado == 'aprobado' %}
                                        <i class="fas fa-check me-1"></i>Aprobado
                                    {% else %}
                                        <i class="fas fa-times me-1"></i>Rechazado
                                    {% endif %}
                                </span>
                            </td>
                            <td>{{ exchange.fecha_solicitud|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if exchange.fecha_procesamiento %}
                                    {{ exchange.fecha_procesamiento|date:"d/m/Y H:i" }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if exchange.comprobante %}
                                    <a href="{{ exchange.comprobante.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-file-image"></i>
                                    </a>
                                {% else %}
                                    <span class="text-muted">Sin comprobante</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="noHistoryRow">
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                No hay canjes procesados para mostrar.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación del historial -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted">
                    <small>Mostrando <span id="showingCount">{{ processed_exchanges|length }}</span> de <span id="totalCount">{{ processed_exchanges|length }}</span> registros</small>
                </div>
                <nav aria-label="Paginación del historial">
                    <ul class="pagination pagination-sm mb-0" id="historyPagination">
                        <!-- La paginación se generará dinámicamente con JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Modal para ingresar peso -->
    <div class="modal fade" id="pesoModal" tabindex="-1" aria-labelledby="pesoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="pesoModalLabel">
                        <i class="fas fa-balance-scale me-2"></i>Ingresar Peso Real
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Detalles del Canje -->
                    <div class="mb-4">
                        <h6><strong>Detalles del Canje:</strong></h6>
                        <div class="row">
                            <div class="col-sm-6">
                                <p class="mb-1"><strong>Usuario:</strong> <span id="modalUsuario"></span></p>
                                <p class="mb-1"><strong>Material:</strong> <span id="modalMaterial"></span></p>
                            </div>
                            <div class="col-sm-6">
                                <p class="mb-1"><strong>Peso estimado por usuario:</strong> <span id="modalPesoEstimado"></span> kg</p>
                                <p class="mb-1"><strong>Puntos por kg:</strong> <span id="modalPuntosPorKilo"></span></p>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-2">
                            <small><i class="fas fa-exclamation-triangle me-1"></i><strong>Importante:</strong> El usuario proporcionó un peso estimado. Ingresa el peso real después de verificar el material físicamente.</small>
                        </div>
                    </div>
                    
                    <form id="pesoForm">
                        <div class="mb-3">
                            <label for="pesoReal" class="form-label"><strong>Peso Real (kg):</strong></label>
                            <div class="input-group">
                                <button class="btn btn-outline-secondary" type="button" id="decrementPeso">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" class="form-control text-center" id="pesoReal" step="0.1" min="0.1" max="100" placeholder="0.0">
                                <button class="btn btn-outline-secondary" type="button" id="incrementPeso">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <span class="input-group-text">kg</span>
                            </div>
                            <div class="form-text">Use los botones +/- o escriba directamente el peso</div>
                        </div>
                        
                        <div class="alert alert-info">
                            <h6 class="mb-2"><strong>Cálculo de Puntos:</strong></h6>
                            <div class="d-flex justify-content-between">
                                <span>Peso × Puntos por kg:</span>
                                <strong><span id="puntosCalculados">0</span> puntos</strong>
                            </div>
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-success" id="confirmarAprobacion">
                        <i class="fas fa-check me-1"></i>Aprobar con Peso Real
                    </button>
                </div>
            </div>
        </div>
    </div>
        
        <script>
// Filtro de historial de canjes procesados
$(document).ready(function() {
    function filtrarHistorial() {
        var estado = $('#statusFilter').val();
        var busqueda = $('#searchHistory').val().toLowerCase();
        var total = 0;
        $('#historyTableBody .history-row').each(function() {
            var fila = $(this);
            var filaEstado = fila.data('status');
            var filaBusqueda = fila.data('search');
            var visible = true;
            if (estado && filaEstado !== estado) visible = false;
            if (busqueda && filaBusqueda.indexOf(busqueda) === -1) visible = false;
            fila.toggle(visible);
            if (visible) total++;
        });
        $('#showingCount').text(total);
        // Si no hay resultados, mostrar fila vacía
        if (total === 0) {
            if ($('#noHistoryRow').length === 0) {
                $('#historyTableBody').append(`
                    <tr id="noHistoryRow">
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                            No hay canjes procesados para mostrar.
                        </td>
                    </tr>
                `);
            }
        } else {
            $('#noHistoryRow').remove();
        }
    }

    $('#statusFilter').on('change', filtrarHistorial);
    $('#searchHistory').on('input', filtrarHistorial);
    // Inicializar filtro al cargar
    filtrarHistorial();
});
            $(document).ready(function() {
                console.log('JavaScript cargado correctamente');
                console.log('jQuery:', $.fn.jquery);
                console.log('Bootstrap:', typeof $.fn.modal !== 'undefined');
                console.log('Toastr:', typeof toastr !== 'undefined');
            });

            // Variables globales
            let currentCanjeId;
            let currentPuntosPorKilo;
            
            // Configuración de toastr
            toastr.options = {
                closeButton: true,
                progressBar: true,
                positionClass: "toast-top-right",
                timeOut: 3000
            };

            // Función para obtener cookie CSRF
            function getCookie(name) {
                const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (tokenInput && name === 'csrftoken') {
                    return tokenInput.value;
                }
                
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            // Función para calcular puntos
            function calcularPuntos() {
                const peso = parseFloat($('#pesoReal').val()) || 0;
                const puntos = Math.round(peso * (currentPuntosPorKilo || 0));
                
                console.log('Calculando puntos:', {
                    peso: peso,
                    puntosPorKilo: currentPuntosPorKilo,
                    puntosCalculados: puntos
                });
                
                $('#puntosCalculados').text(puntos);
            }
            
            // Manejar apertura del modal
            $(document).on('show.bs.modal', '#pesoModal', function (event) {
                const button = $(event.relatedTarget);
                
                console.log('Abriendo modal para canje:', button.data());
                
                currentCanjeId = button.data('id');
                const material = button.data('material');
                const usuario = button.data('usuario');
                const pesoActual = button.data('peso-actual');
                currentPuntosPorKilo = parseFloat(button.data('puntos-por-kilo'));
                
                if (!currentCanjeId || !currentPuntosPorKilo) {
                    console.error('Datos faltantes:', { currentCanjeId, currentPuntosPorKilo });
                    toastr.error('Error: Datos del canje incompletos');
                    return;
                }
                
                // Llenar datos del modal
                $('#modalUsuario').text(usuario || 'No disponible');
                $('#modalMaterial').text(material || 'No disponible');
                $('#modalPesoEstimado').text(pesoActual || '0');
                $('#modalPuntosPorKilo').text(currentPuntosPorKilo || '0');
                $('#pesoReal').val(pesoActual || '1.0');
                
                // Calcular puntos iniciales
                setTimeout(calcularPuntos, 100);
            });
            
            // Vincular eventos cuando el modal esté completamente cargado
            $(document).on('shown.bs.modal', '#pesoModal', function () {
                console.log('Modal completamente cargado');
                
                // Limpiar eventos anteriores y vincular nuevos
                $('#pesoReal').off('input').on('input', function() {
                    console.log('Peso cambiado a:', $(this).val());
                    calcularPuntos();
                });
                
                $('#incrementPeso').off('click').on('click', function() {
                    console.log('Incrementando peso');
                    let peso = parseFloat($('#pesoReal').val()) || 0;
                    peso = Math.min(peso + 0.1, 100);
                    $('#pesoReal').val(peso.toFixed(1));
                    calcularPuntos();
                });
                
                $('#decrementPeso').off('click').on('click', function() {
                    console.log('Decrementando peso');
                    let peso = parseFloat($('#pesoReal').val()) || 0;
                    peso = Math.max(peso - 0.1, 0.1);
                    $('#pesoReal').val(peso.toFixed(1));
                    calcularPuntos();
                });
                
                console.log('Eventos de botones vinculados');
            });
            
            // Manejar confirmación de aprobación
            $(document).on('click', '#confirmarAprobacion', function() {
                const pesoReal = parseFloat($('#pesoReal').val());
                const puntosCalculados = Math.round(pesoReal * currentPuntosPorKilo);

                if (!pesoReal || pesoReal < 0.1) {
                    toastr.error('Por favor ingrese un peso válido (mínimo 0.1 kg)');
                    return;
                }

                const btn = $(this);
                btn.prop('disabled', true);
                btn.html('<i class="fas fa-spinner fa-spin"></i> Procesando...');

                $.ajax({
                    url: `/api/v1/canjes/${currentCanjeId}/aprobar/`,
                    type: 'POST',
                    data: {
                        peso_real: pesoReal,
                        puntos: puntosCalculados
                    },
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    success: function(response) {
                        $('#pesoModal').modal('hide');
                        toastr.success(`Canje aprobado con ${pesoReal} kg. Puntos otorgados: ${puntosCalculados}`);
                        // Actualizar la fila si existe
                        const row = $(`.approve-btn[data-id="${currentCanjeId}"]`).closest('tr');
                        if (row.length) {
                            updateRowWithNewData(row, pesoReal, puntosCalculados);
                        } else {
                            setTimeout(() => location.reload(), 1500);
                        }
                    },
                    error: function(xhr) {
                        toastr.error('Error al procesar el canje');
                    },
                    complete: function() {
                        btn.prop('disabled', false);
                        btn.html('<i class="fas fa-check me-1"></i>Aprobar con Peso Real');
                    }
                });
            });
            
            // Manejar botón rechazar
            $(document).on('click', '.action-btn[data-action="rechazar"]', function() {
                const canjeId = $(this).data('id');
                
                console.log('Rechazando canje:', canjeId);
                
                if (confirm('¿Estás seguro de que deseas rechazar este canje?')) {
                    $.ajax({
                        url: `/api/v1/canjes/${canjeId}/rechazar/`,
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        success: function(response) {
                            console.log('Rechazo exitoso:', response);
                            toastr.warning('Canje rechazado');
                            setTimeout(() => location.reload(), 1500);
                        },
                        error: function(xhr) {
                            console.error('Error al rechazar:', xhr);
                            toastr.error('Error al rechazar el canje');
                        }
                    });
                }
            });
            
            // Función para cerrar sesión
            function cerrarSesionAdmin() {
                if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                    fetch('/logout/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin'
                    }).then(response => {
                        if (response.ok) {
                            window.location.href = '/login/';
                        } else {
                            alert('Error al cerrar sesión');
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                        alert('Error al cerrar sesión');
                    });
                }
            }
        </script>
</body>
</html>