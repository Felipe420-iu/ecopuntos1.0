{% extends 'core/base.html' %}
{% load static %}

{% block title %}üèúÔ∏è Desert Crystal Hunter | Eco Puntos{% endblock %}

{% block extra_css %}
<style>
    :root {
        --desert-sand: #F4E4BC;
        --desert-gold: #D4AF37;
        --desert-orange: #FF8C42;
        --crystal-blue: #4FC3F7;
        --crystal-purple: #AB47BC;
        --oasis-blue: #26C6DA;
        --cactus-green: #66BB6A;
        --explorer-brown: #8D6E63;
        --energy-yellow: #FFF176;
        --heat-red: #FF7043;
    }

    .game-container {
        width: 100%;
        max-width: 1000px;
        height: 600px;
        margin: 20px auto;
        background: linear-gradient(180deg, 
            #87CEEB 0%,      /* Cielo azul */
            #FFE4B5 20%,     /* Horizonte */
            #DEB887 40%,     /* Arena clara */
            #D2B48C 60%,     /* Arena media */
            #CD853F 80%,     /* Arena oscura */
            #A0522D 100%    /* Arena profunda */
        );
        border-radius: 15px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 3px solid #D4AF37;
        background-image: 
            /* Sol en el horizonte */
            radial-gradient(circle 60px at 85% 25%, #FFD700 30%, rgba(255, 215, 0, 0.3) 50%, transparent 70%),
            /* Monta√±as lejanas */
            linear-gradient(180deg, transparent 15%, rgba(139, 69, 19, 0.3) 20%, rgba(160, 82, 45, 0.4) 25%, transparent 30%),
            /* Textura de arena */
            radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.3) 1px, transparent 1px),
            radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.2) 1px, transparent 1px),
            radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.1) 2px, transparent 2px);
        background-size: 100% 100%, 100% 100%, 100px 100px, 150px 150px, 200px 200px;
    }
    
    /* Efecto de calor del sol */
    .game-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(ellipse 200px 100px at 85% 25%, rgba(255, 215, 0, 0.2) 0%, transparent 70%);
        animation: sun-shimmer 6s ease-in-out infinite;
        pointer-events: none;
    }
    
    @keyframes sun-shimmer {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.7; }
    }

    /* Header del juego */
    .game-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.9), rgba(244, 228, 188, 0.9));
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        z-index: 100;
        border-bottom: 2px solid var(--desert-gold);
    }

    .game-title {
        font-size: 24px;
        font-weight: bold;
        color: var(--explorer-brown);
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .stats-panel {
        display: flex;
        gap: 20px;
        color: var(--explorer-brown);
        font-weight: bold;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 14px;
    }

    .stat-value {
        font-size: 18px;
        margin-top: 2px;
    }

    /* Arena del desierto */
    .desert-arena {
        position: absolute;
        top: 80px;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        cursor: none;
        background-image: 
            /* Dunas de arena */
            radial-gradient(ellipse 300px 100px at 20% 80%, rgba(218, 165, 32, 0.3) 40%, transparent 70%),
            radial-gradient(ellipse 400px 80px at 70% 90%, rgba(210, 180, 140, 0.4) 40%, transparent 70%),
            radial-gradient(ellipse 250px 60px at 50% 85%, rgba(222, 184, 135, 0.3) 40%, transparent 70%),
            /* Textura de arena */
            repeating-linear-gradient(45deg, transparent, transparent 1px, rgba(255,255,255,0.1) 1px, rgba(255,255,255,0.1) 2px);
        background-size: 100% 100%, 100% 100%, 100% 100%, 20px 20px;
    }
    
    /* Efectos de dunas animadas */
    .desert-arena::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(ellipse 200px 50px at 30% 70%, rgba(255, 228, 181, 0.5) 40%, transparent 70%),
            radial-gradient(ellipse 350px 70px at 80% 60%, rgba(245, 222, 179, 0.4) 40%, transparent 70%);
        animation: dune-shift 20s ease-in-out infinite;
        pointer-events: none;
    }
    
    @keyframes dune-shift {
        0%, 100% { transform: translateX(0px); }
        50% { transform: translateX(10px); }
    }

    /* Explorador */
    .explorer {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--explorer-brown), #5D4037);
        border-radius: 50%;
        position: absolute;
        border: 3px solid #3E2723;
        box-shadow: 0 0 15px rgba(141, 110, 99, 0.7);
        z-index: 50;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .explorer.digging {
        animation: dig-shake 0.5s ease-in-out;
    }

    @keyframes dig-shake {
        0%, 100% { transform: scale(1) rotate(0deg); }
        25% { transform: scale(1.1) rotate(-2deg); }
        75% { transform: scale(1.1) rotate(2deg); }
    }

    /* Cristales */
    .crystal {
        width: 35px;
        height: 35px;
        position: absolute;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        z-index: 10;
        animation: crystal-shine 3s ease-in-out infinite;
        box-shadow: 0 0 20px currentColor;
        cursor: pointer;
    }

    .crystal.glass {
        background: linear-gradient(135deg, var(--crystal-blue), #1976D2);
        color: white;
        border: 2px solid #0D47A1;
    }

    .crystal.toxic {
        background: linear-gradient(135deg, var(--crystal-purple), #7B1FA2);
        color: white;
        border: 2px solid #4A148C;
    }

    @keyframes crystal-shine {
        0%, 100% { 
            transform: scale(1);
            box-shadow: 0 0 20px currentColor;
        }
        50% { 
            transform: scale(1.1);
            box-shadow: 0 0 30px currentColor;
        }
    }

    .crystal.excavating {
        animation: crystal-excavate 0.5s ease-out;
    }

    @keyframes crystal-excavate {
        0% { transform: scale(1) rotate(0deg); }
        50% { transform: scale(1.3) rotate(180deg); }
        100% { transform: scale(0) rotate(360deg); }
    }

    /* Detector de cristales */
    .detector-pulse {
        position: absolute;
        border: 3px solid var(--crystal-blue);
        border-radius: 50%;
        background: rgba(79, 195, 247, 0.1);
        pointer-events: none;
        z-index: 5;
        animation: detector-scan 2s ease-in-out infinite;
    }

    @keyframes detector-scan {
        0% {
            transform: scale(0.5);
            opacity: 0.8;
        }
        100% {
            transform: scale(3);
            opacity: 0;
        }
    }

    /* Obst√°culos del desierto */
    .cactus {
        position: absolute;
        font-size: 30px;
        z-index: 15;
        filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
    }

    .oasis {
        position: absolute;
        width: 60px;
        height: 60px;
        background: radial-gradient(circle, var(--oasis-blue), #0097A7);
        border-radius: 50%;
        border: 3px solid #006064;
        z-index: 10;
        animation: oasis-ripple 2s ease-in-out infinite;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    @keyframes oasis-ripple {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    /* Barras de estado */
    .status-bars {
        position: absolute;
        top: 100px;
        left: 20px;
        z-index: 60;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .status-bar {
        width: 150px;
        height: 20px;
        background: rgba(0,0,0,0.3);
        border-radius: 10px;
        overflow: hidden;
        border: 2px solid #333;
    }

    .energy-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--energy-yellow), #FBC02D);
        transition: width 0.3s ease;
        border-radius: 8px;
    }

    .thirst-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--oasis-blue), #0277BD);
        transition: width 0.3s ease;
        border-radius: 8px;
    }

    .bar-label {
        color: white;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 3px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }

    /* Part√≠culas de arena mejoradas */
    .sand-particle {
        position: absolute;
        border-radius: 50%;
        pointer-events: none;
        z-index: 1;
        opacity: 0.8;
    }
    
    .sand-particle.small {
        width: 2px;
        height: 2px;
        background: #F5DEB3;
        animation: sand-drift-small 12s linear infinite;
    }
    
    .sand-particle.medium {
        width: 3px;
        height: 3px;
        background: #DEB887;
        animation: sand-drift-medium 10s linear infinite;
    }
    
    .sand-particle.large {
        width: 4px;
        height: 4px;
        background: #D2B48C;
        animation: sand-drift-large 8s linear infinite;
    }

    @keyframes sand-drift-small {
        0% {
            transform: translateX(-50px) translateY(0px) rotate(0deg);
            opacity: 0;
        }
        10% { opacity: 0.6; }
        90% { opacity: 0.4; }
        100% {
            transform: translateX(1050px) translateY(-30px) rotate(360deg);
            opacity: 0;
        }
    }
    
    @keyframes sand-drift-medium {
        0% {
            transform: translateX(-50px) translateY(0px) rotate(0deg);
            opacity: 0;
        }
        10% { opacity: 0.7; }
        90% { opacity: 0.5; }
        100% {
            transform: translateX(1050px) translateY(-20px) rotate(270deg);
            opacity: 0;
        }
    }
    
    @keyframes sand-drift-large {
        0% {
            transform: translateX(-50px) translateY(0px) rotate(0deg);
            opacity: 0;
        }
        10% { opacity: 0.8; }
        90% { opacity: 0.6; }
        100% {
            transform: translateX(1050px) translateY(-10px) rotate(180deg);
            opacity: 0;
        }
    }

    /* Efectos de calor */
    .heat-wave {
        position: absolute;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, 
            transparent 0%, 
            rgba(255, 112, 67, 0.1) 25%, 
            transparent 50%, 
            rgba(255, 112, 67, 0.1) 75%, 
            transparent 100%);
        animation: heat-distortion 4s ease-in-out infinite;
        pointer-events: none;
        z-index: 2;
    }

    @keyframes heat-distortion {
        0%, 100% { 
            transform: skewY(0deg);
            opacity: 0.3;
        }
        50% { 
            transform: skewY(0.5deg);
            opacity: 0.6;
        }
    }

    /* Controles */
    .controls-panel {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: rgba(141, 110, 99, 0.9);
        padding: 15px;
        border-radius: 10px;
        color: white;
        font-size: 14px;
        backdrop-filter: blur(10px);
        border: 2px solid var(--explorer-brown);
    }

    .controls-title {
        font-weight: bold;
        margin-bottom: 8px;
        color: var(--energy-yellow);
    }

    /* Floating text para puntos */
    @keyframes float-up {
        0% {
            transform: translateY(0);
            opacity: 1;
        }
        100% {
            transform: translateY(-50px);
            opacity: 0;
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .game-container {
            height: 500px;
            margin: 10px;
        }
        
        .game-title {
            font-size: 18px;
        }
        
        .stats-panel {
            gap: 10px;
        }
        
        .controls-panel {
            font-size: 12px;
            padding: 10px;
        }
        
        .status-bars {
            top: 90px;
            left: 10px;
        }
        
        .status-bar {
            width: 120px;
            height: 18px;
        }
    }

    /* Notificaciones */
    .notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--desert-gold), var(--desert-orange));
        color: white;
        padding: 15px 25px;
        border-radius: 25px;
        font-weight: bold;
        z-index: 1000;
        opacity: 0;
        transition: all 0.3s ease;
        border: 2px solid var(--explorer-brown);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .notification.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    .notification.success {
        background: linear-gradient(135deg, var(--crystal-blue), var(--oasis-blue));
    }

    .notification.warning {
        background: linear-gradient(135deg, var(--energy-yellow), var(--desert-orange));
    }

    .notification.error {
        background: linear-gradient(135deg, var(--heat-red), #D32F2F);
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container" id="game-container">
    <!-- Header del juego -->
    <div class="game-header">
        <div class="game-title">üèúÔ∏è DESERT CRYSTAL HUNTER</div>
        <div class="stats-panel">
            <div class="stat-item">
                <span>üíé CRISTALES</span>
                <span class="stat-value" id="crystals-count">0</span>
            </div>
            <div class="stat-item">
                <span>üèÜ PUNTUACI√ìN</span>
                <span class="stat-value" id="score">0</span>
            </div>
            <div class="stat-item">
                <span>üìä NIVEL</span>
                <span class="stat-value" id="level">1</span>
            </div>
            <div class="stat-item">
                <span>‚≠ê COMBO</span>
                <span class="stat-value" id="combo">0</span>
            </div>
        </div>
    </div>

    <!-- Arena del desierto -->
    <div class="desert-arena" id="desert-arena">
        <!-- Efectos ambientales -->
        <div class="heat-wave"></div>
        
        <!-- Barras de estado -->
        <div class="status-bars">
            <div>
                <div class="bar-label">‚ö° ENERG√çA</div>
                <div class="status-bar">
                    <div class="energy-bar" id="energy-bar" style="width: 100%;"></div>
                </div>
            </div>
            <div>
                <div class="bar-label">üíß HIDRATACI√ìN</div>
                <div class="status-bar">
                    <div class="thirst-bar" id="thirst-bar" style="width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- El explorador y elementos aparecer√°n aqu√≠ din√°micamente -->
    </div>

    <!-- Panel de controles -->
    <div class="controls-panel">
        <div class="controls-title">üéÆ CONTROLES</div>
        <div>
            ‚¨ÖÔ∏è‚û°Ô∏è‚¨ÜÔ∏è‚¨áÔ∏è Flechas: Mover explorador<br>
            üîç SPACE: Activar detector de cristales<br>
            ‚õèÔ∏è ENTER: Excavar cristal cercano<br>
            üíß Toca oasis para hidratarte
        </div>
    </div>
</div>

<!-- Notificaci√≥n -->
<div id="notification" class="notification"></div>

<!-- Modal de Game Over -->
<div class="modal fade" id="gameOverModal" tabindex="-1" aria-labelledby="gameOverModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: linear-gradient(135deg, #8D6E63 0%, #A0522D 100%); border: 3px solid #D4AF37; box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);">
            <div class="modal-header" style="border-bottom: 2px solid #D4AF37;">
                <h5 class="modal-title" id="gameOverModalLabel" style="color: #FFD700; font-family: 'Orbitron', sans-serif; font-weight: bold;">
                    <i class="fas fa-trophy me-2"></i>¬°Expedici√≥n Terminada!
                </h5>
            </div>
            <div class="modal-body text-center" style="color: #fff; font-family: 'Poppins', sans-serif; padding: 30px;">
                <div class="mb-4">
                    <i class="fas fa-gem" style="font-size: 4rem; color: #4FC3F7;"></i>
                </div>
                
                <div style="background: rgba(212, 175, 55, 0.2); border-radius: 15px; padding: 20px; margin: 20px 0;">
                    <h6 style="color: #FFD700; margin-bottom: 15px;">üìä Estad√≠sticas Finales</h6>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left;">
                        <div>
                            <strong style="color: #D4AF37;">Puntuaci√≥n:</strong>
                            <div id="finalScore" style="font-size: 1.5rem; color: #FFD700;">0</div>
                        </div>
                        <div>
                            <strong style="color: #D4AF37;">Nivel:</strong>
                            <div id="finalLevel" style="font-size: 1.5rem; color: #FFD700;">1</div>
                        </div>
                        <div>
                            <strong style="color: #D4AF37;">Cristales:</strong>
                            <div id="finalCrystals" style="font-size: 1.5rem; color: #4FC3F7;">0</div>
                        </div>
                        <div>
                            <strong style="color: #D4AF37;">R√©cord:</strong>
                            <div id="finalHighscore" style="font-size: 1.5rem; color: #FFD700;">0</div>
                        </div>
                    </div>
                </div>

                <p style="color: #D4AF37; margin-top: 15px;">¬øQuieres explorar de nuevo?</p>
            </div>
            <div class="modal-footer" style="border-top: 2px solid #D4AF37; justify-content: center;">
                <button type="button" class="btn btn-success" id="btnAcceptRestart" style="background: linear-gradient(135deg, #66BB6A, #4CAF50); border: none; padding: 10px 30px; font-weight: bold;">
                    <i class="fas fa-redo me-2"></i>Aceptar
                </button>
                <button type="button" class="btn btn-secondary" id="btnCancelRestart" style="background: linear-gradient(135deg, #FF7043, #D84315); border: none; padding: 10px 30px; font-weight: bold;">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Estado del juego Desert Crystal Hunter
let gameState = {
    score: 0,
    level: 1,
    combo: 0,
    crystalsCollected: 0,
    explorer: {
        x: 500,
        y: 300,
        energy: 100,
        thirst: 100,
        speed: 3
    },
    crystals: [],
    obstacles: [], // cactus
    oases: [],
    maxCrystals: 6,
    gameRunning: false,
    keys: {},
    detectorActive: false,
    detectorCooldown: 0,
    gameLoop: null,
    environmentLoop: null
};

const crystalTypes = [
    {icon: 'üíé', type: 'glass', points: 15, name: 'Cristal de Vidrio', rarity: 0.7},
    {icon: 'üîÆ', type: 'toxic', points: 25, name: 'Cristal T√≥xico', rarity: 0.3},
    {icon: 'üí†', type: 'glass', points: 12, name: 'Fragmento Azul', rarity: 0.8},
    {icon: 'üåü', type: 'toxic', points: 30, name: 'Cristal Radiante', rarity: 0.2}
];

// Inicializar juego
function initDesertGame() {
    console.log('üèúÔ∏è Iniciando Desert Crystal Hunter...');
    const desertArena = document.getElementById('desert-arena');
    
    if (!desertArena) {
        console.error('‚ùå No se encontr√≥ desert-arena');
        return;
    }
    
    // Resetear estado del explorador al centro
    gameState.explorer.x = 500;
    gameState.explorer.y = 300;
    gameState.explorer.energy = 100;
    gameState.explorer.thirst = 100;
    
    // Limpiar arena (excepto elementos fijos)
    const elementsToKeep = desertArena.querySelectorAll('.heat-wave, .status-bars');
    desertArena.innerHTML = '';
    
    // Restaurar elementos fijos
    elementsToKeep.forEach(element => {
        desertArena.appendChild(element);
    });
    
    // Recrear elementos fijos si no existen
    if (!desertArena.querySelector('.heat-wave')) {
        const heatWave = document.createElement('div');
        heatWave.className = 'heat-wave';
        desertArena.appendChild(heatWave);
    }
    
    if (!desertArena.querySelector('.status-bars')) {
        const statusBars = createStatusBars();
        desertArena.appendChild(statusBars);
    }
    
    // Crear explorador
    createExplorer();
    
    // Generar ambiente del desierto
    generateDesertEnvironment();
    
    // Event listeners para controles
    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('keyup', handleKeyUp);
    
    // Iniciar bucles del juego
    startDesertGame();
    
    showNotification('üèúÔ∏è ¬°Explora el desierto y encuentra cristales contaminantes!', 'success');
}

// Crear barras de estado
function createStatusBars() {
    const statusBars = document.createElement('div');
    statusBars.className = 'status-bars';
    statusBars.innerHTML = `
        <div>
            <div class="bar-label">‚ö° ENERG√çA</div>
            <div class="status-bar">
                <div class="energy-bar" id="energy-bar" style="width: 100%;"></div>
            </div>
        </div>
        <div>
            <div class="bar-label">üíß HIDRATACI√ìN</div>
            <div class="status-bar">
                <div class="thirst-bar" id="thirst-bar" style="width: 100%;"></div>
            </div>
        </div>
    `;
    return statusBars;
}

// Crear explorador
function createExplorer() {
    const desertArena = document.getElementById('desert-arena');
    const explorer = document.createElement('div');
    explorer.className = 'explorer';
    explorer.id = 'explorer';
    explorer.textContent = 'üè∫';
    explorer.style.left = (gameState.explorer.x - 20) + 'px';
    explorer.style.top = (gameState.explorer.y - 20) + 'px';
    desertArena.appendChild(explorer);
    
    console.log('üè∫ Explorador creado en:', gameState.explorer);
}

// Generar ambiente del desierto
function generateDesertEnvironment() {
    generateCactuses();
    generateOases();
    generateCrystals();
    generateSandParticles();
}

// Generar cactus
function generateCactuses() {
    const desertArena = document.getElementById('desert-arena');
    const arenaWidth = 1000;
    const arenaHeight = 520;
    
    for (let i = 0; i < 8; i++) {
        const cactus = document.createElement('div');
        cactus.className = 'cactus';
        cactus.textContent = 'üåµ';
        
        const x = Math.random() * (arenaWidth - 60) + 30;
        const y = Math.random() * (arenaHeight - 60) + 30;
        
        cactus.style.left = x + 'px';
        cactus.style.top = y + 'px';
        
        desertArena.appendChild(cactus);
        gameState.obstacles.push({x, y, type: 'cactus', element: cactus});
    }
    console.log('üåµ Generados', gameState.obstacles.length, 'cactus');
}

// Generar oasis
function generateOases() {
    const desertArena = document.getElementById('desert-arena');
    const arenaWidth = 1000;
    const arenaHeight = 520;
    
    for (let i = 0; i < 3; i++) {
        const oasis = document.createElement('div');
        oasis.className = 'oasis';
        oasis.textContent = 'üíß';
        
        const x = Math.random() * (arenaWidth - 80) + 40;
        const y = Math.random() * (arenaHeight - 80) + 40;
        
        oasis.style.left = x + 'px';
        oasis.style.top = y + 'px';
        
        desertArena.appendChild(oasis);
        gameState.oases.push({x, y, element: oasis});
    }
    console.log('üíß Generados', gameState.oases.length, 'oasis');
}

// Generar cristales
function generateCrystals() {
    const desertArena = document.getElementById('desert-arena');
    const arenaWidth = 1000;
    const arenaHeight = 520;
    
    while (gameState.crystals.length < gameState.maxCrystals) {
        const crystalType = selectCrystalType();
        const crystalId = 'crystal-' + Date.now() + '-' + Math.random();
        
        const x = Math.random() * (arenaWidth - 60) + 30;
        const y = Math.random() * (arenaHeight - 60) + 30;
        
        // Verificar que no est√© muy cerca de obst√°culos
        if (isPositionValid(x, y)) {
            const crystal = {
                id: crystalId,
                x: x,
                y: y,
                icon: crystalType.icon,
                type: crystalType.type,
                points: crystalType.points,
                name: crystalType.name
            };
            
            // Crear elemento visual
            const crystalElement = document.createElement('div');
            crystalElement.className = `crystal ${crystalType.type}`;
            crystalElement.id = crystalId;
            crystalElement.textContent = crystalType.icon;
            crystalElement.style.left = x + 'px';
            crystalElement.style.top = y + 'px';
            
            desertArena.appendChild(crystalElement);
            gameState.crystals.push(crystal);
            
            console.log('üíé Cristal creado:', crystal);
        }
    }
    console.log('üíé Generados', gameState.crystals.length, 'cristales');
}

// Seleccionar tipo de cristal basado en rareza
function selectCrystalType() {
    const rand = Math.random();
    let accumulated = 0;
    
    for (let crystalType of crystalTypes) {
        accumulated += crystalType.rarity;
        if (rand <= accumulated) {
            return crystalType;
        }
    }
    
    return crystalTypes[0]; // fallback
}

// Verificar si la posici√≥n es v√°lida (no muy cerca de obst√°culos)
function isPositionValid(x, y) {
    for (let obstacle of gameState.obstacles) {
        const distance = Math.sqrt(Math.pow(x - obstacle.x, 2) + Math.pow(y - obstacle.y, 2));
        if (distance < 80) return false;
    }
    
    for (let oasis of gameState.oases) {
        const distance = Math.sqrt(Math.pow(x - oasis.x, 2) + Math.pow(y - oasis.y, 2));
        if (distance < 100) return false;
    }
    
    return true;
}

// Generar part√≠culas de arena mejoradas
function generateSandParticles() {
    const desertArena = document.getElementById('desert-arena');
    if (!desertArena) return;
    
    function createSandParticle() {
        const types = ['small', 'medium', 'large'];
        const type = types[Math.floor(Math.random() * types.length)];
        
        const particle = document.createElement('div');
        particle.className = `sand-particle ${type}`;
        particle.style.top = Math.random() * 400 + 'px';
        particle.style.left = '-10px';
        
        desertArena.appendChild(particle);
        
        // Remover part√≠cula despu√©s de la animaci√≥n
        const animationDuration = type === 'small' ? 12000 : type === 'medium' ? 10000 : 8000;
        setTimeout(() => {
            if (particle && particle.parentNode) {
                particle.parentNode.removeChild(particle);
            }
        }, animationDuration);
    }
    
    // Crear part√≠culas cada cierto tiempo
    setInterval(createSandParticle, 800);
    
    // Crear algunas part√≠culas inmediatamente
    for (let i = 0; i < 5; i++) {
        setTimeout(createSandParticle, i * 200);
    }
}

// Manejar teclas presionadas
function handleKeyDown(e) {
    if (!gameState.gameRunning) return;
    
    gameState.keys[e.key] = true;
    
    switch(e.key) {
        case ' ':
            activateDetector();
            break;
        case 'Enter':
            attemptExcavation();
            break;
    }
    
    e.preventDefault();
}

// Manejar teclas liberadas
function handleKeyUp(e) {
    gameState.keys[e.key] = false;
}

// Activar detector de cristales
function activateDetector() {
    if (gameState.detectorCooldown > 0) return;
    
    gameState.detectorActive = true;
    gameState.detectorCooldown = 100; // 5 segundos a 60fps
    
    // Crear efecto visual del detector
    createDetectorPulse();
    
    // Resaltar cristales cercanos
    highlightNearbyCrystals();
    
    showNotification('üîç Detector activado - Cristales cercanos revelados!', 'success');
}

// Crear pulso del detector
function createDetectorPulse() {
    const desertArena = document.getElementById('desert-arena');
    const pulse = document.createElement('div');
    pulse.className = 'detector-pulse';
    
    const explorerX = gameState.explorer.x;
    const explorerY = gameState.explorer.y;
    
    pulse.style.left = (explorerX - 75) + 'px';
    pulse.style.top = (explorerY - 75) + 'px';
    pulse.style.width = '150px';
    pulse.style.height = '150px';
    
    desertArena.appendChild(pulse);
    
    setTimeout(() => {
        if (pulse.parentNode) {
            pulse.parentNode.removeChild(pulse);
        }
    }, 2000);
}

// Resaltar cristales cercanos
function highlightNearbyCrystals() {
    gameState.crystals.forEach(crystal => {
        const distance = Math.sqrt(
            Math.pow(crystal.x - gameState.explorer.x, 2) + 
            Math.pow(crystal.y - gameState.explorer.y, 2)
        );
        
        if (distance < 150) {
            const crystalElement = document.getElementById(crystal.id);
            if (crystalElement) {
                crystalElement.style.animation = 'crystal-shine 0.5s ease-in-out 3';
            }
        }
    });
}

// Intentar excavaci√≥n
function attemptExcavation() {
    const closestCrystal = findClosestCrystal();
    
    if (closestCrystal && closestCrystal.distance < 50) {
        excavateCrystal(closestCrystal.crystal);
    } else {
        showNotification('‚õèÔ∏è No hay cristales cerca para excavar', 'warning');
    }
}

// Encontrar cristal m√°s cercano
function findClosestCrystal() {
    let closest = null;
    let minDistance = Infinity;
    
    gameState.crystals.forEach(crystal => {
        const distance = Math.sqrt(
            Math.pow(crystal.x - gameState.explorer.x, 2) + 
            Math.pow(crystal.y - gameState.explorer.y, 2)
        );
        
        if (distance < minDistance) {
            minDistance = distance;
            closest = crystal;
        }
    });
    
    return closest ? {crystal: closest, distance: minDistance} : null;
}

// Excavar cristal
function excavateCrystal(crystal) {
    const crystalElement = document.getElementById(crystal.id);
    if (!crystalElement) return;
    
    // Animaci√≥n de excavaci√≥n
    const explorer = document.getElementById('explorer');
    explorer.classList.add('digging');
    setTimeout(() => explorer.classList.remove('digging'), 500);
    
    // Animaci√≥n del cristal
    crystalElement.classList.add('excavating');
    
    // Actualizar puntuaci√≥n
    gameState.score += crystal.points;
    gameState.crystalsCollected++;
    gameState.combo++;
    
    // Consumir energ√≠a
    gameState.explorer.energy = Math.max(0, gameState.explorer.energy - 10);
    
    // Remover cristal
    setTimeout(() => {
        if (crystalElement.parentNode) {
            crystalElement.parentNode.removeChild(crystalElement);
        }
        
        // Remover del array
        gameState.crystals = gameState.crystals.filter(c => c.id !== crystal.id);
        
        // Generar nuevo cristal
        setTimeout(() => generateCrystals(), 500);
    }, 500);
    
    // Efectos visuales
    showFloatingText(crystal.x, crystal.y, `+${crystal.points}`, crystal.type === 'toxic' ? 'toxic' : 'success');
    showNotification(`üíé ${crystal.name} excavado! +${crystal.points} puntos`, 'success');
    
    updateUI();
    checkLevelUp();
}

// Mover explorador
function moveExplorer() {
    if (!gameState.gameRunning) return;
    
    const keys = gameState.keys;
    let dx = 0, dy = 0;
    
    if (keys['ArrowLeft']) dx = -gameState.explorer.speed;
    if (keys['ArrowRight']) dx = gameState.explorer.speed;
    if (keys['ArrowUp']) dy = -gameState.explorer.speed;
    if (keys['ArrowDown']) dy = gameState.explorer.speed;
    
    // Movimiento diagonal (normalizar velocidad)
    if (dx !== 0 && dy !== 0) {
        dx *= 0.7;
        dy *= 0.7;
    }
    
    // Calcular nueva posici√≥n
    let newX = gameState.explorer.x + dx;
    let newY = gameState.explorer.y + dy;
    
    // Verificar l√≠mites del desierto (dimensiones fijas)
    const arenaWidth = 1000;
    const arenaHeight = 520;
    
    newX = Math.max(30, Math.min(arenaWidth - 30, newX));
    newY = Math.max(30, Math.min(arenaHeight - 30, newY));
    
    // Verificar colisiones con cactus
    if (!checkCactusCollision(newX, newY)) {
        gameState.explorer.x = newX;
        gameState.explorer.y = newY;
        
        // Consumir energ√≠a al moverse
        if (dx !== 0 || dy !== 0) {
            gameState.explorer.energy = Math.max(0, gameState.explorer.energy - 0.1);
        }
    }
    
    // Verificar colisi√≥n con oasis
    checkOasisCollision();
    
    // Actualizar posici√≥n visual
    updateExplorerPosition();
}

// Verificar colisi√≥n con cactus
function checkCactusCollision(x, y) {
    for (let obstacle of gameState.obstacles) {
        const distance = Math.sqrt(Math.pow(x - obstacle.x, 2) + Math.pow(y - obstacle.y, 2));
        if (distance < 45) {
            showNotification('üåµ ¬°Cuidado con los cactus!', 'warning');
            return true;
        }
    }
    return false;
}

// Verificar colisi√≥n con oasis
function checkOasisCollision() {
    for (let oasis of gameState.oases) {
        const distance = Math.sqrt(
            Math.pow(gameState.explorer.x - oasis.x, 2) + 
            Math.pow(gameState.explorer.y - oasis.y, 2)
        );
        
        if (distance < 50) {
            // Restaurar hidrataci√≥n
            if (gameState.explorer.thirst < 100) {
                gameState.explorer.thirst = Math.min(100, gameState.explorer.thirst + 2);
                showFloatingText(oasis.x, oasis.y, '+üíß', 'success');
            }
        }
    }
}

// Actualizar posici√≥n visual del explorador
function updateExplorerPosition() {
    const explorer = document.getElementById('explorer');
    if (explorer) {
        explorer.style.left = (gameState.explorer.x - 20) + 'px';
        explorer.style.top = (gameState.explorer.y - 20) + 'px';
    }
}

// Actualizar efectos ambientales
function updateEnvironmentalEffects() {
    // Reducir sed gradualmente
    gameState.explorer.thirst = Math.max(0, gameState.explorer.thirst - 0.05);
    
    // Reducir energ√≠a si tiene mucha sed
    if (gameState.explorer.thirst < 20) {
        gameState.explorer.energy = Math.max(0, gameState.explorer.energy - 0.1);
        if (gameState.explorer.thirst === 0) {
            showNotification('üíÄ ¬°Muriendo de sed! Encuentra un oasis!', 'error');
        }
    }
    
    // Reducir cooldown del detector
    if (gameState.detectorCooldown > 0) {
        gameState.detectorCooldown--;
    }
    
    // Game over por falta de energ√≠a
    if (gameState.explorer.energy === 0) {
        gameOver('¬°Te quedaste sin energ√≠a en el desierto!');
    }
}

// Actualizar UI
function updateUI() {
    document.getElementById('crystals-count').textContent = gameState.crystalsCollected;
    document.getElementById('score').textContent = gameState.score;
    document.getElementById('level').textContent = gameState.level;
    document.getElementById('combo').textContent = gameState.combo;
    
    // Actualizar barras de estado
    const energyBar = document.getElementById('energy-bar');
    const thirstBar = document.getElementById('thirst-bar');
    
    if (energyBar) {
        energyBar.style.width = gameState.explorer.energy + '%';
    }
    
    if (thirstBar) {
        thirstBar.style.width = gameState.explorer.thirst + '%';
    }
}

// Verificar subida de nivel
function checkLevelUp() {
    const crystalsNeeded = gameState.level * 10;
    if (gameState.crystalsCollected >= crystalsNeeded) {
        gameState.level++;
        gameState.maxCrystals = Math.min(10, gameState.maxCrystals + 1);
        gameState.combo = 0; // Reset combo
        
        showNotification(`üèÜ ¬°Nivel ${gameState.level}! M√°s cristales aparecen`, 'success');
        
        // Regenerar cristales adicionales
        setTimeout(() => generateCrystals(), 1000);
    }
}

// Game Over
function gameOver(reason) {
    gameState.gameRunning = false;
    
    if (gameState.gameLoop) clearInterval(gameState.gameLoop);
    if (gameState.environmentLoop) clearInterval(gameState.environmentLoop);
    
    showNotification(`üíÄ GAME OVER: ${reason}`, 'error');
    
    setTimeout(() => {
        // Actualizar contenido del modal
        document.getElementById('finalScore').textContent = gameState.score;
        document.getElementById('finalLevel').textContent = gameState.level;
        document.getElementById('finalCrystals').textContent = gameState.crystalsCollected;
        document.getElementById('finalHighscore').textContent = gameState.score; // Puedes guardar el highscore si lo implementas
        
        // Mostrar modal usando Bootstrap
        const gameOverModal = new bootstrap.Modal(document.getElementById('gameOverModal'));
        gameOverModal.show();
        
        // Event listeners para los botones
        document.getElementById('btnAcceptRestart').onclick = () => {
            gameOverModal.hide();
            restartDesertGame();
        };
        
        document.getElementById('btnCancelRestart').onclick = () => {
            gameOverModal.hide();
            // Opcional: redirigir a otra p√°gina
            // window.location.href = "{% url 'categorias' %}";
        };
    }, 500);
}

// Reiniciar juego
function restartDesertGame() {
    // Limpiar arena
    const desertArena = document.getElementById('desert-arena');
    desertArena.innerHTML = '';
    
    // Resetear estado
    gameState = {
        score: 0,
        level: 1,
        combo: 0,
        crystalsCollected: 0,
        explorer: {
            x: 500,
            y: 300,
            energy: 100,
            thirst: 100,
            speed: 3
        },
        crystals: [],
        obstacles: [],
        oases: [],
        maxCrystals: 6,
        gameRunning: false,
        keys: {},
        detectorActive: false,
        detectorCooldown: 0,
        gameLoop: null,
        environmentLoop: null
    };
    
    // Reinicializar
    initDesertGame();
}

// Iniciar bucles del juego
function startDesertGame() {
    gameState.gameRunning = true;
    
    // Bucle principal del juego (60 FPS)
    gameState.gameLoop = setInterval(() => {
        moveExplorer();
        updateUI();
    }, 16);
    
    // Bucle de efectos ambientales (m√°s lento)
    gameState.environmentLoop = setInterval(() => {
        updateEnvironmentalEffects();
    }, 100);
    
    console.log('üèúÔ∏è Bucles del juego iniciados');
}

// Mostrar texto flotante
function showFloatingText(x, y, text, type = 'success') {
    const desertArena = document.getElementById('desert-arena');
    if (!desertArena) return;
    
    const floatingText = document.createElement('div');
    floatingText.textContent = text;
    floatingText.style.position = 'absolute';
    floatingText.style.left = x + 'px';
    floatingText.style.top = y + 'px';
    floatingText.style.color = type === 'toxic' ? '#AB47BC' : '#4FC3F7';
    floatingText.style.fontSize = '18px';
    floatingText.style.fontWeight = 'bold';
    floatingText.style.zIndex = '100';
    floatingText.style.pointerEvents = 'none';
    floatingText.style.animation = 'float-up 1s ease-out forwards';
    floatingText.style.textShadow = '2px 2px 4px rgba(0,0,0,0.7)';
    
    desertArena.appendChild(floatingText);
    
    setTimeout(() => {
        if (floatingText.parentNode) {
            floatingText.parentNode.removeChild(floatingText);
        }
    }, 1000);
}

// Mostrar notificaci√≥n
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    if (notification) {
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    console.log(`üì¢ ${message}`);
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('üèúÔ∏è Iniciando Desert Crystal Hunter...');
    setTimeout(initDesertGame, 100);
});

// Cleanup al salir
window.addEventListener('beforeunload', function() {
    if (gameState.gameLoop) clearInterval(gameState.gameLoop);
    if (gameState.environmentLoop) clearInterval(gameState.environmentLoop);
});
</script>

{% csrf_token %}
{% endblock %}