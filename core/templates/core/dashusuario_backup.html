{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INICIO | Eco Puntos</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'core/css/iniciosesionperfil.css' %}">
  <style>
    :root {
      --primary: #4caf50;
      --primary-dark: #388e3c;
      --primary-light: #c8e6c9;
      --accent: #8bc34a;
      --text-dark: #263238;
      --text-light: #f5f5f5;
      --gray-light: #f9f9f9;
      --gray: #e0e0e0;
      --success: #66bb6a;
      --info: #29b6f6;
      --warning: #ffa726;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--gray-light);
      color: var(--text-dark);
      overflow-x: hidden;
      background-image: url('{% static "core/img/eco-background.jpg" %}');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.92);
      z-index: -1;
    }
    
    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: 280px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--text-light);
      z-index: 1000;
      transition: all 0.3s ease;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }
    
    .sidebar-header {
      padding: 25px 20px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    .sidebar-logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      margin: 0;
    }

    .sidebar-logo.avatar-sidebar {
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-color: #f8f9fa;
    }

    .sidebar-logo.avatar-sidebar svg {
      width: 80px;
      height: 80px;
      display: block;
    }
    
    .sidebar-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      color: white;
    }
    
    .user-info {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .user-name {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .user-level {
      display: inline-block;
      background-color: var(--accent);
      color: white;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-bottom: 10px;
    }
    
    .progress {
      height: 8px;
      background-color: rgba(255, 255, 255, 0.2);
      margin-bottom: 5px;
      border-radius: 10px;
    }
    
    .progress-bar {
      background-color: var(--accent);
      border-radius: 10px;
    }
    
    .nav-menu {
      padding: 10px 0;
    }
    
    .nav-item {
      padding: 10px 20px;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
      cursor: pointer;
      border-left: 4px solid transparent;
    }
    
    .nav-item:hover, .nav-item.active {
      background-color: rgba(255, 255, 255, 0.1);
      border-left: 4px solid var(--accent);
    }
    
    .nav-item i {
      margin-right: 15px;
      font-size: 1.2rem;
      width: 20px;
      text-align: center;
    }
    
    .nav-item span {
      font-weight: 500;
    }
    
    /* Main Content */
    .main-content {
      margin-left: 280px;
      padding: 20px;
      min-height: 100vh;
      transition: all 0.3s ease;
    }
    
    .page-header {
      margin-bottom: 15px;
    }
    
    .welcome-message {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 10px;
    }
    
    /* Dashboard Cards */
    .dashboard-card {
      background: white;
      border-radius: 15px;
  padding: 38px 36px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      height: 100%;
      position: relative;
      overflow: hidden;
      border-bottom: 4px solid var(--primary);
    }
    
    .dashboard-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
    }
    
    .dashboard-card i {
  font-size: 3rem;
      color: var(--primary);
      margin-bottom: 15px;
    }
    
    .dashboard-card h4 {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-dark);
      margin-bottom: 10px;
    }
    
    .dashboard-card p {
  font-size: 2.3rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 0;
    }
    
    .dashboard-card .card-label {
      font-size: 0.9rem;
      color: #777;
      margin-bottom: 0;
    }
    
    /* Categorías */
    /* Categorías Enhanced */
    .categoria-card-enhanced {
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  border-radius: 26px;
  padding: 22px 0 22px 0;
      border: 1px solid #e9ecef;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      height: 100%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      position: relative;
    }
    
    .categoria-card-enhanced:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 40px rgba(76, 175, 80, 0.2);
      border-color: var(--primary);
    }
    
    .categoria-header {
      background: linear-gradient(135deg, var(--primary) 0%, #4caf50 100%);
  padding: 36px 28px;
      text-align: center;
      position: relative;
      color: white;
    }
    
    .categoria-icon-large {
      font-size: 3.5rem;
      margin-bottom: 15px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .categoria-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary);
      padding: 8px 12px;
      border-radius: 15px;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .points-value {
      font-size: 1.2em;
    }
    
    .points-unit {
      font-size: 0.8em;
      opacity: 0.8;
    }
    
    .categoria-body {
  padding: 36px 28px;
      text-align: center;
    }
    
    .categoria-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
      text-transform: capitalize;
    }
    
    .categoria-description {
      color: #6c757d;
      font-size: 0.95rem;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .categoria-actions {
      display: flex;
      justify-content: center;
    }
    
    .categoria-actions .btn-block {
      flex: 1;
      border-radius: 10px;
      font-weight: 600;
      padding: 10px 15px;
      border: none;
      background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
      transition: all 0.3s ease;
    }
    
    .categoria-actions .btn-block:hover {
      background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
      transform: translateY(-2px);
    }
    
    .empty-state-card {
      background: white;
      border-radius: 15px;
      border: 2px dashed #dee2e6;
      margin: 20px 0;
    }
    
    /* Game Cards Styles */
    .game-card {
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      border-radius: 20px;
      padding: 0;
      border: 1px solid #e9ecef;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      height: 100%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      position: relative;
    }
    
    .game-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 12px 40px rgba(76, 175, 80, 0.2);
      border-color: var(--primary);
    }
    
    .game-header {
      padding: 20px;
      text-align: center;
      position: relative;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .game-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: white;
      margin: 0 auto 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .game-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255, 255, 255, 0.95);
      color: var(--primary);
      padding: 5px 10px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.8rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .game-body {
      padding: 20px;
      text-align: center;
    }
    
    .game-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .game-description {
      color: #6c757d;
      font-size: 0.85rem;
      margin-bottom: 15px;
      line-height: 1.4;
    }
    
    .game-progress {
      background: #e9ecef;
      height: 4px;
      border-radius: 2px;
      margin-bottom: 15px;
      overflow: hidden;
    }
    
    .progress-bar {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    
    .btn-game {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none;
      color: white;
      padding: 8px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-game:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      transform: translateY(-2px);
      color: white;
      text-decoration: none;
    }
    
    /* Gaming Style Elements */
    .gaming-style {
      position: relative;
      overflow: hidden;
    }
    
    .gaming-style::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s ease;
    }
    
    .gaming-style:hover::before {
      left: 100%;
    }
    
    .game-status {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.7rem;
      font-weight: 600;
      color: #00ff88;
      text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .status-indicator.online {
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.7);
      animation: pulse-status 2s infinite;
    }
    
    @keyframes pulse-status {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .game-badge.premium {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      box-shadow: 0 0 15px rgba(255, 107, 53, 0.4);
      border: 2px solid #ff8c00;
    }
    
    .game-stats {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 8px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.8rem;
      color: #666;
      gap: 2px;
    }
    
    .stat-item i {
      font-size: 1rem;
      color: var(--accent);
    }
    
    .progress-bar.gaming {
      background: linear-gradient(90deg, #ff6b35, #f7931e, #ffdd59);
      box-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
      animation: gaming-glow 2s ease-in-out infinite alternate;
    }
    
    @keyframes gaming-glow {
      from { box-shadow: 0 0 10px rgba(255, 107, 53, 0.5); }
      to { box-shadow: 0 0 20px rgba(255, 107, 53, 0.8); }
    }
    
    .btn-game-modern {
      background: linear-gradient(135deg, #ff6b35, #ff4757);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }
    
    .btn-game-modern:hover {
      background: linear-gradient(135deg, #ff4757, #c44569);
      transform: translateY(-3px) scale(1.05);
      color: white;
      text-decoration: none;
      box-shadow: 0 8px 25px rgba(255, 107, 53, 0.5);
    }
    
    .btn-game-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }
    
    .btn-game-modern:hover::before {
      left: 100%;
    }
    
    /* Quick Actions Styles */
    .quick-actions-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .quick-action-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      border: 1px solid #e9ecef;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .quick-action-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      border-color: var(--primary);
    }
    
    .action-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
      flex-shrink: 0;
    }
    
    .action-content {
      flex: 1;
    }
    
    .action-content h6 {
      margin: 0 0 5px 0;
      font-weight: 700;
      color: #2c3e50;
      font-size: 0.95rem;
    }
    
    .action-content p {
      margin: 0;
      color: #6c757d;
      font-size: 0.8rem;
      line-height: 1.3;
    }
    
    .action-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .action-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
      color: white;
      text-decoration: none;
    }
    
    /* Mobile Navigation */
    .mobile-nav-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.2rem;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
      transition: all 0.3s ease;
    }
    
    .mobile-nav-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
    }
    
    .sidebar-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      transition: opacity 0.3s ease;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .mobile-nav-toggle {
        display: block;
      }
      
      .sidebar {
        transform: translateX(-100%);
        z-index: 1000;
        transition: transform 0.3s ease;
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .sidebar-backdrop.active {
        display: block;
        opacity: 1;
      }
      
      .main-content {
        margin-left: 0;
        padding: 80px 15px 20px;
      }
      
      .welcome-message {
        font-size: 1.4rem;
        margin-top: 20px;
      }
      
      .dashboard-card {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .dashboard-card i {
        font-size: 2.5rem;
      }
      
      .dashboard-card p {
        font-size: 1.8rem;
      }
      
      .categoria-header {
        padding: 25px 20px;
      }
      
      .categoria-icon-large {
        font-size: 2.5rem;
      }
      
      .game-card, .quick-action-card {
        margin-bottom: 15px;
      }
      
      .quick-actions-container {
        margin-top: 30px;
      }
      
      .action-content h6 {
        font-size: 0.9rem;
      }
      
      .action-content p {
        font-size: 0.75rem;
      }
      
      .section-title {
        font-size: 1.3rem;
      }
      
      .section-subtitle {
        font-size: 0.9rem;
      }
    }
    
    @media (max-width: 480px) {
      .main-content {
        padding: 80px 10px 20px;
      }
      
      .dashboard-card {
        padding: 15px;
        text-align: center;
      }
      
      .categoria-card-enhanced {
        margin-bottom: 15px;
      }
      
      .welcome-message {
        font-size: 1.2rem;
        text-align: center;
      }
      
      .chart-container {
        overflow-x: auto;
      }
      
      .btn-group {
        flex-wrap: wrap;
        gap: 5px;
      }
      
      .col-md-3 {
        margin-bottom: 15px;
      }
    }

    /* Sidebar optimizations */
    .sidebar-container {
      height: 100%;
      min-height: 600px;
    }
    
    .quick-stats-container.h-100 {
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: calc(100vh - 200px);
    }
    
    .quick-stat-card.flex-fill {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      margin-bottom: 10px;
    }
    
    .quick-action-cta {
      margin-top: auto;
      margin-bottom: 0;
      flex-shrink: 0;
    }

    /* Tutorial Interactivo Styles */
    .tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: none;
    }

    .tutorial-step {
      position: absolute;
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      max-width: 350px;
      z-index: 10000;
    }

    .tutorial-step::before {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
    }

    .tutorial-step.bottom::before {
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 10px solid white;
    }

    .tutorial-step.top::before {
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid white;
    }

    .tutorial-step.left::before {
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-left: 10px solid white;
    }

    .tutorial-step.right::before {
      left: -10px;
      top: 50%;
      transform: translateY(-50%);
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-right: 10px solid white;
    }

    .tutorial-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .tutorial-step-number {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      margin-right: 15px;
      font-size: 0.9rem;
    }

    .tutorial-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    .tutorial-content {
      color: #555;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .tutorial-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tutorial-progress {
      display: flex;
      gap: 5px;
    }

    .tutorial-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ddd;
      transition: all 0.3s ease;
    }

    .tutorial-dot.active {
      background: var(--primary);
      transform: scale(1.2);
    }

    .tutorial-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tutorial-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .tutorial-btn.secondary {
      background: #6c757d;
    }

    .tutorial-highlight {
      position: absolute;
      border: 3px solid var(--primary);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
      pointer-events: none;
      z-index: 9998;
      animation: tutorial-pulse 2s infinite;
    }

    @keyframes tutorial-pulse {
      0% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
      50% { box-shadow: 0 0 30px rgba(76, 175, 80, 0.8); }
      100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
    }

    .tutorial-trigger {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, var(--info), #2196f3);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
      transition: all 0.3s ease;
      z-index: 1000;
      border: none;
    }

    .tutorial-trigger:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
    }

    .tutorial-trigger i {
      font-size: 1.5rem;
    }

    /* FAB (Floating Action Button) Styles */
    .fab-container {
      position: fixed;
      bottom: 30px;
      left: 30px;
      z-index: 1000;
    }

    .fab-main {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .fab-main:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 12px 35px rgba(76, 175, 80, 0.6);
    }

    .fab-main.active {
      transform: rotate(45deg);
    }

    .fab-main::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .fab-main:hover::before {
      opacity: 1;
    }

    .fab-menu {
      position: absolute;
      bottom: 80px;
      left: 0;
      display: flex;
      flex-direction: column;
      gap: 15px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .fab-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .fab-option {
      background: white;
      border: 2px solid var(--primary);
      color: var(--primary);
      border-radius: 25px;
      padding: 12px 20px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      text-decoration: none;
      min-width: 180px;
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }

    .fab-option:hover {
      background: var(--primary);
      color: white;
      transform: translateX(-5px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
      text-decoration: none;
    }

    .fab-option i {
      font-size: 1.2rem;
      width: 20px;
      text-align: center;
    }

    .fab-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }

    .fab-option:hover::before {
      left: 100%;
    }

    /* Animaciones de entrada escalonada */
    .fab-option:nth-child(1) { transition-delay: 0.1s; }
    .fab-option:nth-child(2) { transition-delay: 0.15s; }
    .fab-option:nth-child(3) { transition-delay: 0.2s; }
    .fab-option:nth-child(4) { transition-delay: 0.25s; }

    /* Overlay para cerrar el menú */
    .fab-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 999;
      display: none;
    }

    .fab-overlay.active {
      display: block;
    }

    /* Badge de notificación en FAB */
    .fab-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4757;
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 12px;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);
      animation: badge-bounce 0.6s ease-in-out infinite alternate;
    }

    @keyframes badge-bounce {
      0% { transform: scale(1); }
      100% { transform: scale(1.1); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .fab-container {
        bottom: 20px;
        left: 20px;
      }
      
      .fab-main {
        width: 55px;
        height: 55px;
      }
      
      .fab-option {
        min-width: 160px;
        padding: 10px 16px;
      }
    }

    /* Micro-animaciones mejoradas */
    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes bounce {
      0%, 20%, 60%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-10px);
      }
      80% {
        transform: translateY(-5px);
      }
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }

    @keyframes shake {
      0%, 100% {
        transform: translateX(0);
      }
      10%, 30%, 50%, 70%, 90% {
        transform: translateX(-5px);
      }
      20%, 40%, 60%, 80% {
        transform: translateX(5px);
      }
    }

    /* Aplicar animaciones a elementos específicos */
    .dashboard-card {
      animation: fadeInUp 0.6s ease-out;
    }

    .game-card {
      animation: slideInRight 0.8s ease-out;
    }

    .quick-action-card {
      animation: fadeInUp 0.6s ease-out;
    }

    .quick-stat-card {
      animation: slideInRight 0.7s ease-out;
    }

    /* Efectos hover mejorados */
    .dashboard-card:hover {
      animation: pulse 0.6s ease-in-out;
    }

    .game-card:hover .game-icon {
      animation: bounce 0.8s ease-in-out;
    }

    .quick-action-card:hover {
      animation: pulse 0.4s ease-in-out;
    }

    /* Feedback visual inmediato */
    .btn {
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
    }

    /* Loading states */
    .loading {
      position: relative;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Transiciones suaves para navegación */
    .nav-link {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .nav-link:hover {
      transform: translateX(5px);
    }

    /* Efectos de entrada escalonada */
    .animate-stagger > * {
      opacity: 0;
      animation: fadeInUp 0.6s ease-out forwards;
    }

    .animate-stagger > *:nth-child(1) { animation-delay: 0.1s; }
    .animate-stagger > *:nth-child(2) { animation-delay: 0.2s; }
    .animate-stagger > *:nth-child(3) { animation-delay: 0.3s; }
    .animate-stagger > *:nth-child(4) { animation-delay: 0.4s; }
    .animate-stagger > *:nth-child(5) { animation-delay: 0.5s; }
    .animate-stagger > *:nth-child(6) { animation-delay: 0.6s; }

    /* Feedback de interacción */
    .interactive-element {
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .interactive-element:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .interactive-element:active {
      transform: translateY(0);
      transition-duration: 0.1s;
    }

    /* Animaciones de progreso */
    .progress-bar {
      animation: progressFill 2s ease-out;
    }

    @keyframes progressFill {
      from {
        width: 0 !important;
      }
    }

    /* Notificaciones animadas */
    .notification-enter {
      animation: slideInRight 0.5s ease-out;
    }

    .notification-exit {
      animation: slideOutRight 0.3s ease-in;
    }

    @keyframes slideOutRight {
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }



    /* Eventos dinámicos */
    .events-banner {
      background: linear-gradient(135deg, #6a1b9a, #8e24aa);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .events-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="20" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
      animation: float 10s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .event-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      margin-bottom: 10px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .event-item:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(5px);
    }

    .event-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 1.3rem;
    }

    .event-content {
      flex: 1;
    }

    .event-title {
      font-weight: 700;
      margin-bottom: 5px;
    }

    .event-date {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .event-action {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .event-action:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    /* Sistema de Logros Avanzado */
    .achievements-panel {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }

    .achievements-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="0,0 100,0 80,100 0,100" fill="rgba(255,255,255,0.05)"/></svg>');
      pointer-events: none;
    }

    .achievements-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .achievements-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .achievements-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .achievements-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .achievement-card {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 15px;
      padding: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .achievement-card:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.25);
    }

    .achievement-card.unlocked {
      border-color: #ffd700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    .achievement-card.unlocked::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.1) 50%, transparent 70%);
      animation: shine 2s infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .achievement-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 15px;
      position: relative;
    }

    .achievement-icon.bronze {
      background: linear-gradient(135deg, #cd7f32, #b8860b);
    }

    .achievement-icon.silver {
      background: linear-gradient(135deg, #c0c0c0, #a8a8a8);
    }

    .achievement-icon.gold {
      background: linear-gradient(135deg, #ffd700, #ffb347);
    }

    .achievement-icon.platinum {
      background: linear-gradient(135deg, #e5e4e2, #d3d3d3);
    }

    .achievement-icon.locked {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.5);
    }

    .achievement-info {
      flex: 1;
    }

    .achievement-name {
      font-weight: 700;
      margin-bottom: 5px;
      font-size: 1.1rem;
    }

    .achievement-description {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .achievement-progress {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .achievement-progress-bar {
      flex: 1;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
    }

    .achievement-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      border-radius: 4px;
      transition: width 1s ease;
    }

    .achievement-progress-text {
      font-size: 0.85rem;
      font-weight: 600;
      min-width: 60px;
      text-align: right;
    }

    /* Desafíos semanales */
    .weekly-challenges {
      margin-top: 25px;
      padding-top: 25px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .challenges-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 20px;
    }

    .challenge-timer {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      backdrop-filter: blur(10px);
    }

    .challenges-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .challenge-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
    }

    .challenge-item:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .challenge-item.completed {
      background: rgba(76, 175, 80, 0.3);
      border: 1px solid rgba(76, 175, 80, 0.5);
    }

    .challenge-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .challenge-content {
      flex: 1;
    }

    .challenge-title {
      font-weight: 700;
      margin-bottom: 5px;
    }

    .challenge-description {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .challenge-reward {
      font-size: 0.8rem;
      color: #ffd700;
      font-weight: 600;
    }

    .challenge-progress {
      min-width: 80px;
      text-align: center;
    }

    .challenge-progress-circle {
      width: 50px;
      height: 50px;
      position: relative;
      margin: 0 auto 5px;
    }

    .challenge-progress-circle svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .challenge-progress-circle .circle-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.2);
      stroke-width: 4;
    }

    .challenge-progress-circle .circle-progress {
      fill: none;
      stroke: #4caf50;
      stroke-width: 4;
      stroke-linecap: round;
      transition: stroke-dasharray 0.5s ease;
    }

    .challenge-progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.8rem;
      font-weight: 700;
    }

    /* Badges flotantes */
    .floating-badge {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      z-index: 10001;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .floating-badge.show {
      transform: translate(-50%, -50%) scale(1);
    }

    .floating-badge-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
      animation: bounce 0.8s ease-in-out infinite alternate;
    }

    .floating-badge-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .floating-badge-description {
      color: #666;
      margin-bottom: 20px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .achievements-grid {
        grid-template-columns: 1fr;
      }
      
      .challenges-list {
        grid-template-columns: 1fr;
      }
      
      .achievements-panel {
        padding: 20px;
      }
    }
    
    /* Recent Activity Styles */
    .recent-activity-container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #e9ecef;
    }
    
    .activity-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px 0;
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.3s ease;
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-item:hover {
      background: #f8f9fa;
      border-radius: 12px;
      padding-left: 15px;
      padding-right: 15px;
    }
    
    .activity-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      color: white;
      flex-shrink: 0;
    }
    
    .activity-icon.canje {
      background: linear-gradient(135deg, #4caf50, #45a049);
    }
    
    .activity-icon.recompensa {
      background: linear-gradient(135deg, #ff9800, #f57c00);
    }
    
    .activity-icon.juego {
      background: linear-gradient(135deg, #2196f3, #1976d2);
    }
    
    .activity-icon.logro {
      background: linear-gradient(135deg, #ffc107, #ff8f00);
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-title {
      font-weight: 600;
      color: #2c3e50;
      font-size: 1rem;
      margin-bottom: 5px;
    }
    
    .activity-subtitle {
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .activity-points {
      text-align: right;
    }
    
    .points-gained {
      background: linear-gradient(135deg, #4caf50, #45a049);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .points-potential {
      background: linear-gradient(135deg, #2196f3, #1976d2);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .points-info {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    /* Quick Stats Styles */
    .quick-stats-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .quick-stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #e9ecef;
      transition: all 0.3s ease;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .quick-stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .stat-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .stat-header i {
      font-size: 1.3rem;
      color: var(--primary);
    }
    
    .stat-header h5 {
      margin: 0;
      font-weight: 700;
      color: #2c3e50;
      font-size: 1rem;
    }
    
    .stat-content {
      text-align: center;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }
    
    .progress-bar-mini {
      background: #e9ecef;
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .streak-icons {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 10px;
    }
    
    .streak-icon {
      color: #ff6b35;
      font-size: 1.2rem;
      animation: flicker 2s infinite alternate;
    }
    
    @keyframes flicker {
      0% { opacity: 0.8; }
      100% { opacity: 1; }
    }
    
    .objective-item {
      text-align: left;
    }
    
    .objective-name {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }
    
    .objective-progress {
      margin-bottom: 8px;
    }
    
    .objective-progress span {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 5px;
      display: block;
    }
    
    .objective-remaining {
      font-size: 0.8rem;
      color: #28a745;
      font-weight: 600;
    }
    
    /* Quick Action CTA */
    .quick-action-cta {
      background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
      border-radius: 15px;
      padding: 25px;
      border: 2px solid #c8e6c9;
      text-align: center;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .cta-content h6 {
      color: #2e7d32;
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 1rem;
    }
    
    .cta-content p {
      color: #4caf50;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }
    
    /* Responsive for Recent Activity */
    @media (max-width: 768px) {
      .recent-activity-container {
        padding: 20px;
      }
      
      .activity-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        text-align: left;
      }
      
      .activity-points {
        align-self: flex-end;
      }
      
      .quick-stats-container {
        margin-top: 30px;
      }
      
      .quick-stat-card {
        padding: 20px;
        margin-bottom: 15px !important;
      }
      
      .stat-number {
        font-size: 2rem;
      }
      
      /* Layout horizontal en móviles se convierte en vertical */
      .quick-stat-card.h-100,
      .quick-action-cta.h-100 {
        height: auto !important;
        margin-bottom: 15px;
      }
    }
    
    /* Tarjeta de Nivel Legendario Premium */
    .legendary-level-card {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  border: 2px solid #ffd700;
  border-radius: 12px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 6px 15px rgba(255, 215, 0, 0.3), 0 3px 8px rgba(0, 0, 0, 0.2);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  max-width: 700px !important;
  height: 240px !important;
  padding: 48px !important;
  font-size: 1.4rem !important;
    }
    
    .legendary-level-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(255, 215, 0, 0.4), 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    
    .legendary-background {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  max-width: 700px;
  height: 240px;
  padding: 48px;
    }
    
    .legendary-particles {
      position: absolute;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="%23ffd700" opacity="0.6"/><circle cx="80" cy="30" r="0.5" fill="%23fff" opacity="0.4"/><circle cx="60" cy="70" r="0.8" fill="%23ffd700" opacity="0.5"/><circle cx="30" cy="80" r="0.6" fill="%23fff" opacity="0.3"/></svg>') repeat;
      animation: sparkleFloat 6s ease-in-out infinite;
    }
    
    .legendary-glow {
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
      animation: pulseGlow 3s ease-in-out infinite alternate;
    }
    
    .level-header-premium {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      position: relative;
      z-index: 2;
    }
    
    .level-icon-premium {
      position: relative;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 235, 59, 0.1));
      border: 2px solid #ffd700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      box-shadow: 0 3px 8px rgba(255, 215, 0, 0.3);
    }
    
    .level-icon-premium i {
      font-size: 1.2rem;
      text-shadow: 0 0 4px rgba(255, 215, 0, 0.5);
    }
    
    .level-rank-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: 700;
      border: 1px solid white;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    }
    
    .level-rank-badge.legendary {
      background: linear-gradient(135deg, #ffd700, #ffeb3b);
      color: #333;
      font-size: 1rem;
      animation: rotateStar 4s linear infinite;
    }
    
    .level-text-premium {
      flex: 1;
      color: white;
    }
    
    .level-title-premium {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 4px;
      background: linear-gradient(135deg, #ffd700, #fff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.1;
    }
    
    .level-subtitle-premium {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.7rem;
      margin: 0;
      line-height: 1.1;
    }
    
    .legendary-badge-premium {
      background: linear-gradient(135deg, #ffd700, #ffeb3b);
      color: #333;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.65rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 3px;
      box-shadow: 0 2px 6px rgba(255, 215, 0, 0.4);
      animation: pulseGlow 2s ease-in-out infinite alternate;
    }
    
    .level-stats-section {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      position: relative;
      z-index: 2;
    }
    
    .stat-item-mini {
      flex: 1;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 6px;
      padding: 4px 3px;
      text-align: center;
      color: #ffffff !important;
      transition: all 0.3s ease;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
    }
    
    .stat-item-mini:hover {
      background: rgba(255, 215, 0, 0.1);
      transform: translateY(-1px);
      border-color: rgba(255, 215, 0, 0.5);
    }
    
    .stat-item-mini i {
      color: #ffd700 !important;
      margin-bottom: 2px;
      font-size: 0.8rem;
      filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.8));
    }
    
    .stat-item-mini span {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: #ffffff !important;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
    }
    
    .level-progress-premium {
      position: relative;
      z-index: 2;
    }
    
    .next-level-info-premium {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 15px;
      color: white;
    }
    
    .next-level-label {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .next-level-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #ffd700;
    }
    
    .points-needed-premium {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .progress-container-premium {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .progress-bar-premium {
      flex: 1;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill-premium {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a, #ffd700);
      border-radius: 10px;
      transition: width 0.6s ease;
      position: relative;
    }
    
    .progress-glow {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 2s infinite;
    }
    
    .progress-percentage {
      color: #ffd700;
      font-weight: 600;
      font-size: 0.9rem;
      min-width: 40px;
      text-align: right;
    }
    
    .max-level-celebration {
      text-align: center;
      color: white;
      padding: 20px 0;
    }
    
    .celebration-icon {
      margin-bottom: 15px;
    }
    
    .celebration-icon i {
      font-size: 3rem;
      color: #ffd700;
      animation: bounce 2s infinite;
    }
    
    .celebration-text h4 {
      color: #ffd700;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .celebration-text p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.95rem;
      margin: 0;
    }
    
    /* Animaciones */
    @keyframes sparkleFloat {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(180deg); }
    }
    
    @keyframes pulseGlow {
      0% { opacity: 0.5; transform: scale(1); }
      100% { opacity: 0.8; transform: scale(1.05); }
    }
    
    @keyframes rotateStar {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    
    /* Tarjetas Premium de Puntos y Canjes - Tamaño Reducido */
    .premium-points-card, .premium-exchanges-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #dee2e6;
      border-radius: 12px;
      padding: 12px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      color: #2c3e50;
      width: 100%;
      max-width: 180px;
      height: 110px;
    }
    
    .premium-exchanges-card {
  background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
  border-color: #c8e6c9;
  box-shadow: 0 3px 10px rgba(76, 175, 80, 0.1);
  max-width: 400px !important;
  height: 200px !important;
  padding: 32px !important;
  font-size: 1.3rem !important;
}

.premium-exchanges-card .premium-background {
  max-width: 400px;
  height: 200px;
  padding: 32px;
}
    
        /* Agrandar el cuadro de puntos acumulados */
    .premium-points-card {
  max-width: 400px !important;
  height: 200px !important;
  padding: 32px !important;
  font-size: 1.3rem !important;
    }
    .stats-card.points.premium-points-card {
  max-width: 400px !important;
  height: 200px !important;
  padding: 32px !important;
  font-size: 1.3rem !important;
    }

    .premium-background {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
  max-width: 400px;
  height: 200px;
  padding: 32px;
    }
    
    .premium-particles {
      position: absolute;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="25" cy="25" r="1" fill="%23ffffff" opacity="0.4"/><circle cx="75" cy="20" r="0.5" fill="%23ffffff" opacity="0.6"/><circle cx="50" cy="75" r="0.8" fill="%23ffffff" opacity="0.3"/><circle cx="80" cy="80" r="0.6" fill="%23ffffff" opacity="0.5"/></svg>') repeat;
      animation: floatParticles 8s ease-in-out infinite;
    }
    
    .premium-glow {
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      animation: pulsePremium 4s ease-in-out infinite alternate;
    }
    
    .exchanges-glow {
      background: radial-gradient(circle, rgba(56, 239, 125, 0.2) 0%, transparent 70%);
    }
    
    .premium-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      position: relative;
      z-index: 2;
    }
    
    .premium-icon {
      width: 35px;
      height: 35px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(108, 117, 125, 0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .premium-icon i {
      font-size: 1rem;
      color: #495057;
      text-shadow: none;
    }
    
    .points-icon {
      background: rgba(255, 235, 59, 0.3);
      border-color: rgba(255, 193, 7, 0.5);
    }
    
    .points-icon i {
      color: #f57c00;
    }
    
    .exchanges-icon {
      background: rgba(200, 230, 201, 0.5);
      border-color: rgba(76, 175, 80, 0.5);
    }
    
    .exchanges-icon i {
      color: #388e3c;
      animation: rotateIcon 6s linear infinite;
    }
    
    .icon-sparkles {
      position: absolute;
      width: 100%;
      height: 100%;
    }
    
    .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: white;
      border-radius: 50%;
      animation: sparkleAnimation 2s infinite;
    }
    
    .sparkle-1 { top: 10%; right: 20%; animation-delay: 0s; }
    .sparkle-2 { bottom: 15%; left: 25%; animation-delay: 0.7s; }
    .sparkle-3 { top: 60%; right: 10%; animation-delay: 1.4s; }
    
    .icon-rotation {
      position: absolute;
      width: 80px;
      height: 80px;
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      top: -10px;
      left: -10px;
      animation: rotateRing 8s linear infinite;
    }
    
    .premium-trend {
      background: rgba(248, 249, 250, 0.9);
      backdrop-filter: blur(10px);
      padding: 6px 10px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      border: 1px solid rgba(108, 117, 125, 0.2);
      color: #495057 !important;
      text-shadow: none;
    }
    
    .premium-trend i {
      color: #28a745;
    }
    
    .premium-progress {
      display: flex;
      align-items: center;
    }
    
    .circular-progress {
      position: relative;
      width: 40px;
      height: 40px;
    }
    
    .circular-chart {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }
    
    .circle-bg {
      fill: none;
      stroke: rgba(108, 117, 125, 0.2);
      stroke-width: 2;
    }
    
    .circle {
      fill: none;
      stroke: #28a745;
      stroke-width: 3;
      stroke-linecap: round;
      animation: progressAnimation 2s ease-in-out;
      filter: none;
    }
    
    .percentage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.7rem;
      font-weight: 700;
      color: #495057 !important;
      text-shadow: none;
    }
    
    .premium-content {
      text-align: center;
      margin-bottom: 8px;
      position: relative;
      z-index: 2;
    }
    
    .premium-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 2px;
      color: #2c3e50 !important;
      text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
      text-align: center;
      line-height: 1;
    }
    
    .premium-label {
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #34495e !important;
      text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.6);
      line-height: 1.1;
    }
    
    .premium-subtitle {
      font-size: 0.65rem;
      color: #5d6d7e !important;
      font-style: italic;
      text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.5);
      line-height: 1;
    }
    
    .premium-footer {
      position: relative;
      z-index: 2;
    }
    
    .achievement-mini {
      background: rgba(248, 249, 250, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(108, 117, 125, 0.2);
      border-radius: 12px;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #495057 !important;
      text-shadow: none;
    }
    
    .achievement-mini i {
      color: #ffc107 !important;
      font-size: 0.8rem;
      filter: none;
    }
    
    /* Animaciones Premium */
    @keyframes floatParticles {
      0%, 100% { transform: translateY(0px) translateX(0px); }
      25% { transform: translateY(-5px) translateX(2px); }
      50% { transform: translateY(-10px) translateX(-2px); }
      75% { transform: translateY(-5px) translateX(1px); }
    }
    
    @keyframes pulsePremium {
      0% { opacity: 0.3; transform: scale(1); }
      100% { opacity: 0.6; transform: scale(1.1); }
    }
    
    @keyframes sparkleAnimation {
      0%, 100% { opacity: 0; transform: scale(0); }
      50% { opacity: 1; transform: scale(1); }
    }
    
    @keyframes rotateIcon {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes rotateRing {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(-360deg); }
    }
    
    @keyframes progressAnimation {
      0% { stroke-dasharray: 0, 100; }
      100% { stroke-dasharray: 75, 100; }
    }
    
    /* Mejoras para el título de la tarjeta legendaria */
    .level-title-premium {
      font-size: 1.1rem !important;
      font-weight: 700;
      margin-bottom: 6px;
      color: #ffd700 !important;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(255, 215, 0, 0.5);
      text-align: center;
      white-space: nowrap;
      overflow: visible;
    }
    
    .level-subtitle-premium {
      color: rgba(255, 255, 255, 0.9) !important;
      font-size: 0.8rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      margin: 0;
    }
    
    /* Mantener estilos originales para otros elementos */
    .categorias-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .btn-reciclar {
      background-color: var(--primary);
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }
    
    .btn-reciclar:hover {
      background-color: var(--primary-dark);
      color: white;
    }
    
    /* Activity History */
    .activity-history-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      margin-top: 30px;
    }
    
    .activity-table th, .activity-table td {
      padding: 12px 15px;
      vertical-align: middle;
    }
    
    .activity-table thead th {
      background-color: var(--gray-light);
      font-weight: 600;
      color: var(--text-dark);
      border-bottom: 1px solid var(--gray);
    }
    
    .activity-table tbody tr:hover {
      background-color: #f2f2f2;
    }
    
    .activity-table .badge {
      font-size: 0.8rem;
      padding: 5px 10px;
      border-radius: 15px;
    }
    
    .puntos-cell {
      font-weight: 600;
      color: var(--success);
    }
    

    .float-plus-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
    }
    
    .float-plus-btn .btn {
      background-color: var(--primary);
      border-color: var(--primary);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    
    .float-plus-btn .btn:hover {
      background-color: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: scale(1.1);
    }
    
    /* Menú desplegable del botón flotante */
    .float-menu {
      position: absolute;
      bottom: 80px;
      right: 0;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      padding: 10px;
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }
    
    .float-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .float-menu-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      text-decoration: none;
      color: var(--text-dark);
      border-radius: 10px;
      margin-bottom: 5px;
      transition: all 0.3s ease;
    }
    
    .float-menu-item:hover {
      background-color: var(--primary-light);
      color: var(--primary-dark);
      text-decoration: none;
      transform: translateX(5px);
    }
    
    .float-menu-item i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
      font-size: 1.1rem;
    }
    
    .float-menu-item:last-child {
      margin-bottom: 0;
    }
    
    /* Animación de rotación del icono principal */
    .float-plus-btn .btn.active i {
      transform: rotate(45deg);
    }
    
    /* Modals */
    .modal-content {
      border-radius: 15px;
      border: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      border-bottom: none;
      padding: 20px 25px;
      background-color: var(--primary-light);
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
    }
    
    .modal-title {
      font-weight: 600;
      color: var(--primary-dark);
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .form-label {
      font-weight: 500;
      color: var(--text-dark);
    }
    
    .form-control:focus {
      border-color: var(--primary-dark);
      box-shadow: 0 0 0 0.25rem rgba(76, 175, 80, 0.25);
    }
    
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
      border-color: var(--primary-dark);
    }
    
    .btn-secondary {
      background-color: var(--gray);
      border-color: var(--gray);
      color: var(--text-dark);
    }
    
    .btn-secondary:hover {
      background-color: #c0c0c0;
      border-color: #c0c0c0;
    }
    /* --- ESTILOS MODERNOS DE BIENVENIDA Y ESTADÍSTICAS --- */
    .welcome-container {
      display: flex;
      align-items: center;
      gap: 2rem;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      padding: 1.5rem 2rem;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      margin-bottom: 1rem;
      position: relative;
    }
    
    .header-actions {
      position: absolute;
      top: 2rem;
      right: 2rem;
      z-index: 100;
    }
    
    /* Sistema de Notificaciones Mejorado */
    .notification-container {
      position: relative;
      display: inline-block;
    }
    
    .notification-icon {
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      position: relative;
      animation: pulse 2s infinite;
    }
    
    .notification-icon:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      animation: none;
    }
    
    .notification-icon i {
      font-size: 1.3rem;
    }
    
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ff4757;
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 12px;
      min-width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4);
      animation: bounce 0.6s ease-in-out;
    }
    
    .notification-dropdown {
      position: absolute;
      top: 60px;
      right: 0;
      width: 380px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-20px) scale(0.95);
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border: 1px solid var(--gray);
    }
    
    .notification-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }
    
    .notification-header {
      padding: 20px;
      border-bottom: 1px solid var(--gray-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notification-header h6 {
      margin: 0;
      font-weight: 700;
      color: var(--text-dark);
      font-size: 1.1rem;
    }
    
    .notification-count {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .notification-list {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px 0;
    }
    
    .notification-item {
      padding: 15px 20px;
      border-bottom: 1px solid #f5f5f5;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .notification-item:hover {
      background: var(--gray-light);
    }
    
    .notification-item.unread {
      background: #fff7e6;
      border-left: 4px solid var(--warning);
    }
    
    .notification-item.security {
      border-left: 4px solid #ff4757;
    }
    
    .notification-content {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .notification-icon-small {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: white;
      flex-shrink: 0;
    }
    
    .notification-icon-small.security {
      background: linear-gradient(135deg, #ff4757, #ff3742);
    }
    
    .notification-icon-small.system {
      background: linear-gradient(135deg, #5352ed, #3742fa);
    }
    
    .notification-icon-small.success {
      background: linear-gradient(135deg, #2ed573, #1dd1a1);
    }
    
    .notification-text {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    
    .notification-message {
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    
    .notification-time {
      color: #999;
      font-size: 0.75rem;
    }
    
    .notification-footer {
      padding: 15px 20px;
      border-top: 1px solid var(--gray-light);
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }
    
    .notification-footer .btn {
      flex: 1;
      font-size: 0.85rem;
      padding: 8px 12px;
    }
    
    .empty-notifications {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .empty-notifications i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes bounce {
      0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
      40%, 43% { transform: translate3d(0,-8px,0); }
      70% { transform: translate3d(0,-4px,0); }
      90% { transform: translate3d(0,-2px,0); }
    }
    
    .notification-icon:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    .notification-icon i {
      font-size: 1.5rem;
      color: var(--primary);
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4757;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Estilos para notificaciones en el modal */
    .notification-item {
      padding: 1rem;
      border-bottom: 1px solid #eee;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .notification-item:last-child {
      border-bottom: none;
    }
    
    .notification-item:hover {
      background-color: #f8f9fa;
    }
    
    .notification-item.unread {
      background-color: #f0f8ff;
      border-left: 4px solid var(--primary);
    }
    
    .notification-title {
      font-weight: 600;
      color: var(--text-dark);
    }
    
    .notification-message {
      color: #666;
      font-size: 0.9rem;
    }
    
    .notification-icon {
      width: 40px;
      height: 40px;
      background: #f8f9fa;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .unread-indicator {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
    }
    .welcome-avatar {
      position: relative;
    }
    .profile-image {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .avatar-dashboard {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 4px solid white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      background-color: #f8f9fa;
    }
    
    .avatar-dashboard svg {
      width: 100px;
      height: 100px;
      display: block;
    }
    .welcome-status-indicator {
      position: absolute;
      bottom: 5px;
      right: 5px;
      width: 20px;
      height: 20px;
      background-color: #4caf50;
      border: 3px solid white;
      border-radius: 50%;
    }
    .welcome-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
    }
    .user-highlight {
      color: var(--primary);
      position: relative;
    }
    .welcome-subtitle {
      font-size: 1.1rem;
      color: #6c757d;
      max-width: 600px;
      line-height: 1.6;
    }
    .stats-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 30px;
  margin-top: 0px;
    }
    .stats-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
      max-width: 180px;
      height: 110px;
      margin: 0 auto;
    }
    .stats-card:hover {
      transform: translateY(-3px);
    }
    .stats-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    .stats-card.points .stats-icon {
      background: rgba(76, 175, 80, 0.1);
      color: var(--primary);
    }
    .stats-card.exchanges .stats-icon {
      background: rgba(33, 150, 243, 0.1);
      color: #2196f3;
    }
    .stats-card.level .stats-icon {
      background: rgba(255, 193, 7, 0.1);
      color: #ffc107;
    }
    .stats-content {
      flex: 1;
    }
    .stats-value {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.1rem;
      color: var(--text-dark);
      line-height: 1;
    }
    .stats-label {
      font-size: 0.7rem;
      color: #6c757d;
      margin: 0;
      line-height: 1.1;
    }
    .stats-trend {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      background: rgba(76, 175, 80, 0.1);
      color: var(--primary);
    }
    .stats-progress {
      position: relative;
    }
    .progress-ring {
      position: relative;
      width: 40px;
      height: 40px;
    }
    .progress-ring-circle {
      fill: none;
      stroke: var(--primary);
      stroke-width: 3;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      stroke-dasharray: 113;
      stroke-dashoffset: 28;
    }
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary);
    }
    .stats-next-level {
      margin-top: 1rem;
    }
    .stats-next-level p {
      font-size: 0.8rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
    }
    .stats-next-level .progress {
      height: 6px;
      background-color: rgba(0, 0, 0, 0.05);
      border-radius: 3px;
      overflow: hidden;
    }
    .stats-next-level .progress-bar {
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      border-radius: 3px;
    }

    
    /* Estilos para la nueva sección de nivel ecológico */
    .eco-level-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fffe 100%);
      border: 2px solid rgba(76, 175, 80, 0.1);
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }
    
    .level-badge-container {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .level-icon-wrapper {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .level-icon-wrapper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
      animation: shimmer 3s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }
    
    .level-icon {
      font-size: 2rem;
      z-index: 1;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }
    
    .level-info {
      flex: 1;
    }
    
    .level-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.2rem;
      background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .level-subtitle {
      font-size: 0.9rem;
      color: #6c757d;
      margin: 0;
    }
    
    .level-progress-section {
      background: rgba(76, 175, 80, 0.05);
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid rgba(76, 175, 80, 0.1);
    }
    
    .next-level-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
    }
    
    .next-level-text {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 0.9rem;
    }
    
    .points-needed {
      font-size: 0.8rem;
      color: #6c757d;
      background: rgba(255, 255, 255, 0.7);
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      border: 1px solid rgba(76, 175, 80, 0.2);
    }
    
    .progress-container {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .eco-progress {
      flex: 1;
      height: 8px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    
    .eco-progress-bar {
      background: linear-gradient(90deg, #4caf50 0%, #8bc34a 50%, #cddc39 100%);
      border-radius: 4px;
      position: relative;
      transition: width 0.8s ease;
    }
    
    .eco-progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%);
      animation: progress-shine 2s ease-in-out infinite;
    }
    
    @keyframes progress-shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .progress-text {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary);
      min-width: 35px;
      text-align: right;
    }
    
    .max-level-achieved {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .max-level-achieved i {
      font-size: 1.2rem;
      animation: trophy-glow 2s ease-in-out infinite;
    }
    
    @keyframes trophy-glow {
       0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
       50% { filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8)); }
     }
     
     /* Estilos para la sección de gráfica histórica */
     .historical-chart-section {
       background: white;
       border-radius: 20px;
       padding: 2rem;
       box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
       border: 1px solid rgba(76, 175, 80, 0.1);
     }
     
     .chart-container {
       background: rgba(248, 249, 250, 0.5);
       border-radius: 15px;
       padding: 1.5rem;
       border: 1px solid rgba(0, 0, 0, 0.05);
     }
     
     .chart-controls .btn-group .btn {
       border-radius: 20px;
       padding: 0.5rem 1rem;
       font-size: 0.85rem;
       font-weight: 500;
       transition: all 0.3s ease;
     }
     
     .chart-controls .btn-group .btn.active {
       background-color: var(--primary);
       border-color: var(--primary);
       color: white;
       transform: translateY(-1px);
       box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
     }
     
     .chart-wrapper {
       background: white;
       border-radius: 12px;
       padding: 1.5rem;
       box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
       position: relative;
       overflow: hidden;
     }
     
     .chart-wrapper::before {
       content: '';
       position: absolute;
       top: 0;
       left: 0;
       right: 0;
       height: 3px;
       background: linear-gradient(90deg, #4caf50 0%, #8bc34a 50%, #cddc39 100%);
     }
     
     .chart-stats {
       background: rgba(255, 255, 255, 0.8);
       border-radius: 12px;
       padding: 1rem;
       border: 1px solid rgba(76, 175, 80, 0.1);
     }
     
     .stat-item {
       display: flex;
       align-items: center;
       gap: 1rem;
       padding: 1rem;
       background: white;
       border-radius: 10px;
       box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
       transition: transform 0.3s ease;
       border: 1px solid rgba(0, 0, 0, 0.05);
     }
     
     .stat-item:hover {
       transform: translateY(-2px);
       box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
     }
     
     .stat-icon {
       width: 40px;
       height: 40px;
       border-radius: 50%;
       display: flex;
       align-items: center;
       justify-content: center;
       background: rgba(248, 249, 250, 0.8);
       font-size: 1.2rem;
     }
     
     .stat-info {
       flex: 1;
     }
     
     .stat-value {
       display: block;
       font-size: 1.5rem;
       font-weight: 700;
       color: var(--text-dark);
       line-height: 1;
     }
     
     .stat-label {
       display: block;
       font-size: 0.8rem;
       color: #6c757d;
       margin-top: 0.2rem;
     }

    @media (max-width: 768px) {
      .welcome-container {
        flex-direction: column;
        text-align: center;
        padding: 1.5rem;
      }
      .welcome-title {
        font-size: 2rem;
      }
      .stats-container {
        grid-template-columns: 1fr;
      }
      .stats-card {
        padding: 1rem;
      }
    }
    .activity-history-section {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    margin-top: 2rem;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.section-subtitle {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 0;
}

.activity-filters .form-select {
    border-radius: 20px;
    border: 1px solid var(--gray);
    padding: 0.5rem 2rem 0.5rem 1rem;
    font-size: 0.9rem;
    background-color: var(--gray-light);
}

.activity-cards {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.activity-card {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: var(--gray-light);
    border-radius: 15px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.activity-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.activity-icon {
    width: 45px;
    height: 45px;
    border-radius: 12px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
    color: var(--primary);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.activity-details {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.activity-info {
    flex: 1;
}

.activity-title {
    font-weight: 600;
    margin-bottom: 0.2rem;
    color: var(--text-dark);
}

.activity-date {
    font-size: 0.8rem;
    color: #6c757d;
}

.activity-status {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.activity-points {
    font-weight: 600;
    color: var(--primary);
    font-size: 1.1rem;
}

.activity-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.activity-badge.completado {
    background-color: rgba(76, 175, 80, 0.1);
    color: var(--success);
}

.activity-badge.pendiente {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.activity-badge.cancelado {
    background-color: rgba(244, 67, 54, 0.1);
    color: #f44336;
}

@media (max-width: 768px) {
    .activity-history-section {
        padding: 1.5rem;
    }

    .activity-details {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .activity-status {
        width: 100%;
        justify-content: space-between;
    }
     
}

    /* ============= MINI TOUR STYLES ============= */
    /* Ocultar el welcome-container cuando el tour esté activo */
    .welcome-container {
      display: none !important;
    }

    .welcome-tour-container {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      padding: 3rem;
      border-radius: 25px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      margin: 2rem 0;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(76, 175, 80, 0.2);
      z-index: 1000;
      width: 100%;
      max-width: 100%;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .welcome-tour-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(76, 175, 80, 0.05) 0%, transparent 70%);
      animation: tourGlow 4s ease-in-out infinite alternate;
    }

    @keyframes tourGlow {
      0% { transform: rotate(0deg) scale(1); }
      100% { transform: rotate(180deg) scale(1.1); }
    }

    .tour-card {
      display: none !important;
      text-align: center;
      animation: fadeInUp 0.6s ease;
      position: relative;
      z-index: 2;
      width: 100%;
      visibility: hidden;
    }

    .tour-card.active {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .tour-header {
      margin-bottom: 2rem;
    }

    .tour-icon {
      font-size: 4rem;
      color: var(--primary);
      margin-bottom: 1rem;
      display: block;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .tour-header h3 {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--text-dark);
      margin: 0;
      background: linear-gradient(45deg, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tour-content p {
      font-size: 1.1rem;
      color: #6c757d;
      line-height: 1.6;
      margin-bottom: 2rem;
    }

    .tour-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .feature-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 1.2rem;
      background: rgba(76, 175, 80, 0.1);
      border-radius: 15px;
      border: 2px solid rgba(76, 175, 80, 0.2);
      transition: all 0.3s ease;
    }

    .feature-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
      background: rgba(76, 175, 80, 0.15);
    }

    .feature-item i {
      font-size: 1.8rem;
      color: var(--primary);
    }

    .feature-item span {
      font-weight: 600;
      color: var(--text-dark);
    }

    .step-guide {
      max-width: 600px;
      margin: 0 auto;
    }

    .guide-step {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      text-align: left;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 20px;
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
    }

    .guide-step:hover {
      transform: translateX(10px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .step-number {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: 700;
      flex-shrink: 0;
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
    }

    .step-text h4 {
      margin-bottom: 0.5rem;
      color: var(--text-dark);
      font-weight: 600;
    }

    .step-text p {
      margin: 0;
      color: #6c757d;
      line-height: 1.5;
    }

    .rewards-preview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      margin: 2rem 0;
    }

    .reward-item {
      padding: 2rem;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border: 2px solid rgba(76, 175, 80, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .reward-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(76, 175, 80, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .reward-item:hover::before {
      left: 100%;
    }

    .reward-item:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px rgba(76, 175, 80, 0.2);
    }

    .reward-item i {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }

    .reward-item h4 {
      margin-bottom: 0.8rem;
      color: var(--text-dark);
      font-weight: 600;
    }

    .reward-item p {
      margin: 0;
      color: #6c757d;
      line-height: 1.5;
    }

    .tour-navigation {
      margin-top: 3rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .tour-navigation .btn {
      padding: 0.8rem 2rem;
      font-weight: 600;
      border-radius: 25px;
      font-size: 1rem;
      transition: all 0.3s ease;
      border: 2px solid;
    }

    .tour-navigation .btn-outline-secondary {
      color: #6c757d;
      border-color: #6c757d;
    }

    .tour-navigation .btn-outline-secondary:hover {
      background-color: #6c757d;
      color: white;
      transform: translateY(-2px);
    }

    .tour-navigation .btn-success {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-color: var(--primary);
      color: white;
    }

    .tour-navigation .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }

    .tour-progress {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }

    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #e0e0e0;
      transition: all 0.3s ease;
    }

    .progress-dot.active {
      background-color: var(--primary);
      transform: scale(1.2);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .welcome-tour-container {
        padding: 2rem 1.5rem;
        margin: 1rem 0;
      }
      
      .tour-header h3 {
        font-size: 1.8rem;
      }
      
      .tour-icon {
        font-size: 3rem;
      }
      
      .tour-features {
        grid-template-columns: 1fr;
      }
      
      .guide-step {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }
      
      .step-number {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
      }
      
      .rewards-preview {
        grid-template-columns: 1fr;
      }
      
      .tour-navigation {
        flex-direction: column;
        align-items: center;
      }
      
      .tour-navigation .btn {
        width: 100%;
        max-width: 250px;
      }
    }
    /* ============= END MINI TOUR STYLES ============= */

    /* === SISTEMA DE PERSONALIZACIÓN DEL DASHBOARD === */
    
    /* Panel de Configuración */
    .dashboard-config {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: -5px 0 20px rgba(0,0,0,0.3);
        transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        z-index: 9999;
        overflow-y: auto;
    }

    .dashboard-config.active {
        right: 0;
    }

    .config-header {
        padding: 20px;
        background: rgba(255,255,255,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.2);
        color: white;
    }

    .config-header h3 {
        margin: 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .config-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background 0.3s;
    }

    .config-close:hover {
        background: rgba(255,255,255,0.2);
    }

    .config-section {
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .config-section h4 {
        color: white;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 500;
    }

    /* Selector de Temas */
    .theme-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .theme-option {
        border: 2px solid transparent;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .theme-option.active {
        border-color: #ffd700;
        transform: scale(1.05);
    }

    .theme-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0.8;
        border-radius: 8px;
    }

    .theme-option.light::before {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    }

    .theme-option.dark::before {
        background: linear-gradient(135deg, #2c3e50, #34495e);
    }

    .theme-option.eco::before {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
    }

    .theme-option.sunset::before {
        background: linear-gradient(135deg, #ff7675, #fd79a8);
    }

    .theme-option .theme-name {
        position: relative;
        z-index: 1;
        color: white;
        font-weight: 500;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    /* Widget Draggable */
    .dashboard-widget {
        position: relative;
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: move;
        border: 2px dashed transparent;
    }

    .dashboard-widget.dragging {
        transform: rotate(5deg) scale(1.05);
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border-color: var(--bs-primary);
        opacity: 0.8;
        z-index: 1000;
    }

    .dashboard-widget .widget-handle {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.1);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: move;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .dashboard-widget:hover .widget-handle {
        opacity: 1;
    }

    .widget-handle i {
        color: #666;
        font-size: 14px;
    }

    /* Dropzone para widgets */
    .widget-dropzone {
        min-height: 200px;
        border: 2px dashed #ddd;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        transition: all 0.3s;
        position: relative;
    }

    .widget-dropzone.drag-over {
        border-color: var(--bs-primary);
        background: rgba(13, 110, 253, 0.05);
        transform: scale(1.02);
    }

    .widget-dropzone.empty {
        opacity: 0.6;
    }

    .widget-dropzone.empty::after {
        content: 'Arrastra widgets aquí';
        color: #666;
        font-style: italic;
    }

    /* Configuración de Layout */
    .layout-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .layout-option {
        flex: 1;
        min-width: 80px;
        height: 60px;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(255,255,255,0.1);
    }

    .layout-option.active {
        border-color: #ffd700;
        background: rgba(255,215,0,0.2);
    }

    .layout-option i {
        font-size: 24px;
        color: white;
    }

    /* Configuración de Widgets */
    .widget-toggles {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .widget-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        color: white;
    }

    .widget-toggle label {
        margin: 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .widget-toggle input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: #ffd700;
    }

    /* Botón de configuración flotante */
    .config-trigger {
        position: fixed;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        transition: all 0.3s;
        z-index: 1000;
    }

    .config-trigger:hover {
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
    }

    .config-trigger.active {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: translateY(-50%) rotate(180deg);
    }

    /* Overlay para cerrar panel */
    .config-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }

    .config-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    /* Temas del Dashboard */
    body.theme-light {
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --border-color: #dee2e6;
    }

    body.theme-dark {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --text-primary: #ffffff;
        --text-secondary: #b3b3b3;
        --border-color: #404040;
    }

    body.theme-dark .card {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    body.theme-dark .navbar {
        background: var(--bg-secondary) !important;
    }

    body.theme-eco {
        --bg-primary: #f1f8e9;
        --bg-secondary: #e8f5e8;
        --text-primary: #2e7d32;
        --text-secondary: #4caf50;
        --accent-color: #66bb6a;
    }

    body.theme-eco .card {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid #c8e6c9;
    }

    body.theme-sunset {
        --bg-primary: #fff3e0;
        --bg-secondary: #ffe0b2;
        --text-primary: #e65100;
        --text-secondary: #ff9800;
        --accent-color: #ffb74d;
    }

    body.theme-sunset .card {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid #ffcc02;
    }

    /* Efectos de transición para cambios de tema */
    .dashboard-content * {
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    /* Responsive para panel de configuración */
    @media (max-width: 768px) {
        .dashboard-config {
            width: 100%;
            right: -100%;
        }
        
        .config-trigger {
            right: 15px;
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
        
        .theme-selector {
            grid-template-columns: 1fr;
        }
    }

    /* === FIN SISTEMA DE PERSONALIZACIÓN === */

    /* Animaciones adicionales para personalización */
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    /* Efectos cuando las animaciones están deshabilitadas */
    body.no-animations * {
        animation: none !important;
        transition: none !important;
    }

    /* Layout específicos */
    .main-content.layout-compact {
        padding: 15px;
    }

    .main-content.layout-compact .row {
        margin: 0 -7.5px;
    }

    .main-content.layout-compact .col-lg-4,
    .main-content.layout-compact .col-md-6 {
        padding: 0 7.5px;
    }

    .main-content.layout-wide {
        padding: 30px 50px;
    }

    .main-content.layout-wide .container-fluid {
        max-width: none;
    }

    /* Estados de widgets ocultos */
    .widget-hidden {
        display: none !important;
    }

    /* Indicador de configuración activa */
    .config-trigger.pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }
        50% {
            box-shadow: 0 8px 40px rgba(102, 126, 234, 0.8);
        }
        100% {
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }
    }

    /* Botón de Analytics */
    .analytics-trigger {
        position: fixed;
        top: calc(50% + 80px);
        right: 20px;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        color: white;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        transition: all 0.3s;
        z-index: 999;
    }

    .analytics-trigger:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(231, 76, 60, 0.6);
    }

  </style>\n  \n  <!-- Mejoras responsive adicionales -->\n  <style>\n    @media (max-width: 768px) {\n      .chart-stats .stat-item {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        text-align: center;\n        padding: 12px;\n        background: #f8f9fa;\n        border-radius: 8px;\n        margin-bottom: 10px;\n        border: 1px solid #e9ecef;\n      }\n      \n      .legendary-level-card {\n        max-width: none !important;\n        height: auto !important;\n        padding: 25px 20px !important;\n        font-size: 1rem !important;\n        margin-bottom: 20px;\n      }\n      \n      .recent-activity-container {\n        padding: 15px;\n        margin-bottom: 20px;\n      }\n      \n      .activity-item {\n        flex-direction: row;\n        align-items: center;\n        padding: 12px;\n        margin-bottom: 8px;\n        border-radius: 8px;\n        background: #fff;\n        border: 1px solid #e9ecef;\n      }\n      \n      .activity-content {\n        flex: 1;\n        margin: 0 10px;\n      }\n      \n      .activity-title {\n        font-size: 0.9rem;\n        font-weight: 600;\n        margin-bottom: 2px;\n      }\n      \n      .activity-subtitle {\n        font-size: 0.8rem;\n        color: #666;\n      }\n    }\n    \n    @media (max-width: 480px) {\n      .chart-wrapper {\n        overflow-x: auto;\n        padding-bottom: 10px;\n      }\n      \n      .btn-group .btn {\n        font-size: 0.8rem;\n        padding: 6px 10px;\n        margin: 2px;\n      }\n      \n      .btn-group {\n        flex-wrap: wrap;\n        justify-content: center;\n      }\n      \n      .activity-item {\n        flex-direction: column;\n        align-items: flex-start;\n        text-align: left;\n      }\n      \n      .activity-content {\n        margin: 0;\n        width: 100%;\n      }\n      \n      .activity-points {\n        align-self: flex-end;\n        margin-top: 10px;\n      }\n    }\n  </style>\n</head>\n<body>\n  <!-- Mobile Navigation Toggle -->\n  <button class=\"mobile-nav-toggle\" id=\"mobileNavToggle\">\n    <i class=\"fas fa-bars\"></i>\n  </button>\n  \n  <!-- Sidebar Backdrop -->\n  <div class=\"sidebar-backdrop\" id=\"sidebarBackdrop\"></div>\n  \n  <!-- CSRF Token for AJAX requests -->\n  {% csrf_token %}
</head>\n\n<!-- Mejoras de responsive adicionales -->\n<style>\n  @media (max-width: 768px) {\n    .chart-stats .stat-item {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      text-align: center;\n      padding: 12px;\n      background: #f8f9fa;\n      border-radius: 8px;\n      margin-bottom: 10px;\n      border: 1px solid #e9ecef;\n    }\n    \n    .legendary-level-card {\n      max-width: none !important;\n      height: auto !important;\n      padding: 25px 20px !important;\n      font-size: 1rem !important;\n      margin-bottom: 20px;\n    }\n    \n    .legendary-background {\n      max-width: none;\n      height: auto;\n      padding: 25px 20px;\n    }\n    \n    .recent-activity-container {\n      padding: 15px;\n      margin-bottom: 20px;\n    }\n    \n    .activity-item {\n      flex-direction: row;\n      align-items: center;\n      padding: 12px;\n      margin-bottom: 8px;\n      border-radius: 8px;\n      background: #fff;\n      border: 1px solid #e9ecef;\n    }\n    \n    .activity-content {\n      flex: 1;\n      margin: 0 10px;\n    }\n    \n    .activity-title {\n      font-size: 0.9rem;\n      font-weight: 600;\n      margin-bottom: 2px;\n    }\n    \n    .activity-subtitle {\n      font-size: 0.8rem;\n      color: #666;\n    }\n  }\n  \n  @media (max-width: 480px) {\n    .chart-wrapper {\n      overflow-x: auto;\n      padding-bottom: 10px;\n    }\n    \n    .btn-group .btn {\n      font-size: 0.8rem;\n      padding: 6px 10px;\n      margin: 2px;\n    }\n    \n    .btn-group {\n      flex-wrap: wrap;\n      justify-content: center;\n    }\n    \n    .quick-action-cta .btn {\n      font-size: 0.9rem;\n      padding: 8px 15px;\n    }\n    \n    .objective-name {\n      font-size: 0.9rem;\n    }\n    \n    .objective-progress span {\n      font-size: 0.8rem;\n    }\n    \n    .objective-remaining {\n      font-size: 0.75rem;\n    }\n    \n    .activity-item {\n      flex-direction: column;\n      align-items: flex-start;\n      text-align: left;\n    }\n    \n    .activity-icon {\n      width: 35px;\n      height: 35px;\n      font-size: 1rem;\n      margin-bottom: 8px;\n    }\n    \n    .activity-content {\n      margin: 0;\n      width: 100%;\n    }\n    \n    .activity-points {\n      align-self: flex-end;\n      margin-top: 10px;\n    }\n  }\n</style>
<body>
  <!-- Mobile Navigation Toggle -->
  <button class="mobile-nav-toggle" id="mobileNavToggle">
    <i class="fas fa-bars"></i>
  </button>
  
  <!-- Sidebar Backdrop -->
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
  <!-- CSRF Token for AJAX requests -->
  {% csrf_token %}
  
  <!-- Sidebar Simplificado -->
  {% include 'core/components/sidebar_usuario_simplificado.html' %}

  <!-- Main Content -->
  <div class="main-content">
        <div class="page-header animate__animated animate__fadeIn">
          <div class="welcome-container">
            <div class="welcome-avatar">
              {% if user.foto_perfil %}
                <img src="{{ user.foto_perfil.url }}?v={{ user.last_login|date:'U'|default:'0' }}" alt="Foto de perfil" class="profile-image">
              {% else %}
                <div class="profile-image avatar-dashboard">
                  {{ user.get_avatar_svg|safe }}
                </div>
              {% endif %}
              <div class="welcome-status-indicator"></div>
            </div>
            <div class="welcome-text">
              <h1 class="welcome-title">¡Hola, <span class="user-highlight">{{ user.username }}</span>! 👋</h1>
              <p class="welcome-subtitle">Bienvenido a tu panel de control. Aquí puedes gestionar tus puntos, explorar categorías de reciclaje y revisar tu actividad.</p>
            </div>
            <div class="header-actions">
              <!-- Campana de Notificaciones -->
              <div class="notification-container">
                <div class="notification-icon" id="notificationIcon">
                  <i class="fas fa-bell"></i>
                  <span class="notification-badge" id="notificationBadge">0</span>
                </div>
                
                <!-- Dropdown de notificaciones -->
                <div class="notification-dropdown" id="notificationDropdown">
                  <div class="notification-header">
                    <h6>Notificaciones</h6>
                    <span class="notification-count" id="notificationCount">0 nuevas</span>
                  </div>
                  <div class="notification-list" id="notificationList">
                    <!-- Las notificaciones se cargan dinámicamente -->
                  </div>
                  <div class="notification-footer">
                    <button class="btn btn-sm btn-outline-secondary" id="markAllRead">
                      <i class="fas fa-check me-1"></i>Marcar todas
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </div>

          <div class="stats-container">
            <!-- MINI TOUR INTERACTIVO -->
            <div id="miniTour" style="position: relative; background: linear-gradient(135deg, #4caf50, #2e7d32); border-radius: 25px; padding: 40px 30px; color: white; width: 100%; margin: 0 auto 20px auto; box-shadow: 0 15px 50px rgba(0,0,0,0.4); min-height: 300px;">
                <!-- Paso 1: Bienvenida Personalizada -->
                <div id="step1">
                    <h4 style="font-size: 2rem; margin-bottom: 25px; font-weight: 700;"><i class="fas fa-seedling me-3"></i>¡Bienvenido a EcoPuntos, {{ user.first_name|default:user.username }}!</h4>
                    <p style="font-size: 1.4rem; margin-bottom: 20px; line-height: 1.5; font-weight: 600;">🎉 Tienes <span style="color: #ffeb3b; font-size: 1.6rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">{{ user.puntos }}</span> puntos acumulados</p>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 1.5rem; margin: 1.5rem 0;">
                        <p style="font-size: 1.2rem; margin-bottom: 15px; font-weight: 600;">🌍 Tu plataforma de reciclaje inteligente:</p>
                        <div style="font-size: 1.1rem; line-height: 1.6;">
                            ✨ <strong>Convierte residuos</strong> en recompensas increíbles<br>
                            🌱 <strong>Salva el planeta</strong> una acción a la vez<br>
                            🎁 <strong>Desbloquea productos</strong> y experiencias únicas
                        </div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button onclick="skipTour()" class="btn btn-light" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; border-radius: 25px;">
                            <i class="fas fa-forward me-2"></i>Saltar
                        </button>
                        <button onclick="nextStep()" class="btn btn-success" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; border-radius: 25px; background: linear-gradient(135deg, #66bb6a, #4caf50);">
                            <i class="fas fa-arrow-right me-2"></i>¡Comenzar!
                        </button>
                    </div>
                </div>

                <!-- Paso 2: Cómo ganar puntos (Mejorado) -->
                <div id="step2" style="display: none;">
                    <h4 style="font-size: 2rem; margin-bottom: 25px; font-weight: 700;"><i class="fas fa-coins me-3" style="color: #ffd700;"></i>¡Gana Puntos Como Un Pro!</h4>
                    <p style="font-size: 1.3rem; margin-bottom: 20px; line-height: 1.4;">💰 <strong>Cada material vale puntos reales:</strong></p>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 1.5rem; margin: 1.5rem 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 1.1rem; line-height: 1.6;">
                            <div>📄 <strong>Papel:</strong> <span style="color: #ffeb3b;">10 pts/kg</span></div>
                            <div>🥤 <strong>Plástico:</strong> <span style="color: #ffeb3b;">15 pts/kg</span></div>
                            <div>🍾 <strong>Vidrio:</strong> <span style="color: #ffeb3b;">12 pts/kg</span></div>
                            <div>🔧 <strong>Metal:</strong> <span style="color: #ffeb3b;">20 pts/kg</span></div>
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2);">
                            📱 <strong>Electrónicos:</strong> <span style="color: #4fc3f7;">Puntos variables</span> según dispositivo
                        </div>
                    </div>
                    <p style="font-size: 1.1rem; text-align: center; opacity: 0.9;">
                        🎯 <strong>Proceso súper fácil:</strong> Selecciona → Pesa → ¡Gana!
                    </p>
                    <div class="d-flex justify-content-between">
                        <button onclick="prevStep()" class="btn btn-light" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; border-radius: 25px;">
                            <i class="fas fa-arrow-left me-2"></i>Anterior
                        </button>
                        <button onclick="nextStep()" class="btn btn-success" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; border-radius: 25px; background: linear-gradient(135deg, #66bb6a, #4caf50);">
                            <i class="fas fa-arrow-right me-2"></i>Siguiente
                        </button>
                    </div>
                </div>

                <!-- Paso 3: Navegación Súper Intuitiva -->
                <div id="step3" style="display: none;">
                    <h4 style="font-size: 2rem; margin-bottom: 25px; font-weight: 700;"><i class="fas fa-map me-3" style="color: #42a5f5;"></i>Navega Como Un Experto</h4>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 1.5rem; margin: 1.5rem 0;">
                        <div style="display: grid; gap: 1rem; font-size: 1.1rem; line-height: 1.6;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-tachometer-alt" style="color: #ffeb3b; font-size: 1.3rem; width: 25px;"></i>
                                <div><strong>Dashboard:</strong> Tu centro de comando personal</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-plus-circle" style="color: #4caf50; font-size: 1.3rem; width: 25px;"></i>
                                <div><strong>Registrar:</strong> Agrega materiales y gana al instante</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-user-circle" style="color: #ff7043; font-size: 1.3rem; width: 25px;"></i>
                                <div><strong>Mi Cuenta:</strong> Personaliza tu experiencia</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-chart-bar" style="color: #ab47bc; font-size: 1.3rem; width: 25px;"></i>
                                <div><strong>Estadísticas:</strong> Visualiza tu impacto ambiental</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-headset" style="color: #26c6da; font-size: 1.3rem; width: 25px;"></i>
                                <div><strong>Soporte 24/7:</strong> Ayuda siempre disponible</div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button onclick="prevStep()" class="btn btn-light" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; border-radius: 25px;">
                            <i class="fas fa-arrow-left me-2"></i>Anterior
                        </button>
                        <button onclick="nextStep()" class="btn btn-success" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; border-radius: 25px; background: linear-gradient(135deg, #66bb6a, #4caf50);">
                            <i class="fas fa-arrow-right me-2"></i>Siguiente
                        </button>
                    </div>
                </div>

                <!-- Paso 4: Recompensas Increíbles -->
                <div id="step4" style="display: none;">
                    <h4 style="font-size: 2rem; margin-bottom: 25px; font-weight: 700;"><i class="fas fa-gift me-3" style="color: #ff6b6b;"></i>¡Recompensas Increíbles Te Esperan!</h4>
                    <p style="font-size: 1.3rem; margin-bottom: 20px; text-align: center; font-weight: 600;">🎁 <span style="color: #ffeb3b;">Canjea tus puntos</span> por productos reales</p>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 1.5rem; margin: 1.5rem 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; font-size: 1rem;">
                            <div style="text-align: center;">
                                <i class="fas fa-headphones" style="font-size: 2rem; color: #42a5f5; margin-bottom: 0.5rem;"></i>
                                <div><strong>Tecnología</strong></div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Auriculares, smartwatch, cargadores</div>
                            </div>
                            <div style="text-align: center;">
                                <i class="fas fa-leaf" style="font-size: 2rem; color: #66bb6a; margin-bottom: 0.5rem;"></i>
                                <div><strong>Eco-Productos</strong></div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Botellas térmicas, plantas</div>
                            </div>
                            <div style="text-align: center;">
                                <i class="fas fa-home" style="font-size: 2rem; color: #ff7043; margin-bottom: 0.5rem;"></i>
                                <div><strong>Hogar</strong></div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Macetas inteligentes, decoración</div>
                            </div>
                            <div style="text-align: center;">
                                <i class="fas fa-dumbbell" style="font-size: 2rem; color: #ab47bc; margin-bottom: 0.5rem;"></i>
                                <div><strong>Deportes</strong></div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Yoga mats, botellas deportivas</div>
                            </div>
                        </div>
                    </div>
                    <p style="text-align: center; font-size: 1.1rem; opacity: 0.9;">
                        💳 <strong>¡Nuevos productos cada semana!</strong>
                    </p>
                    <div class="d-flex justify-content-between">
                        <button onclick="prevStep()" class="btn btn-light" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; border-radius: 25px;">
                            <i class="fas fa-arrow-left me-2"></i>Anterior
                        </button>
                        <button onclick="nextStep()" class="btn btn-success" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; border-radius: 25px; background: linear-gradient(135deg, #66bb6a, #4caf50);">
                            <i class="fas fa-arrow-right me-2"></i>Siguiente
                        </button>
                    </div>
                </div>

                <!-- Paso 5: Comunidad y Soporte Épico -->
                <div id="step5" style="display: none;">
                    <h4 style="font-size: 2rem; margin-bottom: 25px; font-weight: 700;"><i class="fas fa-users me-3" style="color: #26c6da;"></i>¡Únete a la Comunidad EcoPuntos!</h4>
                    <p style="font-size: 1.3rem; margin-bottom: 20px; text-align: center; font-weight: 600;">🌍 <span style="color: #ffeb3b;">Nunca estarás solo</span> en tu misión ecológica</p>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 1.5rem; margin: 1.5rem 0;">
                        <div style="display: grid; gap: 1.2rem; font-size: 1.1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-comments" style="color: #4fc3f7; font-size: 1.5rem; width: 30px;"></i>
                                <div><strong>Chat 24/7:</strong> Soporte instantáneo siempre disponible</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-chart-line" style="color: #66bb6a; font-size: 1.5rem; width: 30px;"></i>
                                <div><strong>Seguimiento Personal:</strong> Visualiza tu impacto real</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-bell" style="color: #ffca28; font-size: 1.5rem; width: 30px;"></i>
                                <div><strong>Alertas Inteligentes:</strong> No te pierdas ninguna oportunidad</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-globe" style="color: #42a5f5; font-size: 1.5rem; width: 30px;"></i>
                                <div><strong>Comunidad Global:</strong> Miles de eco-warriors como tú</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-medal" style="color: #ff7043; font-size: 1.5rem; width: 30px;"></i>
                                <div><strong>Logros Épicos:</strong> Medallas que muestran tu compromiso</div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; background: rgba(255,215,0,0.2); border-radius: 10px; padding: 1rem; margin: 1rem 0;">
                        <p style="font-size: 1.1rem; margin: 0; font-weight: 600;">
                            🏆 <span style="color: #ffd700;">¡Cada acción cuenta para salvar nuestro planeta!</span>
                        </p>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button onclick="prevStep()" class="btn btn-light" style="padding: 15px 30px; font-size: 1.1rem; font-weight: 600; border-radius: 25px;">
                            <i class="fas fa-arrow-left me-2"></i>Anterior
                        </button>
                        <button onclick="finishTour()" class="btn btn-warning" style="padding: 15px 30px; font-size: 1.2rem; font-weight: 700; border-radius: 25px; background: linear-gradient(135deg, #ffd54f, #ffb300); color: #2e7d32; border: none; box-shadow: 0 5px 15px rgba(255,193,7,0.4);">
                            <i class="fas fa-rocket me-2"></i>¡COMENZAR AHORA!
                        </button>
                    </div>
                </div>

                <!-- Indicadores de paso -->
                <div class="text-center mt-5">
                    <span id="dot1" style="height: 15px; width: 15px; margin: 0 8px; background: white; border-radius: 50%; display: inline-block; transition: all 0.3s ease;"></span>
                    <span id="dot2" style="height: 15px; width: 15px; margin: 0 8px; background: rgba(255,255,255,0.5); border-radius: 50%; display: inline-block; transition: all 0.3s ease;"></span>
                    <span id="dot3" style="height: 15px; width: 15px; margin: 0 8px; background: rgba(255,255,255,0.5); border-radius: 50%; display: inline-block; transition: all 0.3s ease;"></span>
                    <span id="dot4" style="height: 15px; width: 15px; margin: 0 8px; background: rgba(255,255,255,0.5); border-radius: 50%; display: inline-block; transition: all 0.3s ease;"></span>
                    <span id="dot5" style="height: 15px; width: 15px; margin: 0 8px; background: rgba(255,255,255,0.5); border-radius: 50%; display: inline-block; transition: all 0.3s ease;"></span>
                </div>
            </div>

          </div>
    </div>
        
        <!-- Games and Quick Actions Section (70% - 30%) -->
        <div class="row mb-5">
            <!-- 70% - Juegos Educativos -->
            <div class="col-lg-8">
                <div class="section-header mb-4 animate__animated animate__fadeInUp">
                    <h2><i class="fas fa-gamepad me-2" style="color: var(--primary)"></i>Aprende Jugando</h2>
                    <p>Mejora tus conocimientos sobre reciclaje y gana puntos educativos mientras te diviertes.</p>
                </div>
                
                <div class="row g-3">
                    <!-- Juego Plásticos -->
                    <div class="col-md-6">
                        <div class="game-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                            <div class="game-header">
                                <div class="game-icon" style="background: linear-gradient(135deg, #e91e63, #ad1457);">
                                    <i class="fas fa-bottle-water"></i>
                                </div>
                                <div class="game-badge">
                                    <span class="points-value">{{ user.puntos_juego }}</span>
                                    <span class="points-unit">pts</span>
                                </div>
                            </div>
                            <div class="game-body">
                                <h5 class="game-title">Plásticos</h5>
                                <p class="game-description">Clasifica diferentes tipos de plásticos</p>
                                <div class="game-progress">
                                    <div class="progress-bar" style="width: {% if user.puntos_juego > 0 and max_puntos_juego %}{% widthratio user.puntos_juego max_puntos_juego 100 %}{% else %}5{% endif %}%;"></div>
                                    <div class="progress-bar" data-width="{% if user.puntos_juego > 0 %}{% widthratio user.puntos_juego 100 100 %}{% else %}5{% endif %}"></div>
                                </div>
                                <a href="{% url 'juego_plasticos' %}" class="btn btn-game">
                                    <i class="fas fa-play me-2"></i>Jugar Ahora
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Juego Vidrios -->
                    <div class="col-md-6">
                        <div class="game-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                            <div class="game-header">
                                <div class="game-icon" style="background: linear-gradient(135deg, #00bcd4, #0097a7);">
                                    <i class="fas fa-wine-glass-alt"></i>
                                </div>
                                <div class="game-badge">
                                    <span class="points-value">{{ user.puntos_juego_vidrios }}</span>
                                    <span class="points-unit">pts</span>
                                </div>
                            </div>
                            <div class="game-body">
                                <h5 class="game-title">Vidrios</h5>
                                <p class="game-description">Identifica y clasifica vidrios correctamente</p>
                                <div class="game-progress">
                                    <div class="progress-bar" data-width="{% if user.puntos_juego_vidrios > 0 %}{% widthratio user.puntos_juego_vidrios 100 100 %}{% else %}5{% endif %}"></div>
                                </div>
                                <a href="{% url 'juego_vidrios' %}" class="btn btn-game">
                                    <i class="fas fa-play me-2"></i>Jugar Ahora
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Juego Papel -->
                    <div class="col-md-6">
                        <div class="game-card animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
                            <div class="game-header">
                                <div class="game-icon" style="background: linear-gradient(135deg, #795548, #5d4037);">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="game-badge">
                                    <span class="points-value">{{ user.puntos_juego_papel }}</span>
                                    <span class="points-unit">pts</span>
                                </div>
                            </div>
                            <div class="game-body">
                                <h5 class="game-title">Papel y Cartón</h5>
                                <p class="game-description">Aprende sobre papel y cartón reciclable</p>
                                <div class="game-progress">
                                    <div class="progress-bar" data-width="{% if user.puntos_juego_papel > 0 %}{% widthratio user.puntos_juego_papel 100 100 %}{% else %}5{% endif %}"></div>
                                </div>
                                <a href="{% url 'juego_papel' %}" class="btn btn-game">
                                    <i class="fas fa-play me-2"></i>Jugar Ahora
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Juego Metales -->
                    <div class="col-md-6">
                        <div class="game-card animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
                            <div class="game-header">
                                <div class="game-icon" style="background: linear-gradient(135deg, #607d8b, #455a64);">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <div class="game-badge">
                                    <span class="points-value">{{ user.puntos_juego_metales }}</span>
                                    <span class="points-unit">pts</span>
                                </div>
                            </div>
                            <div class="game-body">
                                <h5 class="game-title">Metales</h5>
                                <p class="game-description">Clasifica diferentes tipos de metales</p>
                                <div class="game-progress">
                                    <div class="progress-bar" data-width="{% if user.puntos_juego_metales > 0 %}{% widthratio user.puntos_juego_metales 100 100 %}{% else %}5{% endif %}"></div>
                                </div>
                                <a href="{% url 'juego_metales' %}" class="btn btn-game">
                                    <i class="fas fa-play me-2"></i>Jugar Ahora
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 30% - Acciones Rápidas -->
            <div class="col-lg-4">
                <div class="section-header mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                    <h2><i class="fas fa-bolt me-2" style="color: var(--accent)"></i>Acciones Rápidas</h2>
                    <p>Accesos directos para una mejor experiencia</p>
                </div>
                
                <div class="quick-actions-container">
                    <!-- Registrar Canje -->
                    <div class="quick-action-card animate__animated animate__fadeInRight" style="animation-delay: 0.3s;">
                        <div class="action-icon" style="background: linear-gradient(135deg, var(--success), #4caf50);">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                        <div class="action-content">
                            <h6>Registrar Canje</h6>
                            <p>Agrega un nuevo material reciclado</p>
                        </div>
                        <a href="{% url 'canjes' %}" class="action-btn">
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                    
                    <!-- Ver Recompensas -->
                    <div class="quick-action-card animate__animated animate__fadeInRight" style="animation-delay: 0.4s;">
                        <div class="action-icon" style="background: linear-gradient(135deg, var(--warning), #ff9800);">
                            <i class="fas fa-gift"></i>
                        </div>
                        <div class="action-content">
                            <h6>Explorar Recompensas</h6>
                            <p>Canjea tus puntos por premios</p>
                        </div>
                        <a href="{% url 'recompensas' %}" class="action-btn">
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                    
                    <!-- Ver Ranking -->
                    <div class="quick-action-card animate__animated animate__fadeInRight" style="animation-delay: 0.5s;">
                        <div class="action-icon" style="background: linear-gradient(135deg, var(--info), #2196f3);">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="action-content">
                            <h6>Ranking Global</h6>
                            <p>Ve tu posición entre usuarios</p>
                        </div>
                        <a href="{% url 'ranking' %}" class="action-btn">
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                    
                    <!-- Mi Progreso -->
                    <div class="quick-action-card animate__animated animate__fadeInRight" style="animation-delay: 0.6s;">
                        <div class="action-icon" style="background: linear-gradient(135deg, var(--primary), #388e3c);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="action-content">
                            <h6>Mi Progreso</h6>
                            <p>Revisa tus estadísticas</p>
                        </div>
                        <a href="{% url 'historial' %}" class="action-btn">
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Historical Data Chart Section -->
        <div class="historical-chart-section animate__animated animate__fadeIn mb-5">
            <div class="section-header mb-4">
                <h2 class="section-title"><i class="fas fa-chart-line me-2" style="color: var(--primary)"></i>Progreso Histórico</h2>
                <p class="section-subtitle">Visualiza tu evolución ecológica a lo largo del tiempo</p>
            </div>
            
            <div class="chart-container">
                <div class="chart-controls mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm active" data-period="7">7 días</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-period="30">30 días</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-period="90">3 meses</button>
                    </div>
                </div>
                
                <div class="chart-wrapper">
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
                
                <div class="chart-stats mt-3">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-arrow-up" style="color: #4caf50;"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="totalPoints">{{ user.puntos }}</span>
                                    <span class="stat-label">Puntos Totales</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-calendar-week" style="color: #2196f3;"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="weeklyAvg">0</span>
                                    <span class="stat-label">Promedio Semanal</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-trophy" style="color: #ffd700;"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value" id="bestDay">0</span>
                                    <span class="stat-label">Mejor Día</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <!-- Sección de Próximo Objetivo y Acción Rápida - Ancho Completo -->
    <div class="row mb-4">
        <!-- Próximo Objetivo - Izquierda -->
        <div class="col-md-6">
            <div class="quick-stat-card animate__animated animate__fadeInLeft h-100" style="animation-delay: 0.2s;">
                <div class="stat-header">
                    <i class="fas fa-target"></i>
                    <h5>Próximo Objetivo</h5>
                </div>
                <div class="stat-content">
                    {% if next_reward %}
                        <div class="objective-item">
                            <div class="objective-name">{{ next_reward.nombre }}</div>
                            <div class="objective-progress">
                                <span>{{ user.puntos }} / {{ next_reward.puntos_requeridos }}</span>
                                <div class="progress-bar-mini">
                                    <div class="progress-fill" data-width="{% widthratio user.puntos next_reward.puntos_requeridos 100 %}"></div>
                                </div>
                            </div>
                            <div class="objective-remaining">
                                Faltan {{ next_reward_points_remaining }} puntos
                            </div>
                        </div>
                    {% else %}
                        <div class="objective-item">
                            <div class="objective-name">Nivel Eco Héroe</div>
                            <div class="objective-progress">
                                <span>{{ user.puntos }} / 1000</span>
                                <div class="progress-bar-mini">
                                    <div class="progress-fill" data-width="{% widthratio user.puntos 1000 100 %}"></div>
                                </div>
                            </div>
                            <div class="objective-remaining">
                                Faltan 0 puntos
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Acción Rápida - Derecha -->
        <div class="col-md-6">
            <div class="quick-action-cta animate__animated animate__fadeInRight h-100" style="animation-delay: 0.3s;">
                <div class="cta-content">
                    <h6><i class="fas fa-plus-circle me-2"></i>¿Tienes Material para Reciclar?</h6>
                    <p>Registra tu canje y gana puntos al instante</p>
                    <a href="{% url 'canjes' %}" class="btn btn-success btn-sm">
                        <i class="fas fa-recycle me-2"></i>Registrar Ahora
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Centro de Actividad Reciente -->
    <div class="section-header mt-5 animate__animated animate__fadeInRight">
        <h2 style="color: var(--primary);"><i class="fas fa-bolt me-2"></i>Actividad Reciente</h2>
        <p>Mantente al día con tus últimas acciones y logros en EcoPuntos.</p>
    </div>
    
    <div class="row">
        <!-- Columna Principal - Actividades -->
        <div class="col-lg-8 mb-4">
            <div class="recent-activity-container">
                <!-- Actividad Real del Usuario -->
                {% if recent_activities %}
                    {% for activity in recent_activities|slice:":5" %}
                    <div class="activity-item animate__animated animate__fadeInUp" style="animation-delay: {{ forloop.counter0|floatformat:1|add:'0.1' }}s;">
                        <div class="activity-icon {{ activity.tipo|lower }}">
                            {% if activity.tipo == 'canje' %}
                                <i class="fas fa-recycle"></i>
                            {% elif activity.tipo == 'recompensa' %}
                                <i class="fas fa-gift"></i>
                            {% elif activity.tipo == 'juego' %}
                                <i class="fas fa-gamepad"></i>
                            {% elif activity.tipo == 'logro' %}
                                <i class="fas fa-trophy"></i>
                            {% else %}
                                <i class="fas fa-check-circle"></i>
                            {% endif %}
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">{{ activity.descripcion }}</div>
                            <div class="activity-subtitle">{{ activity.fecha|timesince }} atrás</div>
                        </div>
                        <div class="activity-points">
                            {% if activity.puntos %}
                                <span class="points-gained">+{{ activity.puntos }} pts</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Actividades de Ejemplo/Placeholder -->
                    <div class="activity-item animate__animated animate__fadeInUp">
                        <div class="activity-icon canje">
                            <i class="fas fa-recycle"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Bienvenido a EcoPuntos</div>
                            <div class="activity-subtitle">¡Comienza tu viaje ecológico!</div>
                        </div>
                        <div class="activity-points">
                            <span class="points-gained">+10 pts</span>
                        </div>
                    </div>
                    
                    <div class="activity-item animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                        <div class="activity-icon juego">
                            <i class="fas fa-gamepad"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Juega y aprende sobre reciclaje</div>
                            <div class="activity-subtitle">Completa los juegos educativos</div>
                        </div>
                        <div class="activity-points">
                            <span class="points-potential">Hasta +50 pts</span>
                        </div>
                    </div>
                    
                    <div class="activity-item animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                        <div class="activity-icon recompensa">
                            <i class="fas fa-gift"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Explora las recompensas disponibles</div>
                            <div class="activity-subtitle">Canjea tus puntos por premios</div>
                        </div>
                        <div class="activity-points">
                            <span class="points-info">Ver catálogo</span>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Botón Ver Más -->
                <div class="text-center mt-4">
                    <a href="{% url 'historial' %}" class="btn btn-outline-primary">
                        <i class="fas fa-history me-2"></i>Ver Historial Completo
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Columna Lateral - Estadísticas Rápidas -->
        <div class="col-lg-4">
            <div class="sidebar-container h-100">
                <div class="quick-stats-container h-100 d-flex flex-column">
                <!-- Esta Semana -->
                <div class="quick-stat-card animate__animated animate__fadeInRight flex-fill mb-3">
                    <div class="stat-header">
                        <i class="fas fa-calendar-week"></i>
                        <h5>Esta Semana</h5>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ weekly_points|default:0 }}</div>
                        <div class="stat-label">Puntos Ganados</div>
                        <div class="stat-progress">
                            <div class="progress-bar-mini" data-width="{% widthratio weekly_points|default:0 100 100 %}"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Racha Actual -->
                <div class="quick-stat-card animate__animated animate__fadeInRight flex-fill mb-3" style="animation-delay: 0.1s;">
                    <div class="stat-header">
                        <i class="fas fa-fire"></i>
                        <h5>Racha Actual</h5>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ current_streak|default:1 }}</div>
                        <div class="stat-label">Días Consecutivos</div>
                        <div class="streak-icons">
                            {% for day in current_streak|default:1|make_list %}
                                <i class="fas fa-fire streak-icon"></i>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

  <!-- Tutorial Interactivo -->
  <div class="tutorial-overlay" id="tutorialOverlay">
    <div class="tutorial-highlight" id="tutorialHighlight"></div>
    <div class="tutorial-step" id="tutorialStep">
      <div class="tutorial-header">
        <div class="tutorial-step-number" id="stepNumber">1</div>
        <h3 class="tutorial-title" id="stepTitle">¡Bienvenido a EcoPuntos!</h3>
      </div>
      <div class="tutorial-content" id="stepContent">
        Te guiaremos a través de las funcionalidades principales de tu dashboard ecológico.
      </div>
      <div class="tutorial-controls">
        <div class="tutorial-progress" id="tutorialProgress">
          <div class="tutorial-dot active"></div>
          <div class="tutorial-dot"></div>
          <div class="tutorial-dot"></div>
          <div class="tutorial-dot"></div>
          <div class="tutorial-dot"></div>
          <div class="tutorial-dot"></div>
        </div>
        <div class="tutorial-buttons">
          <button class="tutorial-btn secondary" id="tutorialSkip">Saltar</button>
          <button class="tutorial-btn" id="tutorialNext">Siguiente</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón para reactivar tutorial -->
  <button class="tutorial-trigger" id="tutorialTrigger" title="Ver tutorial">
    <i class="fas fa-question"></i>
  </button>

  <!-- Banner de Eventos Dinámicos (reemplaza los eventos que quitamos) -->
  <div class="events-banner" id="eventsBanner" style="display: none;">
    <h4><i class="fas fa-calendar-star me-2"></i>Eventos EcoPuntos</h4>
    <div id="eventsContainer">
      <!-- Los eventos se generan dinámicamente -->
    </div>
  </div>

  <!-- Sistema de Logros Avanzado -->
  <div class="achievements-panel" id="achievementsPanel" style="display: none;">
    <div class="achievements-header">
      <h2 class="achievements-title">
        <i class="fas fa-trophy"></i>
        Logros y Desafíos
      </h2>
      <button class="achievements-toggle" onclick="toggleAchievements()">
        <i class="fas fa-eye"></i>
        <span id="achievementsToggleText">Ocultar</span>
      </button>
    </div>

    <!-- Logros principales -->
    <div class="achievements-grid" id="achievementsGrid">
      <!-- Los logros se generan dinámicamente -->
    </div>

    <!-- Desafíos semanales -->
    <div class="weekly-challenges">
      <div class="challenges-header">
        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-calendar-week"></i>
          Desafíos de esta Semana
        </h3>
        <div class="challenge-timer" id="challengeTimer">
          Renueva en: <span id="timeRemaining">6d 14h</span>
        </div>
      </div>
      
      <div class="challenges-list" id="challengesList">
        <!-- Los desafíos se generan dinámicamente -->
      </div>
    </div>
  </div>

  <!-- Modal de Badge Desbloqueado -->
  <div class="floating-badge" id="floatingBadge">
    <div class="floating-badge-icon" id="badgeIcon">
      <i class="fas fa-trophy"></i>
    </div>
    <h3 class="floating-badge-title" id="badgeTitle">¡Logro Desbloqueado!</h3>
    <p class="floating-badge-description" id="badgeDescription">Has completado un nuevo desafío</p>
    <button class="btn btn-primary" onclick="closeBadgeModal()">
      ¡Genial!
    </button>
  </div>

  <!-- Botón de Analytics (solo visible para admins) -->
  {% if user.is_staff %}
  <button class="analytics-trigger" onclick="showAnalytics()" title="Ver Analytics">
    <i class="fas fa-chart-line"></i>
  </button>
  {% endif %}

  <div class="config-overlay" id="configOverlay" onclick="closeDashboardConfig()"></div>

  <div class="dashboard-config" id="dashboardConfig">
    <div class="config-header">
      <h3>
        <i class="fas fa-palette"></i>
        Personalizar Dashboard
      </h3>
      <button class="config-close" onclick="closeDashboardConfig()">×</button>
    </div>

    <!-- Sección de Temas -->
    <div class="config-section">
      <h4><i class="fas fa-paint-brush me-2"></i>Tema Visual</h4>
      <div class="theme-selector">
        <div class="theme-option light" data-theme="light">
          <div class="theme-name">Claro</div>
        </div>
        <div class="theme-option dark" data-theme="dark">
          <div class="theme-name">Oscuro</div>
        </div>
        <div class="theme-option eco active" data-theme="eco">
          <div class="theme-name">Eco</div>
        </div>
        <div class="theme-option sunset" data-theme="sunset">
          <div class="theme-name">Sunset</div>
        </div>
      </div>
    </div>

    <!-- Sección de Layout -->
    <div class="config-section">
      <h4><i class="fas fa-th-large me-2"></i>Diseño de Layout</h4>
      <div class="layout-options">
        <div class="layout-option active" data-layout="default">
          <i class="fas fa-th"></i>
        </div>
        <div class="layout-option" data-layout="compact">
          <i class="fas fa-th-list"></i>
        </div>
        <div class="layout-option" data-layout="wide">
          <i class="fas fa-expand-arrows-alt"></i>
        </div>
      </div>
    </div>

    <!-- Sección de Widgets -->
    <div class="config-section">
      <h4><i class="fas fa-puzzle-piece me-2"></i>Widgets Activos</h4>
      <div class="widget-toggles">
        <div class="widget-toggle">
          <label>
            <input type="checkbox" checked data-widget="achievements">
            <i class="fas fa-trophy me-2"></i>
            Panel de Logros
          </label>
        </div>
        <div class="widget-toggle">
          <label>
            <input type="checkbox" checked data-widget="stats">
            <i class="fas fa-chart-line me-2"></i>
            Estadísticas
          </label>
        </div>
        <div class="widget-toggle">
          <label>
            <input type="checkbox" checked data-widget="events">
            <i class="fas fa-calendar-alt me-2"></i>
            Eventos
          </label>
        </div>
        <div class="widget-toggle">
          <label>
            <input type="checkbox" checked data-widget="activity">
            <i class="fas fa-history me-2"></i>
            Actividad Reciente
          </label>
        </div>
        <div class="widget-toggle">
          <label>
            <input type="checkbox" checked data-widget="games">
            <i class="fas fa-gamepad me-2"></i>
            Sección de Juegos
          </label>
        </div>
      </div>
    </div>

    <!-- Sección de Configuración Avanzada -->
    <div class="config-section">
      <h4><i class="fas fa-sliders-h me-2"></i>Configuración</h4>
      <div class="widget-toggles">
        <div class="widget-toggle">
          <label>
            <input type="checkbox" checked data-setting="animations">
            <i class="fas fa-magic me-2"></i>
            Animaciones
          </label>
        </div>
        <div class="widget-toggle">
          <label>
            <input type="checkbox" checked data-setting="notifications">
            <i class="fas fa-bell me-2"></i>
            Notificaciones
          </label>
        </div>
        <div class="widget-toggle">
          <label>
            <input type="checkbox" data-setting="sound">
            <i class="fas fa-volume-up me-2"></i>
            Sonidos
          </label>
        </div>
        <div class="widget-toggle">
          <label>
            <input type="checkbox" checked data-setting="auto-save">
            <i class="fas fa-save me-2"></i>
            Auto-guardar
          </label>
        </div>
      </div>
    </div>

    <!-- Botones de Acción -->
    <div class="config-section">
      <div class="d-flex gap-2">
        <button class="btn btn-light flex-fill" onclick="resetDashboardConfig()">
          <i class="fas fa-undo me-2"></i>Restaurar
        </button>
        <button class="btn btn-success flex-fill" onclick="saveDashboardConfig()">
          <i class="fas fa-check me-2"></i>Guardar
        </button>
      </div>
    </div>
  </div>
  </div>
  <!-- Modal de Notificaciones -->
  <div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="notificationsModalLabel">
            <i class="fas fa-bell me-2"></i>Notificaciones
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="notificationsList">
            <div class="text-center py-4">
              <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
              <p class="text-muted">No tienes notificaciones nuevas</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="markAllAsRead">Marcar todas como leídas</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación de Logout -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutModalLabel">Confirmar Cierre de Sesión</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          ¿Estás seguro de que deseas cerrar sesión?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <a href="{% url 'logout' %}" class="btn btn-danger">Cerrar Sesión</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">\n  \n  <!-- Mobile Navigation Script -->\n  <script>\n    document.addEventListener('DOMContentLoaded', function() {\n      const mobileToggle = document.getElementById('mobileNavToggle');\n      const sidebar = document.querySelector('.sidebar');\n      const backdrop = document.getElementById('sidebarBackdrop');\n      \n      if (mobileToggle && sidebar && backdrop) {\n        function toggleSidebar() {\n          sidebar.classList.toggle('active');\n          backdrop.classList.toggle('active');\n          \n          // Cambiar icono\n          const icon = mobileToggle.querySelector('i');\n          if (sidebar.classList.contains('active')) {\n            icon.classList.remove('fa-bars');\n            icon.classList.add('fa-times');\n          } else {\n            icon.classList.remove('fa-times');\n            icon.classList.add('fa-bars');\n          }\n        }\n        \n        function closeSidebar() {\n          sidebar.classList.remove('active');\n          backdrop.classList.remove('active');\n          const icon = mobileToggle.querySelector('i');\n          icon.classList.remove('fa-times');\n          icon.classList.add('fa-bars');\n        }\n        \n        // Event listeners\n        mobileToggle.addEventListener('click', toggleSidebar);\n        backdrop.addEventListener('click', closeSidebar);\n        \n        // Cerrar sidebar al hacer click en un enlace de navegación en móvil\n        const navItems = document.querySelectorAll('.nav-item');\n        navItems.forEach(item => {\n          item.addEventListener('click', function() {\n            if (window.innerWidth <= 768) {\n              closeSidebar();\n            }\n          });\n        });\n        \n        // Cerrar sidebar al cambiar tamaño de ventana\n        window.addEventListener('resize', function() {\n          if (window.innerWidth > 768) {\n            closeSidebar();\n          }\n        });\n      }\n    });\n  </script>
  
  <!-- Monitor de Sesión -->
  {% if user.is_authenticated %}
  <link rel="stylesheet" href="{% static 'core/css/session-monitor.css' %}">
  <script>
    // Agregar data attribute para que el monitor sepa que el usuario está autenticado
    document.body.dataset.userAuthenticated = 'true';
  </script>
  <script src="{% static 'core/js/session-monitor.js' %}"></script>
  <script src="{% static 'core/js/session-test.js' %}"></script>
  {% endif %}
  
  <!-- CSRF Token -->
  {% csrf_token %}
  <meta name="csrf-token" content="{{ csrf_token }}">

<script type="text/javascript">
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "5000",
        };

        // Script para activar el elemento de menú actual basado en la URL
        $(document).ready(function() {
            const currentPath = window.location.pathname;
            $('.nav-menu .nav-item a').each(function() {
                if ($(this).attr('href') === currentPath) {
                    $(this).closest('.nav-item').addClass('active');
                }
            });

            // Aplicar ancho de progreso dinámicamente
            $('.progress-fill-premium').each(function() {
                const progress = $(this).data('progress');
                $(this).css('width', progress + '%');
            });

            // Handle logout button click to open modal
            $('#logoutButton').on('click', function(e) {
                e.preventDefault();
                $('#logoutModal').modal('show');
            });
            
            // Funcionalidad del botón flotante con menú
            let isMenuOpen = false;
            
            $('#floatMenuBtn').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const menu = $('#floatMenu');
                const btn = $(this);
                
                if (isMenuOpen) {
                    // Cerrar menú
                    menu.removeClass('show');
                    btn.removeClass('active');
                    isMenuOpen = false;
                } else {
                    // Abrir menú
                    menu.addClass('show');
                    btn.addClass('active');
                    isMenuOpen = true;
                }
            });
            
            // Cerrar menú al hacer clic fuera
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.float-plus-btn').length && isMenuOpen) {
                    $('#floatMenu').removeClass('show');
                    $('#floatMenuBtn').removeClass('active');
                    isMenuOpen = false;
                }
            });
            
            // Cerrar menú al hacer clic en una opción
            $('.float-menu-item').on('click', function() {
                $('#floatMenu').removeClass('show');
                $('#floatMenuBtn').removeClass('active');
                isMenuOpen = false;
            });
            
            // Funcionalidad de notificaciones
            loadNotifications();
            
            // Abrir modal de notificaciones
            $('#notificationIcon').on('click', function() {
                $('#notificationsModal').modal('show');
                markNotificationsAsRead();
            });
            
            // Marcar todas como leídas
            $('#markAllAsRead').on('click', function() {
                markAllNotificationsAsRead();
            });
        });
        
        // Función para cargar notificaciones
        function loadNotifications() {
            $.ajax({
                url: '/api/notifications/',
                method: 'GET',
                headers: {
                    'X-CSRFToken': $('meta[name=csrf-token]').attr('content') || $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(data) {
                    console.log('Respuesta de notificaciones:', data);
                    if (data.success) {
                        updateNotificationBadge(data.unread_count);
                        displayNotifications(data.notifications);
                    } else {
                        console.log('Error en la respuesta:', data.error);
                        // Mostrar notificaciones de prueba si hay error
                        displayDemoNotifications();
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error al cargar notificaciones:', error);
                    console.log('Status:', status);
                    console.log('Response:', xhr.responseText);
                    // Mostrar notificaciones de prueba si hay error
                    displayDemoNotifications();
                }
            });
        }
        
        // Función para actualizar el badge de notificaciones
        function updateNotificationBadge(count) {
            const badge = $('#notificationBadge');
            if (count > 0) {
                badge.text(count).show();
            } else {
                badge.hide();
            }
        }
        
        // Función para mostrar notificaciones en el modal
        function displayNotifications(notifications) {
            const container = $('#notificationsList');
            
            if (notifications.length === 0) {
                container.html(`
                    <div class="text-center py-4">
                        <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No tienes notificaciones nuevas</p>
                    </div>
                `);
                return;
            }
            
            let html = '';
            notifications.forEach(function(notification) {
                const isUnread = !notification.leida;
                const timeAgo = formatTimeAgo(notification.fecha_creacion);
                
                html += `
                    <div class="notification-item ${isUnread ? 'unread' : ''}" data-id="${notification.id}">
                        <div class="d-flex align-items-start">
                            <div class="notification-icon me-3">
                                <i class="fas fa-${getNotificationIcon(notification.tipo)} text-primary"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="notification-title mb-1">${notification.titulo}</h6>
                                <p class="notification-message mb-1">${notification.mensaje}</p>
                                <small class="text-muted">${timeAgo}</small>
                            </div>
                            ${isUnread ? '<div class="unread-indicator"></div>' : ''}
                        </div>
                    </div>
                `;
            });
            
            container.html(html);
            
            // Agregar event listeners para marcar como leída al hacer clic
            $('.notification-item').off('click').on('click', function() {
                const notificationId = $(this).data('id');
                markSingleNotificationAsRead(notificationId, $(this));
            });
        }
        
        // Función para mostrar notificaciones de demostración
        function displayDemoNotifications() {
            const demoNotifications = [
                {
                    id: 'demo1',
                    titulo: '¡Bienvenido a EcoPuntos!',
                    mensaje: 'Tu cuenta ha sido creada exitosamente. ¡Comienza a reciclar y ganar puntos!',
                    tipo: 'general',
                    fecha_creacion: new Date().toISOString(),
                    leida: false
                },
                {
                    id: 'demo2',
                    titulo: 'Sistema de Notificaciones',
                    mensaje: 'Las notificaciones te mantendrán informado sobre tus actividades de reciclaje.',
                    tipo: 'general',
                    fecha_creacion: new Date(Date.now() - 3600000).toISOString(),
                    leida: false
                },
                {
                    id: 'demo3',
                    titulo: 'Explora los Juegos',
                    mensaje: 'Prueba nuestros juegos educativos: EcoWorm, Crystal Hunter y Paper Storm Tetris.',
                    tipo: 'general',
                    fecha_creacion: new Date(Date.now() - 7200000).toISOString(),
                    leida: true
                }
            ];
            
            updateNotificationBadge(2); // 2 no leídas
            displayNotifications(demoNotifications);
        }
        
        // Función para obtener el icono según el tipo de notificación
        function getNotificationIcon(tipo) {
            switch(tipo) {
                case 'canje_aprobado': return 'check-circle';
                case 'canje_rechazado': return 'times-circle';
                case 'puntos_agregados': return 'coins';
                case 'sistema': return 'info-circle';
                default: return 'bell';
            }
        }
        
        // Función para formatear tiempo
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Hace un momento';
            if (diffInSeconds < 3600) return `Hace ${Math.floor(diffInSeconds / 60)} minutos`;
            if (diffInSeconds < 86400) return `Hace ${Math.floor(diffInSeconds / 3600)} horas`;
            return `Hace ${Math.floor(diffInSeconds / 86400)} días`;
        }
        
        // Función para obtener el icono según el tipo de notificación
        function getNotificationIcon(tipo) {
            const icons = {
                'general': 'bell',
                'canje': 'exchange-alt',
                'redencion': 'coins',
                'perfil': 'user',
                'sistema': 'cog',
                'seguridad': 'shield-alt'
            };
            return icons[tipo] || 'bell';
        }
        
        // Función para marcar una notificación individual como leída
        function markSingleNotificationAsRead(notificationId, element) {
            if (notificationId.toString().startsWith('demo')) {
                // Para notificaciones demo, solo remover visualmente
                element.removeClass('unread');
                element.find('.unread-indicator').remove();
                const currentCount = parseInt($('#notificationBadge').text()) || 0;
                updateNotificationBadge(Math.max(0, currentCount - 1));
                return;
            }
            
            $.ajax({
                url: '/api/notifications/mark-read/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('meta[name=csrf-token]').attr('content') || $('[name=csrfmiddlewaretoken]').val(),
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    'notification_id': notificationId
                }),
                success: function(data) {
                    if (data.success) {
                        element.removeClass('unread');
                        element.find('.unread-indicator').remove();
                        const currentCount = parseInt($('#notificationBadge').text()) || 0;
                        updateNotificationBadge(Math.max(0, currentCount - 1));
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error al marcar notificación como leída:', error);
                }
            });
        }
        
        // Función para marcar notificaciones como leídas al abrir el modal
        function markNotificationsAsRead() {
            $.ajax({
                url: '/api/notifications/mark-all-read/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('meta[name=csrf-token]').attr('content') || $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(data) {
                    if (data.success) {
                        updateNotificationBadge(0);
                        $('.notification-item').removeClass('unread');
                        $('.unread-indicator').remove();
                        loadNotifications(); // Recargar notificaciones
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error al marcar notificaciones como leídas:', error);
                }
            });
        }
        
        // Función para marcar todas las notificaciones como leídas
        function markAllNotificationsAsRead() {
            $.ajax({
                url: '/api/notifications/mark-all-read/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('meta[name=csrf-token]').attr('content') || $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(data) {
                    if (data.success) {
                        updateNotificationBadge(0);
                        $('.notification-item').removeClass('unread');
                        $('.unread-indicator').remove();
                        loadNotifications(); // Recargar notificaciones
                        
                        // Mostrar mensaje de éxito
                        if (typeof toastr !== 'undefined') {
                            toastr.success('Todas las notificaciones han sido marcadas como leídas');
                        } else {
                            alert('Todas las notificaciones han sido marcadas como leídas');
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error al marcar todas las notificaciones como leídas:', error);
                    if (typeof toastr !== 'undefined') {
                        toastr.error('Error al marcar las notificaciones como leídas');
                    } else {
                        alert('Error al marcar las notificaciones como leídas');
                    }
                }
            });
        }
        
        // Función para eliminar todas las notificaciones
        function deleteAllNotifications() {
            if (confirm('¿Estás seguro de que quieres eliminar todas las notificaciones? Esta acción no se puede deshacer.')) {
                $.ajax({
                    url: '/api/notifications/clear/',
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': $('meta[name=csrf-token]').attr('content') || $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(data) {
                        if (data.success) {
                            updateNotificationBadge(0);
                            $('#notificationsList').html(`
                                <div class="text-center py-4">
                                    <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No tienes notificaciones nuevas</p>
                                </div>
                            `);
                            loadNotifications(); // Recargar notificaciones
                            
                            if (typeof toastr !== 'undefined') {
                                toastr.success('Todas las notificaciones han sido eliminadas');
                            } else {
                                alert('Todas las notificaciones han sido eliminadas');
                            }
                        } else {
                            if (typeof toastr !== 'undefined') {
                                toastr.error('Error al eliminar las notificaciones');
                            } else {
                                alert('Error al eliminar las notificaciones');
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log('Error al eliminar notificaciones:', error);
                        if (typeof toastr !== 'undefined') {
                            toastr.error('Error al eliminar las notificaciones');
                        } else {
                            alert('Error al eliminar las notificaciones');
                        }
                    }
                });
            }
        }
        
        // Funcionalidad de la gráfica histórica
        let activityChart;
        
        function initializeChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            // Datos de ejemplo - en producción estos vendrían del backend
            const chartData = {
                labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                datasets: [{
                    label: 'Puntos Ganados',
                    data: [12, 19, 8, 15, 25, 22, 18],
                    borderColor: '#4caf50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#4caf50',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            };
            
            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#4caf50',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} puntos`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            };
            
            activityChart = new Chart(ctx, config);
            
            // Calcular estadísticas
            updateChartStats(chartData.datasets[0].data);
        }
        
        function updateChartStats(data) {
            const total = data.reduce((a, b) => a + b, 0);
            const average = Math.round(total / data.length);
            const maxDay = Math.max(...data);
            const streak = calculateStreak(data);
            
            $('#weeklyAvg').text(average);
            $('#bestDay').text(maxDay);
            $('#streak').text(streak);
        }
        
        function calculateStreak(data) {
            let streak = 0;
            for (let i = data.length - 1; i >= 0; i--) {
                if (data[i] > 0) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }
        
        // Manejar cambios de período
        $('.chart-controls .btn').on('click', function() {
            $('.chart-controls .btn').removeClass('active');
            $(this).addClass('active');
            
            const period = $(this).data('period');
            updateChartData(period);
        });
        
        function updateChartData(period) {
            // Datos de ejemplo para diferentes períodos
            let newData, newLabels;
            
            switch(period) {
                case 7:
                    newLabels = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
                    newData = [12, 19, 8, 15, 25, 22, 18];
                    break;
                case 30:
                    newLabels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
                    newData = [85, 92, 78, 105];
                    break;
                case 90:
                    newLabels = ['Mes 1', 'Mes 2', 'Mes 3'];
                    newData = [320, 380, 290];
                    break;
            }
            
            activityChart.data.labels = newLabels;
            activityChart.data.datasets[0].data = newData;
            activityChart.update('active');
            
            updateChartStats(newData);
        }
        
        // Inicializar la gráfica cuando el documento esté listo
        $(document).ready(function() {
            // Cargar Chart.js si no está disponible
            if (typeof Chart === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = function() {
                    initializeChart();
                };
                document.head.appendChild(script);
            } else {
                initializeChart();
            }
        });
    </script>
    
    <!-- Modal de Términos y Condiciones -->
    <div class="modal fade" id="terminosModal" tabindex="-1" aria-labelledby="terminosModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" style="max-width: 90vw;">
            <div class="modal-content" style="min-height: 80vh;">
                <div class="modal-header bg-success text-white" style="padding: 20px 30px;">
                    <h4 class="modal-title fw-bold" id="terminosModalLabel" style="font-size: 1.8rem; color: white !important; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                        <i class="fas fa-file-contract me-3" style="color: white !important;"></i>
                        Términos y Condiciones - EcoPuntos
                    </h4>
                </div>
                <div class="modal-body" style="padding: 30px; max-height: 65vh; overflow-y: auto; font-size: 1.1rem; line-height: 1.6;">
                    <div class="alert alert-info" style="font-size: 1.2rem; padding: 20px; border-radius: 10px;">
                        <i class="fas fa-info-circle me-3" style="font-size: 1.5rem;"></i>
                        <strong>¡Importante!</strong> Para continuar usando EcoPuntos, necesitas aceptar nuestros términos y condiciones actualizados.
                    </div>
                    
                    <div class="terms-content" style="padding: 0 10px;">
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-shield-alt me-3"></i>1. Registro y Cuenta</h5>
                        <p style="margin-bottom: 25px;">Para utilizar EcoPuntos, debes crear una cuenta proporcionando información precisa y completa. Eres responsable de mantener la confidencialidad de tu contraseña y de todas las actividades que ocurran bajo tu cuenta.</p>
                        
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-recycle me-3"></i>2. Uso del Servicio</h5>
                        <p style="margin-bottom: 25px;">EcoPuntos es una plataforma que incentiva el reciclaje mediante un sistema de puntos canjeables. Te comprometes a utilizar el servicio de manera ética y conforme a las leyes aplicables.</p>
                        
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-user-shield me-3"></i>3. Privacidad</h5>
                        <p style="margin-bottom: 25px;">Tu privacidad es importante para nosotros. Consulta nuestra <a href="{% url 'politica_privacidad' %}" target="_blank" class="text-success fw-bold">Política de Privacidad</a> para entender cómo recopilamos, usamos y protegemos tu información personal.</p>
                        
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-copyright me-3"></i>4. Propiedad Intelectual</h5>
                        <p style="margin-bottom: 25px;">Todo el contenido de EcoPuntos, incluyendo logotipos, textos, gráficos y software, está protegido por derechos de autor y otras leyes de propiedad intelectual.</p>
                        
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-coins me-3"></i>5. Sistema de Puntos</h5>
                        <p style="margin-bottom: 25px;">Los puntos EcoPuntos son una moneda virtual dentro de la plataforma. Pueden ser canjeados por recompensas disponibles. Los puntos no tienen valor monetario real fuera de la plataforma.</p>
                        
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-user-check me-3"></i>6. Conducta del Usuario</h5>
                        <p style="margin-bottom: 25px;">Te comprometes a usar EcoPuntos de manera responsable, sin realizar actividades fraudulentas, spam o cualquier comportamiento que pueda dañar la plataforma o a otros usuarios.</p>
                        
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-ban me-3"></i>7. Suspensión y Terminación</h5>
                        <p style="margin-bottom: 25px;">Nos reservamos el derecho de suspender o terminar tu cuenta si violas estos términos o realizas actividades que consideremos inapropiadas o dañinas para la plataforma.</p>
                        
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-gift me-3"></i>8. Recompensas y Canjes</h5>
                        <p style="margin-bottom: 25px;">Las recompensas están sujetas a disponibilidad. Los canjes son finales y no reembolsables. EcoPuntos se reserva el derecho de modificar o discontinuar recompensas en cualquier momento.</p>
                        
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-exclamation-triangle me-3"></i>9. Limitaciones de Responsabilidad</h5>
                        <p style="margin-bottom: 25px;">EcoPuntos no se hace responsable por daños indirectos, incidentales o consecuentes que puedan surgir del uso de la plataforma.</p>
                        
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-edit me-3"></i>10. Modificaciones</h5>
                        <p style="margin-bottom: 25px;">Nos reservamos el derecho de modificar estos términos en cualquier momento. Las modificaciones entrarán en vigor inmediatamente después de su publicación en la plataforma.</p>
                        
                        <h5 class="text-success mb-3" style="font-size: 1.4rem; font-weight: 600;"><i class="fas fa-gavel me-3"></i>11. Ley Aplicable</h5>
                        <p style="margin-bottom: 15px;">Estos términos se rigen por las leyes vigentes y cualquier disputa será resuelta en los tribunales competentes. Para ver la versión completa de estos términos, visita nuestros <a href="{% url 'terminos_condiciones' %}" target="_blank" class="text-success fw-bold">Términos y Condiciones completos</a>.</p>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 25px 30px; background-color: #f8f9fa; border-top: 2px solid #28a745;">
                    <div class="w-100">
                        <div class="form-check mb-4" style="display: flex; align-items: center; justify-content: center;">
                            <input class="form-check-input me-3" type="checkbox" id="aceptoTerminos" style="transform: scale(1.5);">
                            <label class="form-check-label" for="aceptoTerminos" style="font-size: 1.2rem; font-weight: 600; color: #2c3e50;">
                                <strong>Acepto los términos y condiciones de EcoPuntos</strong>
                            </label>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button type="button" class="btn btn-success btn-lg px-5 py-3" id="btnAceptarTerminos" disabled style="font-size: 1.2rem; font-weight: 600; border-radius: 10px;">
                                <i class="fas fa-check me-3"></i>Aceptar y Continuar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script para manejar términos y condiciones -->
    <script>
        // Verificar si el usuario ha aceptado los términos
        $(document).ready(function() {
            fetch('{% url "verificar_terminos" %}')
                .then(response => response.json())
                .then(data => {
                    if (!data.terminos_aceptados) {
                        // Mostrar modal si no ha aceptado términos
                        $('#terminosModal').modal('show');
                    }
                })
                .catch(error => {
                    console.error('Error verificando términos:', error);
                });
        });

        // Habilitar/deshabilitar botón según checkbox
        document.getElementById('aceptoTerminos').addEventListener('change', function() {
            document.getElementById('btnAceptarTerminos').disabled = !this.checked;
        });

        // Manejar aceptación de términos
        document.getElementById('btnAceptarTerminos').addEventListener('click', function() {
            const btn = this;
            const originalText = btn.innerHTML;
            
            // Deshabilitar botón y mostrar loading
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Procesando...';
            
            // Obtener token CSRF
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('{% url "aceptar_terminos" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#terminosModal').modal('hide');
                    // Mostrar mensaje de éxito
                    const alertSuccess = document.createElement('div');
                    alertSuccess.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    alertSuccess.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    alertSuccess.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        ¡Términos aceptados correctamente!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertSuccess);
                    
                    // Remover alerta después de 5 segundos
                    setTimeout(() => {
                        if (alertSuccess.parentNode) {
                            alertSuccess.remove();
                        }
                    }, 5000);
                } else {
                    alert('Error al aceptar términos: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexión al aceptar términos');
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        });
    </script>

    <!-- Sistema de Notificaciones JavaScript -->
    <script>
        class NotificationSystem {
            constructor() {
                this.notifications = [];
                this.init();
                this.loadNotifications();
                this.startPeriodicCheck();
            }

            init() {
                this.notificationIcon = document.getElementById('notificationIcon');
                this.notificationBadge = document.getElementById('notificationBadge');
                this.notificationDropdown = document.getElementById('notificationDropdown');
                this.notificationList = document.getElementById('notificationList');
                this.notificationCount = document.getElementById('notificationCount');
                this.markAllReadBtn = document.getElementById('markAllRead');

                // Event listeners
                this.notificationIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleDropdown();
                });

                this.markAllReadBtn.addEventListener('click', () => {
                    this.markAllAsRead();
                });

                // Cerrar dropdown al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!this.notificationDropdown.contains(e.target) && !this.notificationIcon.contains(e.target)) {
                        this.closeDropdown();
                    }
                });
            }

            async loadNotifications() {
                try {
                    // Simular notificaciones de seguridad y sistema
                    this.notifications = await this.getSecurityNotifications();
                    this.updateUI();
                } catch (error) {
                    console.error('Error cargando notificaciones:', error);
                }
            }

            async getSecurityNotifications() {
                try {
                    const response = await fetch('{% url "get_notifications" %}', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        return data.notifications;
                    } else {
                        console.error('Error en la respuesta:', data.error);
                        return [];
                    }
                } catch (error) {
                    console.error('Error obteniendo notificaciones:', error);
                    // Fallback a notificaciones simuladas en caso de error
                    return [
                        {
                            id: 'error_notification',
                            type: 'warning',
                            title: 'Error de conexión',
                            message: 'No se pudieron cargar las notificaciones de seguridad',
                            time: 'Ahora',
                            unread: true
                        }
                    ];
                }
            }

            updateUI() {
                const unreadCount = this.notifications.filter(n => n.unread).length;
                
                // Actualizar badge
                this.notificationBadge.textContent = unreadCount;
                this.notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
                
                // Actualizar contador
                this.notificationCount.textContent = `${unreadCount} nuevas`;
                
                // Renderizar lista
                this.renderNotifications();
            }

            renderNotifications() {
                if (this.notifications.length === 0) {
                    this.notificationList.innerHTML = `
                        <div class="empty-notifications">
                            <i class="fas fa-bell-slash"></i>
                            <p>No hay notificaciones</p>
                        </div>
                    `;
                    return;
                }

                this.notificationList.innerHTML = this.notifications.map(notification => `
                    <div class="notification-item ${notification.unread ? 'unread' : ''} ${notification.type}" 
                         data-id="${notification.id}">
                        <div class="notification-content">
                            <div class="notification-icon-small ${notification.type}">
                                <i class="fas ${this.getIconByType(notification.type)}"></i>
                            </div>
                            <div class="notification-text">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-message">${notification.message}</div>
                                <div class="notification-time">${notification.time}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Agregar event listeners a los items
                this.notificationList.querySelectorAll('.notification-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const notificationId = parseInt(item.dataset.id);
                        this.markAsRead(notificationId);
                        this.handleNotificationClick(notificationId);
                    });
                });
            }

            getIconByType(type) {
                const icons = {
                    security: 'fa-shield-alt',
                    system: 'fa-cog',
                    success: 'fa-check-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                return icons[type] || 'fa-bell';
            }

            handleNotificationClick(notificationId) {
                const notification = this.notifications.find(n => n.id === notificationId);
                if (notification && notification.type === 'security') {
                    // Mostrar alerta de seguridad (sin redirección)
                    alert('Notificación de seguridad: ' + notification.message);
                }
            }

            toggleDropdown() {
                this.notificationDropdown.classList.toggle('show');
                if (this.notificationDropdown.classList.contains('show')) {
                    this.loadNotifications(); // Recargar al abrir
                }
            }

            closeDropdown() {
                this.notificationDropdown.classList.remove('show');
            }

            markAsRead(notificationId) {
                const notification = this.notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.unread = false;
                    this.updateUI();
                }
            }

            markAllAsRead() {
                this.notifications.forEach(n => n.unread = false);
                this.updateUI();
                this.closeDropdown();
            }

            startPeriodicCheck() {
                // Verificar nuevas notificaciones cada 30 segundos
                setInterval(() => {
                    this.loadNotifications();
                }, 30000);
            }

            addNotification(notification) {
                notification.id = Date.now();
                notification.unread = true;
                notification.time = 'Ahora';
                this.notifications.unshift(notification);
                this.updateUI();
                
                // Mostrar animación de nueva notificación
                this.notificationIcon.style.animation = 'bounce 0.6s ease-in-out';
                setTimeout(() => {
                    this.notificationIcon.style.animation = 'pulse 2s infinite';
                }, 600);
            }
        }

        // Inicializar sistema de notificaciones cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            window.notificationSystem = new NotificationSystem();

            // Ejemplo de cómo agregar una nueva notificación
            // window.notificationSystem.addNotification({
            //     type: 'security',
            //     title: 'Nueva alerta de seguridad',
            //     message: 'Se detectó actividad sospechosa en tu cuenta'
            // });
        });
    </script>

    <!-- ============= SISTEMA INTELIGENTE DE TOUR ============= -->
    <script>
        // Sistema Inteligente de Detección de Usuario y Tour
        class IntelligentTourSystem {
            constructor() {
                this.currentStep = 1;
                this.userType = this.detectUserType();
                this.init();
            }

            detectUserType() {
                const tourCompleted = localStorage.getItem('ecopuntos_tour_completed');
                const lastActivity = localStorage.getItem('ecopuntos_last_activity');
                const registrationDate = localStorage.getItem('ecopuntos_user_registration');
                const tourRequested = new URLSearchParams(window.location.search).get('tour');
                
                // Establecer registro si no existe
                if (!registrationDate) {
                    localStorage.setItem('ecopuntos_user_registration', new Date().toISOString());
                }
                
                // Usuario solicita tour manualmente
                if (tourRequested === 'true') {
                    return 'manual_tour';
                }
                
                // Usuario nuevo (nunca completó tour)
                if (!tourCompleted) {
                    return 'new_user';
                }
                
                // Usuario inactivo (más de 30 días sin actividad)
                if (lastActivity) {
                    const daysSinceActivity = this.getDaysSince(lastActivity);
                    if (daysSinceActivity > 30) {
                        return 'inactive_user';
                    }
                }
                
                // Usuario recurrente activo
                return 'active_user';
            }

            getDaysSince(dateString) {
                const date = new Date(dateString);
                const today = new Date();
                const diffTime = Math.abs(today - date);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }

            init() {
                console.log(`Usuario detectado como: ${this.userType}`);
                
                // Asegurar que los elementos existan antes de manipularlos
                const miniTourElement = document.getElementById('miniTour');
                if (!miniTourElement) {
                    console.error('Elemento miniTour no encontrado');
                    return;
                }
                
                switch(this.userType) {
                    case 'new_user':
                    case 'manual_tour':
                        this.showWelcomeTour();
                        break;
                    case 'inactive_user':
                        this.showWelcomeBackExperience();
                        break;
                    case 'active_user':
                        this.showDynamicDashboard();
                        break;
                    default:
                        this.showDynamicDashboard();
                }
            }

            showWelcomeTour() {
                // El tour existente se mantiene, solo lo hacemos visible
                const miniTour = document.getElementById('miniTour');
                const dynamicCards = document.getElementById('dynamicCards');
                
                if (miniTour) {
                    miniTour.style.display = 'block';
                }
                if (dynamicCards) {
                    dynamicCards.style.display = 'none';
                }
                
                // Asegurar que step1 esté visible
                const step1 = document.getElementById('step1');
                if (step1) {
                    step1.style.display = 'block';
                }
                
                // Ocultar otros pasos
                for (let i = 2; i <= 5; i++) {
                    const step = document.getElementById(`step${i}`);
                    if (step) {
                        step.style.display = 'none';
                    }
                }
                
                // Resetear dots
                this.updateDots(1);
            }

            showWelcomeBackExperience() {
                this.createWelcomeBackTour();
            }

            showDynamicDashboard() {
                this.createDynamicCards();
                document.getElementById('miniTour').style.display = 'none';
                
                // Agregar botón de tour manual
                this.addManualTourButton();
            }

            createWelcomeBackTour() {
                const tourContainer = document.getElementById('miniTour');
                const lastActivity = localStorage.getItem('ecopuntos_last_activity');
                const daysSince = lastActivity ? this.getDaysSince(lastActivity) : 0;
                
                tourContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem 2rem;">
                        <i class="fas fa-seedling" style="font-size: 4rem; color: white; margin-bottom: 2rem; animation: bounce 2s infinite;"></i>
                        <h2 style="font-size: 2rem; font-weight: 700; color: white; margin-bottom: 1rem;">¡Te extrañamos! 🌱</h2>
                        <p style="font-size: 1.3rem; color: rgba(255,255,255,0.9); margin-bottom: 1.5rem;">
                            Han pasado ${daysSince} días desde tu última actividad.<br>
                            ¡Tu planeta te necesita de vuelta!
                        </p>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 1.5rem; margin: 2rem 0;">
                            <p style="font-size: 1.1rem; margin-bottom: 1rem;">✨ <strong>Novedades mientras no estabas:</strong></p>
                            <p style="font-size: 1rem; line-height: 1.4;">
                                • Nuevas recompensas ecológicas disponibles<br>
                                • Sistema de logros mejorado<br>
                                • Chat de soporte 24/7 activado
                            </p>
                        </div>
                        <div class="d-flex gap-3 justify-content-center">
                            <button onclick="tourSystem.completeTour()" class="btn btn-light" style="padding: 12px 24px; font-weight: 600;">
                                Ir al Dashboard
                            </button>
                            <button onclick="tourSystem.showRefreshTour()" class="btn btn-success" style="padding: 12px 24px; font-weight: 600;">
                                Ver Tour Rápido
                            </button>
                        </div>
                    </div>
                `;
            }

            createDynamicCards() {
                const container = document.getElementById('miniTour');
                const userPoints = {{ user.puntos|default:0 }};
                const userLevel = "{{ current_level|default:'guardian_verde' }}";
                
                container.innerHTML = `
                    <div id="dynamicCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; padding: 0;">
                        <!-- Tarjeta de Progreso Personal -->
                        <div class="smart-card progress-card">
                            <div class="card-header">
                                <i class="fas fa-chart-line"></i>
                                <h3>Tu Progreso</h3>
                            </div>
                            <div class="card-content">
                                <div class="progress-ring">
                                    <span class="progress-value">${userPoints}</span>
                                    <span class="progress-label">Puntos</span>
                                </div>
                                <p class="progress-level">Nivel: <strong>${userLevel}</strong></p>
                                <div class="quick-actions">
                                    <a href="{% url 'categorias' %}" class="action-btn">
                                        <i class="fas fa-recycle"></i> Reciclar Ahora
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Tarjeta de Recompensas Inteligente -->
                        <div class="smart-card rewards-card">
                            <div class="card-header">
                                <i class="fas fa-gift"></i>
                                <h3>Recompensas Cercanas</h3>
                            </div>
                            <div class="card-content">
                                <div class="reward-preview">
                                    <p class="reward-text">🎧 <strong>Auriculares Bluetooth</strong></p>
                                    <p class="reward-points">Solo faltan <strong>${Math.max(0, 500 - userPoints)}</strong> puntos</p>
                                </div>
                                <div class="quick-actions">
                                    <a href="{% url 'recompensas' %}" class="action-btn">
                                        <i class="fas fa-eye"></i> Ver Todas
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Tarjeta de Impacto Ambiental -->
                        <div class="smart-card impact-card">
                            <div class="card-header">
                                <i class="fas fa-leaf"></i>
                                <h3>Tu Impacto</h3>
                            </div>
                            <div class="card-content">
                                <div class="impact-stats">
                                    <div class="impact-item">
                                        <span class="impact-number">${(userPoints * 0.1).toFixed(1)}</span>
                                        <span class="impact-label">kg de CO₂ ahorrados</span>
                                    </div>
                                    <div class="impact-item">
                                        <span class="impact-number">${Math.floor(userPoints / 10)}</span>
                                        <span class="impact-label">árboles equivalentes</span>
                                    </div>
                                </div>
                                <div class="quick-actions">
                                    <a href="{% url 'historial' %}" class="action-btn">
                                        <i class="fas fa-history"></i> Ver Historial
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Agregar estilos para las tarjetas dinámicas
                this.addDynamicCardStyles();
            }

            addDynamicCardStyles() {
                if (!document.getElementById('dynamicCardStyles')) {
                    const style = document.createElement('style');
                    style.id = 'dynamicCardStyles';
                    style.textContent = `
                        .smart-card {
                            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%);
                            border-radius: 20px;
                            padding: 2rem;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                            transition: all 0.3s ease;
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(255,255,255,0.2);
                        }
                        
                        .smart-card:hover {
                            transform: translateY(-5px);
                            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
                        }
                        
                        .card-header {
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            margin-bottom: 1.5rem;
                        }
                        
                        .card-header i {
                            font-size: 1.5rem;
                            color: #4caf50;
                        }
                        
                        .card-header h3 {
                            font-size: 1.3rem;
                            font-weight: 700;
                            color: #2c3e50;
                            margin: 0;
                        }
                        
                        .progress-ring {
                            text-align: center;
                            margin-bottom: 1rem;
                        }
                        
                        .progress-value {
                            display: block;
                            font-size: 2.5rem;
                            font-weight: 700;
                            color: #4caf50;
                        }
                        
                        .progress-label {
                            font-size: 1rem;
                            color: #6c757d;
                        }
                        
                        .progress-level {
                            text-align: center;
                            color: #495057;
                            margin-bottom: 1.5rem;
                        }
                        
                        .reward-preview {
                            text-align: center;
                            margin-bottom: 1.5rem;
                        }
                        
                        .reward-text {
                            font-size: 1.1rem;
                            margin-bottom: 0.5rem;
                            color: #2c3e50;
                        }
                        
                        .reward-points {
                            color: #e67e22;
                            font-size: 1rem;
                        }
                        
                        .impact-stats {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 1rem;
                            margin-bottom: 1.5rem;
                        }
                        
                        .impact-item {
                            text-align: center;
                        }
                        
                        .impact-number {
                            display: block;
                            font-size: 1.8rem;
                            font-weight: 700;
                            color: #27ae60;
                        }
                        
                        .impact-label {
                            font-size: 0.9rem;
                            color: #6c757d;
                        }
                        
                        .quick-actions {
                            text-align: center;
                        }
                        
                        .action-btn {
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                            padding: 10px 20px;
                            background: linear-gradient(135deg, #4caf50, #45a049);
                            color: white;
                            text-decoration: none;
                            border-radius: 25px;
                            font-weight: 600;
                            transition: all 0.3s ease;
                            font-size: 0.9rem;
                        }
                        
                        .action-btn:hover {
                            background: linear-gradient(135deg, #45a049, #4caf50);
                            transform: translateY(-2px);
                            color: white;
                            text-decoration: none;
                        }
                        
                        @media (max-width: 768px) {
                            #dynamicCards {
                                grid-template-columns: 1fr;
                                gap: 1rem;
                            }
                            
                            .smart-card {
                                padding: 1.5rem;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            addManualTourButton() {
                // Agregar botón flotante para tour manual
                if (!document.getElementById('manualTourBtn')) {
                    const button = document.createElement('div');
                    button.id = 'manualTourBtn';
                    button.innerHTML = `
                        <button onclick="tourSystem.startManualTour()" style="
                            position: fixed;
                            bottom: 30px;
                            right: 30px;
                            width: 60px;
                            height: 60px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #4caf50, #45a049);
                            border: none;
                            color: white;
                            font-size: 1.2rem;
                            cursor: pointer;
                            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.3);
                            transition: all 0.3s ease;
                            z-index: 1000;
                        " title="Ver Tour de Bienvenida" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-question"></i>
                        </button>
                    `;
                    document.body.appendChild(button);
                }
            }

            startManualTour() {
                // Reiniciar y mostrar tour completo
                localStorage.removeItem('ecopuntos_tour_completed');
                location.reload();
            }

            showRefreshTour() {
                // Tour rápido de 3 pasos para usuarios que regresan
                this.createQuickRefreshTour();
            }

            createQuickRefreshTour() {
                const tourContainer = document.getElementById('miniTour');
                tourContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem 2rem;">
                        <h2 style="color: white; margin-bottom: 2rem;">🚀 Tour Rápido - Actualizado</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; text-align: left;">
                            <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 15px;">
                                <h4 style="color: white; margin-bottom: 1rem;"><i class="fas fa-gift me-2"></i>Nuevas Recompensas</h4>
                                <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Smartwatches, plantas purificadoras y productos ecológicos exclusivos.</p>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 15px;">
                                <h4 style="color: white; margin-bottom: 1rem;"><i class="fas fa-trophy me-2"></i>Sistema de Logros</h4>
                                <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Desbloquea medallas y reconocimientos por tu compromiso ambiental.</p>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 15px;">
                                <h4 style="color: white; margin-bottom: 1rem;"><i class="fas fa-headset me-2"></i>Soporte 24/7</h4>
                                <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Chat en vivo disponible las 24 horas para ayudarte.</p>
                            </div>
                        </div>
                        <button onclick="tourSystem.completeTour()" class="btn btn-light" style="margin-top: 2rem; padding: 15px 30px; font-weight: 600;">
                            ¡Perfecto, Empecemos! <i class="fas fa-rocket ms-2"></i>
                        </button>
                    </div>
                `;
            }

            completeTour() {
                localStorage.setItem('ecopuntos_tour_completed', 'true');
                localStorage.setItem('ecopuntos_last_activity', new Date().toISOString());
                this.showDynamicDashboard();
            }

            // Métodos para el tour original (mejorados)
            nextStep() {
                console.log(`Avanzando del paso ${this.currentStep}`);
                
                if (this.currentStep === 1) {
                    const step1 = document.getElementById('step1');
                    const step2 = document.getElementById('step2');
                    if (step1) step1.style.display = 'none';
                    if (step2) step2.style.display = 'block';
                    this.updateDots(2);
                    this.currentStep = 2;
                } else if (this.currentStep === 2) {
                    const step2 = document.getElementById('step2');
                    const step3 = document.getElementById('step3');
                    if (step2) step2.style.display = 'none';
                    if (step3) step3.style.display = 'block';
                    this.updateDots(3);
                    this.currentStep = 3;
                } else if (this.currentStep === 3) {
                    const step3 = document.getElementById('step3');
                    const step4 = document.getElementById('step4');
                    if (step3) step3.style.display = 'none';
                    if (step4) step4.style.display = 'block';
                    this.updateDots(4);
                    this.currentStep = 4;
                } else if (this.currentStep === 4) {
                    const step4 = document.getElementById('step4');
                    const step5 = document.getElementById('step5');
                    if (step4) step4.style.display = 'none';
                    if (step5) step5.style.display = 'block';
                    this.updateDots(5);
                    this.currentStep = 5;
                }
            }

            prevStep() {
                console.log(`Retrocediendo del paso ${this.currentStep}`);
                
                if (this.currentStep === 2) {
                    const step2 = document.getElementById('step2');
                    const step1 = document.getElementById('step1');
                    if (step2) step2.style.display = 'none';
                    if (step1) step1.style.display = 'block';
                    this.updateDots(1);
                    this.currentStep = 1;
                } else if (this.currentStep === 3) {
                    const step3 = document.getElementById('step3');
                    const step2 = document.getElementById('step2');
                    if (step3) step3.style.display = 'none';
                    if (step2) step2.style.display = 'block';
                    this.updateDots(2);
                    this.currentStep = 2;
                } else if (this.currentStep === 4) {
                    const step4 = document.getElementById('step4');
                    const step3 = document.getElementById('step3');
                    if (step4) step4.style.display = 'none';
                    if (step3) step3.style.display = 'block';
                    this.updateDots(3);
                    this.currentStep = 3;
                } else if (this.currentStep === 5) {
                    const step5 = document.getElementById('step5');
                    const step4 = document.getElementById('step4');
                    if (step5) step5.style.display = 'none';
                    if (step4) step4.style.display = 'block';
                    this.updateDots(4);
                    this.currentStep = 4;
                }
            }

            updateDots(activeStep) {
                console.log(`Actualizando dots para paso ${activeStep}`);
                for (let i = 1; i <= 5; i++) {
                    const dot = document.getElementById(`dot${i}`);
                    if (dot) {
                        dot.style.background = i === activeStep ? 'white' : 'rgba(255,255,255,0.5)';
                    }
                }
            }

            skipTour() {
                this.completeTour();
            }

            finishTour() {
                const tourContainer = document.getElementById('miniTour');
                tourContainer.innerHTML = `
                    <div style="text-align: center; padding: 4rem 3rem;">
                        <i class="fas fa-check-circle" style="font-size: 5rem; color: white; margin-bottom: 2rem; animation: pulse 2s infinite;"></i>
                        <h1 style="font-size: 2.5rem; font-weight: 700; color: white; margin-bottom: 1rem;">¡Excelente! 🎉</h1>
                        <p style="font-size: 1.2rem; color: rgba(255,255,255,0.9); margin-bottom: 3rem;">
                            Ahora eres parte de la comunidad EcoPuntos.<br>
                            ¡Comencemos a cambiar el mundo juntos!
                        </p>
                        <div class="d-flex gap-3 justify-content-center flex-wrap">
                            <button onclick="tourSystem.goToCategorias()" class="btn btn-light" style="padding: 1rem 2rem; font-weight: 600; margin: 0.5rem;">
                                <i class="fas fa-recycle me-2"></i>Empezar a Reciclar
                            </button>
                            <button onclick="tourSystem.completeTour()" class="btn btn-success" style="padding: 1rem 2rem; font-weight: 600; margin: 0.5rem;">
                                <i class="fas fa-tachometer-alt me-2"></i>Ir al Dashboard
                            </button>
                        </div>
                    </div>
                `;
            }

            goToCategorias() {
                localStorage.setItem('ecopuntos_tour_completed', 'true');
                localStorage.setItem('ecopuntos_last_activity', new Date().toISOString());
                window.location.href = '{% url "categorias" %}';
            }
        }

        // Inicializar el sistema cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Dar tiempo para que el HTML se renderice completamente
            setTimeout(() => {
                window.tourSystem = new IntelligentTourSystem();
            }, 100);
        });

        // Funciones globales para compatibilidad con el HTML existente - SIMPLIFICADAS
        function nextStep() { 
            console.log('nextStep llamada');
            if (window.tourSystem && window.tourSystem.nextStep) {
                window.tourSystem.nextStep(); 
            } else {
                console.error('tourSystem no disponible, usando fallback');
                // Fallback simple
                fallbackNextStep();
            }
        }
        function prevStep() { 
            console.log('prevStep llamada');
            if (window.tourSystem && window.tourSystem.prevStep) {
                window.tourSystem.prevStep(); 
            } else {
                console.error('tourSystem no disponible, usando fallback');
                // Fallback simple
                fallbackPrevStep();
            }
        }
        function skipTour() { 
            console.log('skipTour llamada');
            if (window.tourSystem && window.tourSystem.skipTour) {
                window.tourSystem.skipTour(); 
            } else {
                window.location.href = '{% url "categorias" %}';
            }
        }
        function finishTour() { 
            console.log('finishTour llamada');
            if (window.tourSystem && window.tourSystem.finishTour) {
                window.tourSystem.finishTour(); 
            } else {
                window.location.href = '{% url "categorias" %}';
            }
        }
        function goToCategorias() { 
            console.log('goToCategorias llamada');
            if (window.tourSystem && window.tourSystem.goToCategorias) {
                window.tourSystem.goToCategorias(); 
            } else {
                window.location.href = '{% url "categorias" %}';
            }
        }
        
        // Funciones de fallback simples
        let currentTourStep = 1;
        
        function fallbackNextStep() {
            console.log('Usando fallback nextStep');
            if (currentTourStep === 1) {
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
                updateFallbackDots(2);
                currentTourStep = 2;
            } else if (currentTourStep === 2) {
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step3').style.display = 'block';
                updateFallbackDots(3);
                currentTourStep = 3;
            } else if (currentTourStep === 3) {
                document.getElementById('step3').style.display = 'none';
                document.getElementById('step4').style.display = 'block';
                updateFallbackDots(4);
                currentTourStep = 4;
            } else if (currentTourStep === 4) {
                document.getElementById('step4').style.display = 'none';
                document.getElementById('step5').style.display = 'block';
                updateFallbackDots(5);
                currentTourStep = 5;
            }
        }
        
        function fallbackPrevStep() {
            console.log('Usando fallback prevStep');
            if (currentTourStep === 2) {
                document.getElementById('step2').style.display = 'none';
                document.getElementById('step1').style.display = 'block';
                updateFallbackDots(1);
                currentTourStep = 1;
            } else if (currentTourStep === 3) {
                document.getElementById('step3').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
                updateFallbackDots(2);
                currentTourStep = 2;
            } else if (currentTourStep === 4) {
                document.getElementById('step4').style.display = 'none';
                document.getElementById('step3').style.display = 'block';
                updateFallbackDots(3);
                currentTourStep = 3;
            } else if (currentTourStep === 5) {
                document.getElementById('step5').style.display = 'none';
                document.getElementById('step4').style.display = 'block';
                updateFallbackDots(4);
                currentTourStep = 4;
            }
        }
        
        function updateFallbackDots(activeStep) {
            for (let i = 1; i <= 5; i++) {
                const dot = document.getElementById(`dot${i}`);
                if (dot) {
                    dot.style.background = i === activeStep ? 'white' : 'rgba(255,255,255,0.5)';
                }
            }
        }

        // 🎯 TUTORIAL INTERACTIVO SISTEMA
        class InteractiveTutorial {
            constructor() {
                this.currentStep = 0;
                this.totalSteps = 6;
                this.overlay = document.getElementById('tutorialOverlay');
                this.highlight = document.getElementById('tutorialHighlight');
                this.stepElement = document.getElementById('tutorialStep');
                this.isActive = false;
                
                this.steps = [
                    {
                        title: '¡Bienvenido a EcoPuntos!',
                        content: 'Te guiaremos a través de las funcionalidades principales de tu dashboard ecológico. ¡Comenzemos!',
                        target: '.welcome-container',
                        position: 'bottom'
                    },
                    {
                        title: 'Tus Puntos y Progreso',
                        content: 'Aquí puedes ver tus puntos actuales y el progreso hacia el siguiente nivel. ¡Cada acción cuenta!',
                        target: '.stats-container',
                        position: 'top'
                    },
                    {
                        title: 'Juegos Educativos',
                        content: 'Aprende sobre reciclaje jugando. Cada juego te enseña sobre diferentes materiales y te da puntos.',
                        target: '.games-section',
                        position: 'right'
                    },
                    {
                        title: 'Acciones Rápidas',
                        content: 'Accesos directos a las funciones más importantes: registrar canjes, ver recompensas y más.',
                        target: '.quick-actions-container',
                        position: 'left'
                    },
                    {
                        title: 'Tu Actividad Reciente',
                        content: 'Revisa tus últimas actividades, estadísticas semanales y objetivos próximos.',
                        target: '.recent-activity-container',
                        position: 'top'
                    },
                    {
                        title: '¡Tutorial Completado!',
                        content: 'Ahora conoces todas las funciones principales. ¡Puedes reactivar este tutorial cuando quieras con el botón de ayuda!',
                        target: '.tutorial-trigger',
                        position: 'left'
                    }
                ];
                
                this.init();
            }
            
            init() {
                // Verificar si es la primera visita
                const hasSeenTutorial = localStorage.getItem('ecopuntos_tutorial_seen');
                if (!hasSeenTutorial) {
                    setTimeout(() => this.start(), 1000);
                }
                
                // Eventos
                document.getElementById('tutorialNext').addEventListener('click', () => this.nextStep());
                document.getElementById('tutorialSkip').addEventListener('click', () => this.skip());
                document.getElementById('tutorialTrigger').addEventListener('click', () => this.start());
                
                // Cerrar con ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isActive) {
                        this.skip();
                    }
                });
            }
            
            start() {
                this.currentStep = 0;
                this.isActive = true;
                this.overlay.style.display = 'block';
                this.showStep();
                
                // Animación de entrada
                setTimeout(() => {
                    this.overlay.style.opacity = '1';
                }, 50);
            }
            
            showStep() {
                const step = this.steps[this.currentStep];
                const target = document.querySelector(step.target);
                
                if (!target) return;
                
                // Actualizar contenido
                document.getElementById('stepNumber').textContent = this.currentStep + 1;
                document.getElementById('stepTitle').textContent = step.title;
                document.getElementById('stepContent').textContent = step.content;
                
                // Actualizar botones
                const nextBtn = document.getElementById('tutorialNext');
                const skipBtn = document.getElementById('tutorialSkip');
                
                if (this.currentStep === this.totalSteps - 1) {
                    nextBtn.textContent = 'Finalizar';
                    skipBtn.style.display = 'none';
                } else {
                    nextBtn.textContent = 'Siguiente';
                    skipBtn.style.display = 'inline-block';
                }
                
                // Posicionar highlight
                this.positionHighlight(target);
                
                // Posicionar tooltip
                this.positionTooltip(target, step.position);
                
                // Actualizar progress dots
                this.updateProgressDots();
                
                // Scroll a la sección
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            positionHighlight(target) {
                const rect = target.getBoundingClientRect();
                const padding = 10;
                
                this.highlight.style.left = (rect.left - padding) + 'px';
                this.highlight.style.top = (rect.top - padding) + 'px';
                this.highlight.style.width = (rect.width + padding * 2) + 'px';
                this.highlight.style.height = (rect.height + padding * 2) + 'px';
                this.highlight.style.display = 'block';
            }
            
            positionTooltip(target, position) {
                const rect = target.getBoundingClientRect();
                const tooltip = this.stepElement;
                const tooltipRect = tooltip.getBoundingClientRect();
                
                // Remover clases de posición anteriores
                tooltip.classList.remove('top', 'bottom', 'left', 'right');
                tooltip.classList.add(position);
                
                let left, top;
                
                switch (position) {
                    case 'top':
                        left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                        top = rect.top - tooltipRect.height - 20;
                        break;
                    case 'bottom':
                        left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                        top = rect.bottom + 20;
                        break;
                    case 'left':
                        left = rect.left - tooltipRect.width - 20;
                        top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                        break;
                    case 'right':
                        left = rect.right + 20;
                        top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                        break;
                }
                
                // Ajustar si se sale de la pantalla
                if (left < 10) left = 10;
                if (left + tooltipRect.width > window.innerWidth - 10) {
                    left = window.innerWidth - tooltipRect.width - 10;
                }
                if (top < 10) top = 10;
                if (top + tooltipRect.height > window.innerHeight - 10) {
                    top = window.innerHeight - tooltipRect.height - 10;
                }
                
                tooltip.style.left = left + 'px';
                tooltip.style.top = top + 'px';
            }
            
            updateProgressDots() {
                const dots = document.querySelectorAll('#tutorialProgress .tutorial-dot');
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === this.currentStep);
                });
            }
            
            nextStep() {
                if (this.currentStep < this.totalSteps - 1) {
                    this.currentStep++;
                    this.showStep();
                } else {
                    this.finish();
                }
            }
            
            skip() {
                this.finish();
            }
            
            finish() {
                this.isActive = false;
                this.overlay.style.opacity = '0';
                
                setTimeout(() => {
                    this.overlay.style.display = 'none';
                    this.highlight.style.display = 'none';
                }, 300);
                
                // Marcar como visto
                localStorage.setItem('ecopuntos_tutorial_seen', 'true');
                
                // Mostrar mensaje de éxito
                this.showSuccessMessage();
            }
            
            showSuccessMessage() {
                // Crear mensaje temporal de éxito
                const message = document.createElement('div');
                message.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10000; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-check-circle"></i>
                        <span>¡Tutorial completado! Ya conoces todas las funciones principales.</span>
                    </div>
                `;
                
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.remove();
                }, 4000);
            }
        }
        
        // === FIN SISTEMA DE TUTORIAL INTERACTIVO ===
        
        // Inicializar tutorial cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            new FloatingActionButton();
        });
        
        // === INICIO FLOATING ACTION BUTTON ===
        
        // 🎮 FAB (FLOATING ACTION BUTTON) SISTEMA
        class FloatingActionButton {
            constructor() {
                this.fabMain = document.getElementById('fabMain');
                this.fabMenu = document.getElementById('fabMenu');
                this.fabOverlay = document.getElementById('fabOverlay');
                this.isOpen = false;
                
                this.init();
            }
            
            init() {
                // Event listeners
                this.fabMain.addEventListener('click', () => this.toggle());
                this.fabOverlay.addEventListener('click', () => this.close());
                
                // Cerrar con ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isOpen) {
                        this.close();
                    }
                });
                
                // Agregar eventos de tracking
                this.addActionTracking();
            }
            
            toggle() {
                if (this.isOpen) {
                    this.close();
                } else {
                    this.open();
                }
            }
            
            open() {
                this.isOpen = true;
                this.fabMain.classList.add('active');
                this.fabMenu.classList.add('active');
                this.fabOverlay.classList.add('active');
                
                // Vibración en dispositivos móviles
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }
            
            close() {
                this.isOpen = false;
                this.fabMain.classList.remove('active');
                this.fabMenu.classList.remove('active');
                this.fabOverlay.classList.remove('active');
            }
            
            addActionTracking() {
                // Tracking de acciones para analytics
                const options = document.querySelectorAll('.fab-option');
                options.forEach(option => {
                    option.addEventListener('click', () => {
                        const action = option.dataset.action;
                        console.log(`FAB Action: ${action}`);
                        
                        // Cerrar menú después de click
                        setTimeout(() => this.close(), 200);
                        
                        // Efecto de ripple
                        this.createRippleEffect(option);
                    });
                });
            }
            
            createRippleEffect(element) {
                const ripple = document.createElement('div');
                ripple.style.cssText = `
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255, 255, 255, 0.6);
                    transform: scale(0);
                    animation: ripple 0.6s linear;
                    pointer-events: none;
                `;
                
                const rect = element.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = (rect.width / 2 - size / 2) + 'px';
                ripple.style.top = (rect.height / 2 - size / 2) + 'px';
                
                element.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 600);
            }
        }

        // Función para acción de foto
        function takePhotoAction() {
            // Verificar si el dispositivo soporta cámara
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Crear modal para captura de foto
                showPhotoModal();
            } else {
                // Fallback a input file
                showFileUploadModal();
            }
        }

        function showPhotoModal() {
            const modalHTML = `
                <div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-camera me-2"></i>Capturar Material para Reciclar
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="camera-container mb-3">
                                    <video id="cameraPreview" width="100%" height="300" autoplay style="border-radius: 10px; background: #f0f0f0;"></video>
                                    <canvas id="photoCanvas" style="display: none;"></canvas>
                                </div>
                                <div class="camera-controls">
                                    <button class="btn btn-primary btn-lg" onclick="capturePhoto()">
                                        <i class="fas fa-camera me-2"></i>Capturar
                                    </button>
                                    <button class="btn btn-secondary" onclick="switchCamera()" title="Cambiar cámara">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <p class="text-muted mt-3">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Toma una foto clara del material que vas a reciclar
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('photoModal'));
            modal.show();
            
            // Inicializar cámara
            initCamera();
            
            // Limpiar cuando se cierre
            document.getElementById('photoModal').addEventListener('hidden.bs.modal', function() {
                stopCamera();
                this.remove();
            });
        }

        function showFileUploadModal() {
            const modalHTML = `
                <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-upload me-2"></i>Subir Foto del Material
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="upload-area p-4 text-center border-dashed border-2 border-primary rounded">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <p>Arrastra una imagen aquí o haz click para seleccionar</p>
                                    <input type="file" id="photoUpload" accept="image/*" class="d-none">
                                    <button class="btn btn-primary" onclick="document.getElementById('photoUpload').click()">
                                        Seleccionar Imagen
                                    </button>
                                </div>
                                <div id="imagePreview" class="mt-3" style="display: none;">
                                    <img id="previewImg" style="max-width: 100%; border-radius: 10px;">
                                    <button class="btn btn-success btn-sm mt-2" onclick="processUploadedImage()">
                                        <i class="fas fa-check me-1"></i>Usar esta imagen
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
            modal.show();
            
            // Event listeners para upload
            document.getElementById('photoUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewImg').src = e.target.result;
                        document.getElementById('imagePreview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            document.getElementById('uploadModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        let cameraStream = null;

        function initCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    cameraStream = stream;
                    document.getElementById('cameraPreview').srcObject = stream;
                })
                .catch(err => {
                    console.error('Error accessing camera:', err);
                    alert('No se pudo acceder a la cámara. Usa la opción de subir archivo.');
                });
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            context.drawImage(video, 0, 0);
            
            // Convertir a blob y procesar
            canvas.toBlob(blob => {
                processPhotoBlob(blob);
            }, 'image/jpeg', 0.8);
        }

        function processPhotoBlob(blob) {
            // Aquí puedes enviar la imagen al servidor
            console.log('Foto capturada:', blob);
            
            // Crear preview
            const url = URL.createObjectURL(blob);
            showPhotoConfirmation(url);
        }

        function showPhotoConfirmation(imageUrl) {
            // Cerrar modal de cámara
            bootstrap.Modal.getInstance(document.getElementById('photoModal')).hide();
            
            // Mostrar confirmación
            setTimeout(() => {
                const confirmHTML = `
                    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">¿Usar esta foto?</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <img src="${imageUrl}" style="max-width: 100%; border-radius: 10px; margin-bottom: 15px;">
                                    <div class="d-flex gap-2 justify-content-center">
                                        <button class="btn btn-success" onclick="confirmPhoto('${imageUrl}')">
                                            <i class="fas fa-check me-1"></i>Sí, usar foto
                                        </button>
                                        <button class="btn btn-secondary" data-bs-dismiss="modal">
                                            <i class="fas fa-times me-1"></i>Tomar otra
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', confirmHTML);
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                modal.show();
                
                document.getElementById('confirmModal').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                    URL.revokeObjectURL(imageUrl);
                });
            }, 500);
        }

        function confirmPhoto(imageUrl) {
            // Redirigir a la página de canjes con la imagen
            localStorage.setItem('tempPhoto', imageUrl);
            window.location.href = "{% url 'canjes' %}?photo=temp";
        }

        // === SISTEMA DE LOGROS Y DESAFÍOS ===
        class AchievementSystem {
            constructor() {
                this.achievements = [
                    {
                        id: 'welcome',
                        title: 'Bienvenido EcoPuntos',
                        description: 'Únete a nuestra comunidad',
                        icon: 'fas fa-handshake',
                        requirement: 1,
                        type: 'points',
                        badgeColor: '#28a745',
                        unlocked: userPoints >= 1
                    },
                    {
                        id: 'first_hundred',
                        title: 'Primeros 100',
                        description: 'Alcanza 100 puntos',
                        icon: 'fas fa-leaf',
                        requirement: 100,
                        type: 'points',
                        badgeColor: '#20c997',
                        unlocked: userPoints >= 100
                    },
                    {
                        id: 'eco_warrior',
                        title: 'Guerrero Eco',
                        description: 'Acumula 500 puntos',
                        icon: 'fas fa-shield-alt',
                        requirement: 500,
                        type: 'points',
                        badgeColor: '#17a2b8',
                        unlocked: userPoints >= 500
                    },
                    {
                        id: 'master_recycler',
                        title: 'Maestro Reciclador',
                        description: 'Obtén 1000 puntos',
                        icon: 'fas fa-crown',
                        requirement: 1000,
                        type: 'points',
                        badgeColor: '#ffc107',
                        unlocked: userPoints >= 1000
                    },
                    {
                        id: 'eco_legend',
                        title: 'Leyenda Eco',
                        description: 'Alcanza 2500 puntos',
                        icon: 'fas fa-trophy',
                        requirement: 2500,
                        type: 'points',
                        badgeColor: '#fd7e14',
                        unlocked: userPoints >= 2500
                    },
                    {
                        id: 'planet_savior',
                        title: 'Salvador del Planeta',
                        description: 'Consigue 5000 puntos',
                        icon: 'fas fa-globe-americas',
                        requirement: 5000,
                        type: 'points',
                        badgeColor: '#6f42c1',
                        unlocked: userPoints >= 5000
                    }
                ];

                this.weeklyChallges = [
                    {
                        id: 'daily_streak',
                        title: 'Racha Diaria',
                        description: 'Inicia sesión 5 días seguidos',
                        progress: Math.min(5, 3), // Simular progreso
                        max: 5,
                        reward: 50,
                        icon: 'fas fa-calendar-check'
                    },
                    {
                        id: 'photo_master',
                        title: 'Maestro de Fotos',
                        description: 'Sube 10 fotos de materiales',
                        progress: Math.min(10, 6), // Simular progreso
                        max: 10,
                        reward: 75,
                        icon: 'fas fa-camera'
                    },
                    {
                        id: 'social_eco',
                        title: 'Eco Social',
                        description: 'Comparte 3 logros en redes',
                        progress: Math.min(3, 1), // Simular progreso
                        max: 3,
                        reward: 30,
                        icon: 'fas fa-share-alt'
                    }
                ];

                this.init();
            }

            init() {
                this.renderAchievements();
                this.renderChallenges();
                this.showNewBadges();
                this.updateChallengeTimer();
                
                // Actualizar timer cada minuto
                setInterval(() => this.updateChallengeTimer(), 60000);
            }

            renderAchievements() {
                const grid = document.getElementById('achievementsGrid');
                if (!grid) return;

                grid.innerHTML = this.achievements.map(achievement => {
                    const progress = achievement.type === 'points' ? 
                        Math.min(100, (userPoints / achievement.requirement) * 100) : 0;
                    
                    return `
                        <div class="achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}">
                            <div class="achievement-icon" style="background: ${achievement.badgeColor}">
                                <i class="${achievement.icon}"></i>
                            </div>
                            <div class="achievement-info">
                                <h4>${achievement.title}</h4>
                                <p>${achievement.description}</p>
                                ${!achievement.unlocked ? `
                                    <div class="achievement-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${progress}%"></div>
                                        </div>
                                        <span class="progress-text">${userPoints}/${achievement.requirement}</span>
                                    </div>
                                ` : '<div class="achievement-unlocked">¡Desbloqueado!</div>'}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderChallenges() {
                const list = document.getElementById('challengesList');
                if (!list) return;

                list.innerHTML = this.weeklyChallges.map(challenge => {
                    const progressPercent = (challenge.progress / challenge.max) * 100;
                    const isComplete = challenge.progress >= challenge.max;
                    
                    return `
                        <div class="challenge-item ${isComplete ? 'complete' : ''}">
                            <div class="challenge-icon">
                                <i class="${challenge.icon}"></i>
                            </div>
                            <div class="challenge-details">
                                <h4>${challenge.title}</h4>
                                <p>${challenge.description}</p>
                                <div class="challenge-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                    </div>
                                    <span class="progress-text">${challenge.progress}/${challenge.max}</span>
                                </div>
                            </div>
                            <div class="challenge-reward">
                                <i class="fas fa-coins"></i>
                                ${challenge.reward}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            showNewBadges() {
                // Simular badge recién desbloqueado para demostración
                const recentlyUnlocked = this.achievements.filter(a => a.unlocked);
                if (recentlyUnlocked.length > 0 && Math.random() > 0.7) {
                    setTimeout(() => {
                        this.showBadgeModal(recentlyUnlocked[0]);
                    }, 2000);
                }
            }

            showBadgeModal(achievement) {
                const modal = document.getElementById('floatingBadge');
                const icon = document.getElementById('badgeIcon');
                const title = document.getElementById('badgeTitle');
                const description = document.getElementById('badgeDescription');

                icon.innerHTML = `<i class="${achievement.icon}"></i>`;
                icon.style.background = achievement.badgeColor;
                title.textContent = `¡${achievement.title} Desbloqueado!`;
                description.textContent = achievement.description;

                modal.classList.add('show');

                // Auto cerrar después de 5 segundos
                setTimeout(() => {
                    modal.classList.remove('show');
                }, 5000);
            }

            updateChallengeTimer() {
                const timer = document.getElementById('timeRemaining');
                if (!timer) return;

                // Calcular tiempo hasta el próximo lunes
                const now = new Date();
                const nextMonday = new Date();
                nextMonday.setDate(now.getDate() + (7 - now.getDay() + 1) % 7);
                nextMonday.setHours(0, 0, 0, 0);

                const diff = nextMonday - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

                timer.textContent = `${days}d ${hours}h`;
            }
        }

        // Funciones globales para el sistema de logros
        function toggleAchievements() {
            const panel = document.getElementById('achievementsPanel');
            const toggle = document.getElementById('achievementsToggleText');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                toggle.textContent = 'Ocultar';
            } else {
                panel.style.display = 'none';
                toggle.textContent = 'Mostrar';
            }
        }

        function closeBadgeModal() {
            document.getElementById('floatingBadge').classList.remove('show');
        }

        // Inicializar todos los sistemas cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Retrasar inicialización para asegurar que todo esté cargado
            setTimeout(() => {
                // Sistema de tutorial
                window.tutorialSystem = new InteractiveTutorial();
                

                
                // Sistema de logros
                window.achievementSystem = new AchievementSystem();
                
                // Sistema de analytics
                window.ecoAnalytics = new EcoAnalytics();
                
                // Mostrar componentes gradualmente
                setTimeout(() => {
                    document.getElementById('achievementsPanel').style.display = 'block';
                }, 3000);
                
                setTimeout(() => {
                    document.getElementById('eventsBanner').style.display = 'block';
                }, 5000);
                
            }, 1000);
        });

        // === FIN DEL SISTEMA DE LOGROS ===

        // === SISTEMA DE PERSONALIZACIÓN DEL DASHBOARD ===
        class DashboardCustomization {
            constructor() {
                this.currentTheme = localStorage.getItem('dashboardTheme') || 'eco';
                this.currentLayout = localStorage.getItem('dashboardLayout') || 'default';
                this.widgets = JSON.parse(localStorage.getItem('dashboardWidgets')) || {
                    achievements: true,
                    stats: true,
                    events: true,
                    activity: true,
                    games: true
                };
                this.settings = JSON.parse(localStorage.getItem('dashboardSettings')) || {
                    animations: true,
                    notifications: true,
                    sound: false,
                    'auto-save': true
                };
                
                this.init();
            }

            init() {
                this.applyTheme(this.currentTheme);
                this.applyLayout(this.currentLayout);
                this.applyWidgetSettings();
                this.setupEventListeners();
                this.updateUI();
            }

            setupEventListeners() {
                // Theme selector
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const theme = option.dataset.theme;
                        this.changeTheme(theme);
                    });
                });

                // Layout selector
                document.querySelectorAll('.layout-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const layout = option.dataset.layout;
                        this.changeLayout(layout);
                    });
                });

                // Widget toggles
                document.querySelectorAll('[data-widget]').forEach(toggle => {
                    toggle.addEventListener('change', () => {
                        const widget = toggle.dataset.widget;
                        this.toggleWidget(widget, toggle.checked);
                    });
                });

                // Settings toggles
                document.querySelectorAll('[data-setting]').forEach(toggle => {
                    toggle.addEventListener('change', () => {
                        const setting = toggle.dataset.setting;
                        this.changeSetting(setting, toggle.checked);
                    });
                });
            }

            changeTheme(theme) {
                this.currentTheme = theme;
                this.applyTheme(theme);
                this.updateThemeUI();
                
                if (this.settings['auto-save']) {
                    this.saveSettings();
                }
            }

            applyTheme(theme) {
                // Remover temas anteriores
                document.body.classList.remove('theme-light', 'theme-dark', 'theme-eco', 'theme-sunset');
                
                // Aplicar nuevo tema
                document.body.classList.add(`theme-${theme}`);
                
                // Actualizar meta theme-color para mobile
                let themeColor = '#28a745'; // eco default
                switch(theme) {
                    case 'light': themeColor = '#ffffff'; break;
                    case 'dark': themeColor = '#1a1a1a'; break;
                    case 'sunset': themeColor = '#ff7675'; break;
                }
                
                let metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) {
                    metaTheme.content = themeColor;
                }
            }

            changeLayout(layout) {
                this.currentLayout = layout;
                this.applyLayout(layout);
                this.updateLayoutUI();
                
                if (this.settings['auto-save']) {
                    this.saveSettings();
                }
            }

            applyLayout(layout) {
                const mainContent = document.querySelector('.main-content');
                if (!mainContent) return;
                
                // Remover clases de layout anteriores
                mainContent.classList.remove('layout-default', 'layout-compact', 'layout-wide');
                
                // Aplicar nuevo layout
                mainContent.classList.add(`layout-${layout}`);
                
                // Aplicar estilos específicos del layout
                switch(layout) {
                    case 'compact':
                        mainContent.style.maxWidth = '1200px';
                        break;
                    case 'wide':
                        mainContent.style.maxWidth = '100%';
                        break;
                    default:
                        mainContent.style.maxWidth = '1400px';
                }
            }

            toggleWidget(widgetName, enabled) {
                this.widgets[widgetName] = enabled;
                this.applyWidgetSettings();
                
                if (this.settings['auto-save']) {
                    this.saveSettings();
                }
            }

            applyWidgetSettings() {
                Object.keys(this.widgets).forEach(widget => {
                    const elements = document.querySelectorAll(`[data-widget-id="${widget}"]`);
                    elements.forEach(el => {
                        if (this.widgets[widget]) {
                            el.style.display = '';
                            el.classList.remove('widget-hidden');
                        } else {
                            el.style.display = 'none';
                            el.classList.add('widget-hidden');
                        }
                    });
                    
                    // Casos especiales
                    if (widget === 'achievements') {
                        const panel = document.getElementById('achievementsPanel');
                        if (panel) {
                            panel.style.display = this.widgets[widget] ? 'block' : 'none';
                        }
                    }
                    
                    if (widget === 'events') {
                        const banner = document.getElementById('eventsBanner');
                        if (banner) {
                            banner.style.display = this.widgets[widget] ? 'block' : 'none';
                        }
                    }
                });
            }

            changeSetting(setting, enabled) {
                this.settings[setting] = enabled;
                this.applySetting(setting, enabled);
                
                if (this.settings['auto-save']) {
                    this.saveSettings();
                }
            }

            applySetting(setting, enabled) {
                switch(setting) {
                    case 'animations':
                        document.body.classList.toggle('no-animations', !enabled);
                        break;
                        
                    case 'notifications':

                        break;
                        
                    case 'sound':
                        // Implementar sonidos si es necesario
                        break;
                }
            }

            updateUI() {
                this.updateThemeUI();
                this.updateLayoutUI();
                this.updateWidgetUI();
                this.updateSettingsUI();
            }

            updateThemeUI() {
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.classList.toggle('active', option.dataset.theme === this.currentTheme);
                });
            }

            updateLayoutUI() {
                document.querySelectorAll('.layout-option').forEach(option => {
                    option.classList.toggle('active', option.dataset.layout === this.currentLayout);
                });
            }

            updateWidgetUI() {
                document.querySelectorAll('[data-widget]').forEach(toggle => {
                    const widget = toggle.dataset.widget;
                    toggle.checked = this.widgets[widget];
                });
            }

            updateSettingsUI() {
                document.querySelectorAll('[data-setting]').forEach(toggle => {
                    const setting = toggle.dataset.setting;
                    toggle.checked = this.settings[setting];
                });
            }

            saveSettings() {
                localStorage.setItem('dashboardTheme', this.currentTheme);
                localStorage.setItem('dashboardLayout', this.currentLayout);
                localStorage.setItem('dashboardWidgets', JSON.stringify(this.widgets));
                localStorage.setItem('dashboardSettings', JSON.stringify(this.settings));
                
                // Mostrar feedback
                this.showSaveConfirmation();
            }

            showSaveConfirmation() {
                // Crear notificación temporal
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    animation: slideInRight 0.3s ease-out;
                `;
                notification.innerHTML = '<i class="fas fa-check me-2"></i>Configuración guardada';
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            }

            resetSettings() {
                this.currentTheme = 'eco';
                this.currentLayout = 'default';
                this.widgets = {
                    achievements: true,
                    stats: true,
                    events: true,
                    activity: true,
                    games: true
                };
                this.settings = {
                    animations: true,
                    notifications: true,
                    sound: false,
                    'auto-save': true
                };
                
                this.applyTheme(this.currentTheme);
                this.applyLayout(this.currentLayout);
                this.applyWidgetSettings();
                this.updateUI();
                
                // Limpiar localStorage
                localStorage.removeItem('dashboardTheme');
                localStorage.removeItem('dashboardLayout');
                localStorage.removeItem('dashboardWidgets');
                localStorage.removeItem('dashboardSettings');
            }
        }

        // Funciones globales para el panel de configuración
        function toggleDashboardConfig() {
            const panel = document.getElementById('dashboardConfig');
            const overlay = document.getElementById('configOverlay');
            const trigger = document.getElementById('configTrigger');
            
            const isActive = panel.classList.contains('active');
            
            if (isActive) {
                closeDashboardConfig();
            } else {
                panel.classList.add('active');
                overlay.classList.add('active');
                trigger.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeDashboardConfig() {
            const panel = document.getElementById('dashboardConfig');
            const overlay = document.getElementById('configOverlay');
            const trigger = document.getElementById('configTrigger');
            
            panel.classList.remove('active');
            overlay.classList.remove('active');
            trigger.classList.remove('active');
            document.body.style.overflow = '';
        }

        function saveDashboardConfig() {
            if (window.dashboardCustomization) {
                window.dashboardCustomization.saveSettings();
            }
            closeDashboardConfig();
        }

        function resetDashboardConfig() {
            if (confirm('¿Estás seguro de que quieres restaurar la configuración por defecto?')) {
                if (window.dashboardCustomization) {
                    window.dashboardCustomization.resetSettings();
                }
            }
        }

        // === FIN SISTEMA DE PERSONALIZACIÓN ===

        // === SISTEMA DE ANALYTICS Y TRACKING ===
        class EcoAnalytics {
            constructor() {
                this.sessionId = this.generateSessionId();
                this.userId = {{ user.id|default:0 }};
                this.sessionStart = Date.now();
                this.events = [];
                this.metrics = {
                    pageViews: 0,
                    clickEvents: 0,
                    timeOnPage: 0,
                    featuresUsed: new Set(),
                    userActions: [],
                    engagement: {
                        tutorialCompleted: false,
                        fabInteractions: 0,
                        themeChanges: 0,
                        achievementsViewed: false,
                        photosTaken: 0
                    }
                };
                
                this.init();
            }

            init() {
                this.trackPageView();
                this.setupEventListeners();
                this.startEngagementTracking();
                this.loadStoredMetrics();
                
                // Auto-envío de métricas cada 5 minutos
                setInterval(() => this.sendMetrics(), 300000);
                
                // Enviar métricas al salir de la página
                window.addEventListener('beforeunload', () => this.sendMetrics());
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            trackPageView() {
                this.metrics.pageViews++;
                this.trackEvent('page_view', {
                    page: 'dashboard',
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    viewport: `${window.innerWidth}x${window.innerHeight}`
                });
            }

            setupEventListeners() {
                // Tracking de clicks generales
                document.addEventListener('click', (e) => {
                    this.trackClick(e);
                });

                // Tracking de formularios
                document.querySelectorAll('form').forEach(form => {
                    form.addEventListener('submit', (e) => {
                        this.trackEvent('form_submit', {
                            formId: form.id || 'unnamed_form',
                            action: form.action || 'no_action'
                        });
                    });
                });

                // Tracking de scroll
                let scrollTimeout;
                window.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        const scrollPercent = Math.round(
                            (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100
                        );
                        this.trackEvent('scroll', { scrollPercent });
                    }, 150);
                });

                // Tracking de tiempo en página
                setInterval(() => {
                    this.metrics.timeOnPage = Date.now() - this.sessionStart;
                }, 1000);
            }

            trackClick(event) {
                this.metrics.clickEvents++;
                
                const element = event.target;
                const elementInfo = {
                    tagName: element.tagName,
                    className: element.className,
                    id: element.id,
                    text: element.textContent?.slice(0, 50) || '',
                    timestamp: Date.now()
                };

                // Tracking específico para elementos importantes
                if (element.closest('.fab-main')) {
                    this.trackFABInteraction('main_button');
                } else if (element.closest('.fab-option')) {
                    const action = element.dataset.action || 'unknown';
                    this.trackFABInteraction(action);
                } else if (element.closest('.theme-option')) {
                    this.trackThemeChange(element.dataset.theme);
                } else if (element.closest('.achievement-card')) {
                    this.trackAchievementInteraction('card_click');
                } else if (element.closest('.tour-nav')) {
                    this.trackTutorialInteraction(element.textContent);
                }

                this.trackEvent('click', elementInfo);
            }

            trackEvent(eventType, data = {}) {
                const event = {
                    type: eventType,
                    timestamp: Date.now(),
                    sessionId: this.sessionId,
                    userId: this.userId,
                    data: data
                };

                this.events.push(event);
                this.metrics.featuresUsed.add(eventType);

                // Limitar eventos en memoria (mantener últimos 100)
                if (this.events.length > 100) {
                    this.events = this.events.slice(-100);
                }

                // Debug log
                console.log('📊 Analytics Event:', event);
            }

            // Tracking específico para features
            trackFABInteraction(action) {
                this.metrics.engagement.fabInteractions++;
                this.trackEvent('fab_interaction', {
                    action: action,
                    totalInteractions: this.metrics.engagement.fabInteractions
                });
            }

            trackThemeChange(theme) {
                this.metrics.engagement.themeChanges++;
                this.trackEvent('theme_change', {
                    newTheme: theme,
                    totalChanges: this.metrics.engagement.themeChanges
                });
            }

            trackTutorialInteraction(action) {
                this.trackEvent('tutorial_interaction', { action });
                
                if (action.includes('Completar') || action.includes('Finalizar')) {
                    this.metrics.engagement.tutorialCompleted = true;
                    this.trackEvent('tutorial_completed', {});
                }
            }

            trackAchievementInteraction(action) {
                this.metrics.engagement.achievementsViewed = true;
                this.trackEvent('achievement_interaction', { action });
            }

            trackPhotoCapture() {
                this.metrics.engagement.photosTaken++;
                this.trackEvent('photo_captured', {
                    totalPhotos: this.metrics.engagement.photosTaken
                });
            }

            trackGameInteraction(game, action) {
                this.trackEvent('game_interaction', {
                    game: game,
                    action: action
                });
            }

            // Métricas de engagement
            calculateEngagementScore() {
                let score = 0;
                
                // Puntos por acciones
                if (this.metrics.engagement.tutorialCompleted) score += 20;
                score += Math.min(this.metrics.engagement.fabInteractions * 5, 25);
                score += Math.min(this.metrics.engagement.themeChanges * 10, 30);
                if (this.metrics.engagement.achievementsViewed) score += 15;
                score += Math.min(this.metrics.engagement.photosTaken * 15, 45);
                
                // Puntos por tiempo en página (max 30 puntos)
                const timeMinutes = this.metrics.timeOnPage / 60000;
                score += Math.min(timeMinutes * 2, 30);
                
                // Puntos por diversidad de interacciones
                score += Math.min(this.metrics.featuresUsed.size * 3, 30);
                
                return Math.min(score, 100);
            }

            getEngagementLevel() {
                const score = this.calculateEngagementScore();
                
                if (score >= 80) return 'Muy Alto';
                if (score >= 60) return 'Alto';
                if (score >= 40) return 'Medio';
                if (score >= 20) return 'Bajo';
                return 'Muy Bajo';
            }

            // Almacenamiento y recuperación
            saveMetrics() {
                const metricsData = {
                    ...this.metrics,
                    featuresUsed: Array.from(this.metrics.featuresUsed),
                    lastSaved: Date.now()
                };
                
                localStorage.setItem('ecoAnalytics', JSON.stringify(metricsData));
            }

            loadStoredMetrics() {
                const stored = localStorage.getItem('ecoAnalytics');
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        this.metrics = {
                            ...this.metrics,
                            ...data,
                            featuresUsed: new Set(data.featuresUsed || [])
                        };
                    } catch (e) {
                        console.warn('Error loading stored analytics:', e);
                    }
                }
            }

            // Envío de métricas al servidor
            async sendMetrics() {
                const payload = {
                    sessionId: this.sessionId,
                    userId: this.userId,
                    metrics: {
                        ...this.metrics,
                        featuresUsed: Array.from(this.metrics.featuresUsed),
                        engagementScore: this.calculateEngagementScore(),
                        engagementLevel: this.getEngagementLevel()
                    },
                    events: this.events.slice(-20), // Últimos 20 eventos
                    timestamp: Date.now()
                };

                try {
                    // Simular envío (reemplazar con endpoint real)
                    console.log('📈 Sending analytics data:', payload);
                    
                    // En producción:
                    // const response = await fetch('/api/analytics/', {
                    //     method: 'POST',
                    //     headers: {
                    //         'Content-Type': 'application/json',
                    //         'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    //     },
                    //     body: JSON.stringify(payload)
                    // });
                    
                    this.saveMetrics();
                    
                } catch (error) {
                    console.error('Error sending analytics:', error);
                }
            }

            // Reportes en tiempo real
            generateReport() {
                const report = {
                    session: {
                        id: this.sessionId,
                        duration: Math.round((Date.now() - this.sessionStart) / 1000 / 60), // minutos
                        pageViews: this.metrics.pageViews,
                        clicks: this.metrics.clickEvents
                    },
                    engagement: {
                        score: this.calculateEngagementScore(),
                        level: this.getEngagementLevel(),
                        ...this.metrics.engagement
                    },
                    features: {
                        used: Array.from(this.metrics.featuresUsed),
                        count: this.metrics.featuresUsed.size
                    },
                    events: this.events.length
                };

                return report;
            }

            // Mostrar panel de analytics (para admin)
            showAnalyticsPanel() {
                const report = this.generateReport();
                
                const modalHTML = `
                    <div class="modal fade" id="analyticsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-chart-line me-2"></i>
                                        Reporte de Analytics
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Sesión Actual</h6>
                                            <ul class="list-unstyled">
                                                <li><strong>Duración:</strong> ${report.session.duration} min</li>
                                                <li><strong>Vistas:</strong> ${report.session.pageViews}</li>
                                                <li><strong>Clicks:</strong> ${report.session.clicks}</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Engagement</h6>
                                            <ul class="list-unstyled">
                                                <li><strong>Nivel:</strong> ${report.engagement.level}</li>
                                                <li><strong>Score:</strong> ${report.engagement.score}/100</li>
                                                <li><strong>Tutorial:</strong> ${report.engagement.tutorialCompleted ? 'Completado' : 'Pendiente'}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <hr>
                                    <h6>Features Utilizados (${report.features.count})</h6>
                                    <div class="d-flex flex-wrap gap-2">
                                        ${report.features.used.map(feature => 
                                            `<span class="badge bg-primary">${feature}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" onclick="window.ecoAnalytics.sendMetrics()">
                                        Enviar Datos
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
                modal.show();

                document.getElementById('analyticsModal').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
            }
        }

        // Funciones globales para analytics
        function showAnalytics() {
            if (window.ecoAnalytics) {
                window.ecoAnalytics.showAnalyticsPanel();
            }
        }

        // === FIN SISTEMA DE ANALYTICS ===
    </script>

    <!-- Script para aplicar widths dinámicos -->
    <script>
        $(document).ready(function() {
            // Aplicar widths a las barras de progreso
            $('.progress-bar[data-width], .progress-fill[data-width], .progress-bar-mini[data-width]').each(function() {
                const width = $(this).data('width');
                $(this).css('width', width + '%');
            });
        });
    </script>
  

</body>
</html>