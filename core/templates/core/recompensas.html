{% extends 'core/base.html' %}
{% load static %}

{% block title %}EcoPuntos - Recompensas{% endblock %}

{% block extra_css %}
<style>
/* Variables CSS */
:root {
    --primary-green: #2ECC40;
    --primary-dark: #1a7226;
    --secondary-green: #3bb33b;
    --light-green: #d4edda;
    --soft-green: #e8f5e9;
    --white: #ffffff;
    --light-gray: #f8f9fa;
    --gray-200: #dee2e6;
    --gray-300: #ced4da;
    --gray-500: #6c757d;
    --text-dark: #2c3e50;
    --text-muted: #6c757d;
    --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
    --border-radius: 8px;
    --border-radius-lg: 12px;
    --border-radius-xl: 20px;
    --transition-normal: all 0.3s ease;
}

/* Layout principal */
.container-fluid {
    padding: 0 15px;
    margin: 0 auto;
    max-width: 1400px;
}

.main-content {
    padding: 20px 0;
    min-height: calc(100vh - 120px);
}

/* Header de recompensas */
.page-header {
    background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
    border-radius: var(--border-radius-xl);
    padding: 40px 30px;
    margin-bottom: 40px;
    position: relative;
    overflow: hidden;
}

.page-title {
    color: white;
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 10px;
    position: relative;
    z-index: 2;
}

.page-subtitle {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.2rem;
    margin-bottom: 0;
    position: relative;
    z-index: 2;
}

/* Estadísticas de usuario */
.user-stats {
    background: white;
    border-radius: var(--border-radius-xl);
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, var(--soft-green) 0%, var(--light-green) 100%);
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--light-green);
    transition: var(--transition-normal);
}

.stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--primary-dark);
    margin-bottom: 5px;
    display: block;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Panel de filtros */
.filters-container {
    background: white;
    border-radius: var(--border-radius-xl);
    padding: 25px 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-label {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.filter-select, .filter-input {
    padding: 12px 16px;
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius);
    background: white;
    font-size: 0.95rem;
    transition: var(--transition-normal);
}

.btn-filter {
    background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-normal);
    font-size: 0.9rem;
}

/* Grid de recompensas */
.rewards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
}

/* Tarjetas de recompensas */
.reward-card {
    background: white;
    border-radius: var(--border-radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
    transition: var(--transition-normal);
    position: relative;
}

.reward-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.reward-card.sin-stock {
    opacity: 0.6;
    filter: grayscale(30%);
}

.reward-header {
    position: relative;
    overflow: hidden;
}

.reward-img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    transition: var(--transition-normal);
}

.reward-card:hover .reward-img {
    transform: scale(1.05);
}

.reward-badges {
    position: absolute;
    top: 15px;
    left: 15px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 2;
}

.badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: white;
}

.badge.nuevo { background: #ff6b6b; }
.badge.popular { background: #4ecdc4; }
.badge.oferta { background: #ffa726; }
.badge.stock-bajo { background: #ff7043; }

.favorite-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: var(--transition-normal);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
}

.favorite-btn i {
    color: #ddd;
    font-size: 1.1rem;
    transition: var(--transition-normal);
}

.favorite-btn.active i {
    color: #e91e63;
}

.favorite-btn:hover {
    background: white;
    transform: scale(1.1);
}

.reward-content {
    padding: 20px;
}

.reward-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 10px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.reward-description {
    color: var(--text-muted);
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 15px;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.reward-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 15px;
}

.reward-points {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--primary-green);
    font-weight: 700;
    font-size: 1.1rem;
}

.reward-points i {
    color: #ffd700;
}

.stock-info {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
}

.reward-footer {
    padding: 0 20px 20px;
}

.canje-btn {
    font-weight: 600;
    padding: 12px;
    border-radius: var(--border-radius);
    transition: var(--transition-normal);
}

.canje-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(46, 204, 64, 0.3);
}

/* Responsive */
@media (max-width: 768px) {
    .rewards-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    .filters-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <div class="container-fluid">
        
        <!-- Header de la página -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-gift me-3"></i>Recompensas EcoPuntos
            </h1>
            <p class="page-subtitle">Intercambia tus puntos por increíbles premios y productos sostenibles</p>
        </div>

        <!-- Estadísticas del usuario -->
        <div class="user-stats">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value">{{ user.puntos|default:"0" }}</span>
                    <span class="stat-label">Puntos Disponibles</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">{{ recompensas_reclamables|length|default:"0" }}</span>
                    <span class="stat-label">Recompensas Disponibles</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">{{ favoritos_ids|length|default:"0" }}</span>
                    <span class="stat-label">Favoritos</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">{{ recompensas|length|default:"0" }}</span>
                    <span class="stat-label">Total Recompensas</span>
                </div>
            </div>
        </div>

        <!-- Panel de filtros -->
        <div class="filters-container">
            <form method="GET" action="{% url 'recompensas' %}" id="filtrosForm">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="categoria" class="filter-label">Categoría</label>
                        <select name="categoria" id="categoria" class="filter-select">
                            <option value="">Todas las categorías</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}" {% if request.GET.categoria == categoria.id|stringformat:"s" %}selected{% endif %}>
                                {{ categoria.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="buscar" class="filter-label">Buscar</label>
                        <input type="text" name="buscar" id="buscar" 
                               class="filter-input" placeholder="Nombre de recompensa..."
                               value="{{ request.GET.buscar }}">
                    </div>
                    
                    <div class="filter-group" style="align-self: end;">
                        <button type="submit" class="btn-filter">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Grid de recompensas -->
        <div class="rewards-grid">
            {% for recompensa in recompensas %}
                <div class="reward-card {% if recompensa.sin_stock %}sin-stock{% endif %}">
                    <div class="reward-header">
                        {% if recompensa.imagen %}
                            <img src="{{ recompensa.imagen.url }}" alt="{{ recompensa.nombre }}" class="reward-img" 
                                 onerror="this.src='{% static 'core/img/recom.jpg' %}'">
                        {% else %}
                            <img src="{% static 'core/img/recom.jpg' %}" alt="{{ recompensa.nombre }}" class="reward-img">
                        {% endif %}
                        
                        <!-- Badges -->
                        <div class="reward-badges">
                            {% if recompensa.es_nuevo %}
                                <span class="badge nuevo">Nuevo</span>
                            {% endif %}
                            {% if recompensa.es_popular %}
                                <span class="badge popular">Popular</span>
                            {% endif %}
                            {% if recompensa.es_oferta %}
                                <span class="badge oferta">Oferta</span>
                            {% endif %}
                            {% if recompensa.stock_bajo %}
                                <span class="badge stock-bajo">Últimas unidades</span>
                            {% endif %}
                        </div>
                        
                        <!-- Botón de favorito -->
                        <button class="favorite-btn {% if recompensa.id in favoritos_ids %}active{% endif %}" 
                                data-recompensa-id="{{ recompensa.id }}">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                    
                    <div class="reward-content">
                        <h3 class="reward-title">{{ recompensa.nombre }}</h3>
                        <p class="reward-description">{{ recompensa.descripcion }}</p>
                        
                        <div class="reward-info">
                            <div class="reward-points">
                                <i class="fas fa-star"></i>
                                {{ recompensa.puntos_requeridos }} Puntos
                            </div>
                            
                            <div class="stock-info">
                                {% if recompensa.stock > 0 %}
                                    <i class="fas fa-check-circle text-success"></i>
                                    <span>Disponible ({{ recompensa.stock }} unidades)</span>
                                {% else %}
                                    <i class="fas fa-times-circle text-danger"></i>
                                    <span class="text-danger">Agotado</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="reward-footer">
                        {% if recompensa.stock > 0 and user.puntos >= recompensa.puntos_requeridos %}
                            <button class="canje-btn btn btn-success w-100" 
                                    data-recompensa-id="{{ recompensa.id }}"
                                    data-nombre="{{ recompensa.nombre }}"
                                    data-puntos="{{ recompensa.puntos_requeridos }}"
                                    data-stock="{{ recompensa.stock }}">
                                <i class="fas fa-exchange-alt me-2"></i>Canjear Ahora
                            </button>
                        {% elif recompensa.stock <= 0 %}
                            <button class="btn btn-secondary w-100" disabled>
                                <i class="fas fa-times me-2"></i>Agotado
                            </button>
                        {% else %}
                            <button class="btn btn-outline-warning w-100" disabled>
                                <i class="fas fa-coins me-2"></i>Puntos insuficientes
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                <i class="fas fa-search" style="font-size: 4rem; color: var(--gray-300); margin-bottom: 20px;"></i>
                <h3 style="color: var(--text-muted); margin-bottom: 10px;">No se encontraron recompensas</h3>
                <p style="color: var(--text-muted);">Intenta ajustar los filtros o buscar con otros términos.</p>
            </div>
            {% endfor %}
        </div>
        
    </div>
</div>

<!-- Token CSRF -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<!-- Formulario oculto para canje -->
<form method="post" id="canjeForm" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="action" value="canjear">
    <input type="hidden" name="recompensa_id" id="canjeRecompensaId">
    <input type="hidden" name="direccion_entrega" id="direccionEntregaHidden">
</form>
{% endblock %}

{% block extra_js %}
<script>
// Simple JavaScript para funcionalidad básica
document.addEventListener('DOMContentLoaded', function() {
    // Manejar favoritos
    document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const recompensaId = this.dataset.recompensaId;
            
            // Hacer petición AJAX para toggle favorito
            const formData = new FormData();
            formData.append('action', 'toggle_favorito');
            formData.append('recompensa_id', recompensaId);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.favorito) {
                    this.classList.add('active');
                } else {
                    this.classList.remove('active');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // Manejar canje
    document.querySelectorAll('.canje-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const recompensaId = this.dataset.recompensaId;
            const nombre = this.dataset.nombre;
            
            const direccion = prompt(`Por favor ingresa tu dirección de entrega para: ${nombre}`);
            if (direccion && direccion.trim()) {
                document.getElementById('canjeRecompensaId').value = recompensaId;
                document.getElementById('direccionEntregaHidden').value = direccion.trim();
                document.getElementById('canjeForm').submit();
            }
        });
    });
});
</script>
{% endblock %}