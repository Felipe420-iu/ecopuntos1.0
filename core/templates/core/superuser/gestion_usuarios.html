{# NOTA: Los errores de 'JSX element ... has no corresponding closing tag' y similares son falsos positivos del analizador, ya que este archivo es HTML Django, no JSX. Los <input> en HTML no requieren etiqueta de cierre. #}
{% extends 'core/superuser/base_superuser.html' %}
{% load static %}

{% block title %}Gesti√≥n de Usuarios - Superusuario{% endblock %}

{% block extra_css %}
<style>
    .superuser-header {
        background: linear-gradient(135deg, #dc3545, #fd7e14);
        color: white;
        padding: 1rem 0;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    .filter-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    .user-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }
    .user-card:hover {
        transform: translateY(-2px);
    }
    .role-badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
    }
    .action-btn {
        margin: 0.2rem;
    }
    
    /* Estilos para modal de √©xito */
    #exitoModal .modal-content {
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    #exitoModal .text-success {
        animation: scaleIn 0.5s ease-out;
    }
    
    @keyframes scaleIn {
        0% {
            transform: scale(0);
            opacity: 0;
        }
        50% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    #exitoDetalles .alert-light {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="superuser-header text-center">
        <div class="container">
            <h1><i class="fas fa-users-cog"></i> Gesti√≥n de Usuarios</h1>
            <p class="lead mb-0">Control total sobre usuarios del sistema</p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-card">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">Buscar</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="{{ search }}" placeholder="Username, email, nombre...">
            </div>
            <div class="col-md-3">
                <label for="role" class="form-label">Rol</label>
                <select class="form-select" id="role" name="role">
                    <option value="">Todos los roles</option>
                    {% for role_code, role_name in roles %}
                        <option value="{{ role_code }}" {% if role_filter == role_code %}selected{% endif %}>
                            {{ role_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Estado</label>
                <select class="form-select" id="status" name="status">
                    <option value="">Todos los estados</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Activos</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactivos</option>
                    <option value="suspended" {% if status_filter == 'suspended' %}selected{% endif %}>Suspendidos</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Estad√≠sticas R√°pidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-primary">{{ total_users }}</h4>
                    <p class="mb-0">Total Usuarios</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-success">{{ users.paginator.count }}</h4>
                    <p class="mb-0">Resultados</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <button class="btn btn-success" onclick="crearUsuarioModal()">
                        <i class="fas fa-user-plus"></i> Crear Usuario
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <a href="{% url 'panel_superuser' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver al Panel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Usuarios -->
    <div class="user-card">
        <div class="card-header">
            <h5><i class="fas fa-list"></i> Lista de Usuarios</h5>
        </div>
        <div class="card-body">
            {% if users %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Email</th>
                                <th>Nombre</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Puntos</th>
                                <th>Fecha Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_item in users %}
                            <tr>
                                <td>
                                    <strong>{{ user_item.username }}</strong>
                                    {% if user_item == user %}
                                        <span class="badge bg-info">T√∫</span>
                                    {% endif %}
                                </td>
                                <td>{{ user_item.email }}</td>
                                <td>{{ user_item.first_name }} {{ user_item.last_name }}</td>
                                <td>
                                    <span class="role-badge
                                        {% if user_item.role == 'superuser' %}bg-danger text-white
                                        {% elif user_item.role == 'admin' %}bg-warning text-dark
                                        {% else %}bg-success text-white{% endif %}">
                                        {{ user_item.get_role_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if user_item.suspended %}
                                        <span class="badge bg-danger">Suspendido</span>
                                    {% elif user_item.is_active %}
                                        <span class="badge bg-success">Activo</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td>{{ user_item.puntos }}</td>
                                <td>{{ user_item.fecha_registro|date:"d/m/Y" }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <!-- Ver Detalles -->
                                        <button class="btn btn-sm btn-outline-info action-btn" 
                                                onclick="verDetallesUsuario({{ user_item.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <!-- Cambiar Rol -->
                                        <button class="btn btn-sm btn-outline-primary action-btn" 
                                                onclick="cambiarRolModal({{ user_item.id }}, '{{ user_item.username }}', '{{ user_item.role }}')">
                                            <i class="fas fa-user-cog"></i>
                                        </button>
                                        <!-- Editar -->
                                        <button class="btn btn-sm btn-outline-warning action-btn" 
                                                onclick="editarUsuario({{ user_item.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <!-- Eliminar (solo si no es el usuario actual) -->
                                        {% if user_item != user %}
                                        <button class="btn btn-sm btn-outline-danger action-btn" 
                                                onclick="eliminarUsuario({{ user_item.id }}, '{{ user_item.username }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
<!-- Modal Ver Detalles Usuario -->
<div class="modal fade" id="verDetallesUsuarioModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-eye"></i> Detalles del Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="list-group">
                    <li class="list-group-item"><strong>ID:</strong> <span id="detalle_id"></span></li>
                    <li class="list-group-item"><strong>Usuario:</strong> <span id="detalle_username"></span></li>
                    <li class="list-group-item"><strong>Email:</strong> <span id="detalle_email"></span></li>
                    <li class="list-group-item"><strong>Nombre:</strong> <span id="detalle_first_name"></span></li>
                    <li class="list-group-item"><strong>Apellido:</strong> <span id="detalle_last_name"></span></li>
                    <li class="list-group-item"><strong>Rol:</strong> <span id="detalle_role"></span></li>
                    <li class="list-group-item"><strong>Activo:</strong> <span id="detalle_is_active"></span></li>
                    <li class="list-group-item"><strong>Suspendido:</strong> <span id="detalle_suspended"></span></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginaci√≥n -->
                {% if users.has_other_pages %}
                <nav aria-label="Paginaci√≥n">
                    <ul class="pagination justify-content-center">
                        {% if users.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ users.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                    Anterior
                                </a>
                            </li>
                        {% endif %}

                        {% for num in users.paginator.page_range %}
                            {% if users.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > users.number|add:'-3' and num < users.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                        {{ num }}
                                    </a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if users.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ users.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                    Siguiente
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5>No se encontraron usuarios</h5>
                    <p class="text-muted">Ajusta los filtros o crea un nuevo usuario</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Crear Usuario -->
<div class="modal fade" id="crearUsuarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Crear Nuevo Usuario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="crearUsuarioForm">
                    <!-- Informaci√≥n B√°sica -->
                    <h6 class="mb-3 text-primary"><i class="fas fa-id-card"></i> Informaci√≥n B√°sica</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Nombre de usuario *</label>
                                <input type="text" class="form-control" id="username" name="username" required 
                                       placeholder="Ej: juanperez123">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" name="email" required
                                       placeholder="ejemplo@correo.com">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="first_name" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="first_name" name="first_name"
                                       placeholder="Nombre(s)">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="last_name" class="form-label">Apellido</label>
                                <input type="text" class="form-control" id="last_name" name="last_name"
                                       placeholder="Apellido(s)">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contrase√±a -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Contrase√±a *</label>
                                <input type="password" class="form-control" id="password" name="password" required
                                       placeholder="M√≠nimo 8 caracteres">
                                <small class="text-muted">Debe tener al menos 8 caracteres</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefono" class="form-label">Tel√©fono</label>
                                <input type="text" class="form-control" id="telefono" name="telefono"
                                       placeholder="Ej: 3001234567">
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Rol y Permisos -->
                    <h6 class="mb-3 text-primary"><i class="fas fa-user-shield"></i> Rol y Permisos</h6>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="role" class="form-label">Selecciona el Rol *</label>
                                <select class="form-select form-select-lg" id="role" name="role" required onchange="mostrarPermisos()">
                                    <option value="">-- Seleccionar Rol --</option>
                                    <option value="user">üë§ Usuario Regular</option>
                                    <option value="conductor">üöõ Conductor</option>
                                    <option value="admin">‚öôÔ∏è Administrador</option>
                                    <option value="superuser">üëë Superusuario</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Permisos por Rol -->
                    <div id="permisosInfo" style="display:none;">
                        <div class="alert alert-info">
                            <h6 class="alert-heading"><i class="fas fa-info-circle"></i> Permisos de este rol:</h6>
                            <div id="permisosLista"></div>
                        </div>
                    </div>

                    <hr>

                    <!-- Estado del Usuario -->
                    <h6 class="mb-3 text-primary"><i class="fas fa-toggle-on"></i> Estado Inicial</h6>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                            <label class="form-check-label" for="is_active">
                                <strong>Usuario activo</strong> - El usuario podr√° iniciar sesi√≥n inmediatamente
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnCrearUsuario" onclick="submitCrearUsuario(event)">
                    <i class="fas fa-save"></i> Crear Usuario
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cambiar Rol -->
<div class="modal fade" id="cambiarRolModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-user-cog"></i> Cambiar Rol de Usuario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Cambiar rol del usuario: <strong id="username-to-change"></strong></p>
                <form id="cambiarRolForm">
                    <input type="hidden" id="user-id-to-change" name="user_id">
                    <div class="mb-3">
                        <label for="new-role" class="form-label">Nuevo Rol</label>
                        <select class="form-select form-select-lg" id="new-role" name="role" required>
                            <option value="user">üë§ Usuario Regular</option>
                            <option value="conductor">üöõ Conductor</option>
                            <option value="admin">‚öôÔ∏è Administrador</option>
                            <option value="superuser">üëë Superusuario</option>
                        </select>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Atenci√≥n:</strong> Cambiar el rol afectar√° los permisos del usuario inmediatamente.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="submitCambiarRol()">
                    <i class="fas fa-save"></i> Cambiar Rol
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal fade" id="editarUsuarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-user-edit"></i> Editar Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUsuarioForm">
                    <input type="hidden" id="edit_user_id" name="user_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_username" class="form-label">Nombre de usuario</label>
                                <input type="text" class="form-control" id="edit_username" name="username" required readonly>
                                <small class="text-muted">El nombre de usuario no se puede modificar</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="edit_email" name="email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_first_name" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="edit_first_name" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_last_name" class="form-label">Apellido</label>
                                <input type="text" class="form-control" id="edit_last_name" name="last_name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_password" class="form-label">Nueva Contrase√±a (opcional)</label>
                                <input type="password" class="form-control" id="edit_password" name="password" 
                                       placeholder="Dejar vac√≠o para no cambiar">
                                <small class="text-muted">M√≠nimo 8 caracteres</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_role" class="form-label">Rol</label>
                                <select class="form-select" id="edit_role" name="role" required>
                                    <option value="user">üë§ Usuario Regular</option>
                                    <option value="conductor">üöõ Conductor</option>
                                    <option value="admin">‚öôÔ∏è Administrador</option>
                                    <option value="superuser">üëë Superusuario</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Gesti√≥n de Puntos -->
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-coins"></i> Gesti√≥n de Puntos</label>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">Puntos Actuales:</h5>
                                    <h3 class="mb-0 text-success"><i class="fas fa-star"></i> <span id="edit_puntos_actuales">0</span></h3>
                                </div>
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-coins"></i></span>
                                            <input type="number" class="form-control" id="edit_puntos_cantidad" 
                                                   placeholder="Cantidad de puntos" min="0" value="0">
                                            <button class="btn btn-success" type="button" onclick="ajustarPuntos('add')">
                                                <i class="fas fa-plus"></i> A√±adir
                                            </button>
                                            <button class="btn btn-danger" type="button" onclick="ajustarPuntos('subtract')">
                                                <i class="fas fa-minus"></i> Quitar
                                            </button>
                                        </div>
                                        <small class="text-muted">Ingresa la cantidad de puntos a a√±adir o quitar</small>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="edit_puntos_motivo" 
                                               placeholder="Motivo (opcional)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active">
                            <label class="form-check-label" for="edit_is_active">
                                <strong>Usuario activo</strong> - Puede iniciar sesi√≥n en el sistema
                            </label>
                        </div>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="edit_suspended" name="suspended">
                            <label class="form-check-label" for="edit_suspended">
                                <strong>Usuario suspendido</strong> - Bloqueado temporalmente
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="submitEditarUsuario()">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de √âxito -->
<div class="modal fade" id="exitoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle"></i> <span id="exitoTitulo">Operaci√≥n Exitosa</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                <h4 class="mt-3" id="exitoMensajePrincipal">Usuario creado exitosamente</h4>
                <div id="exitoDetalles" class="mt-3 text-start">
                    <!-- Detalles din√°micos -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="recargarPagina()">
                    <i class="fas fa-sync-alt"></i> Actualizar Lista
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Definir permisos por rol
const permisosPorRol = {
    'user': {
        nombre: 'Usuario Regular',
        permisos: [
            'Ver y editar su perfil personal',
            'Acumular puntos por reciclaje',
            'Jugar minijuegos educativos',
            'Canjear puntos por recompensas',
            'Agendar rutas de recolecci√≥n',
            'Ver notificaciones del sistema',
            'Participar en el ranking de usuarios'
        ]
    },
    'conductor': {
        nombre: 'Conductor',
        permisos: [
            'Todos los permisos de Usuario Regular',
            'Acceder al Panel del Conductor',
            'Ver rutas asignadas de recolecci√≥n',
            'Marcar rutas como completadas',
            'Gestionar el estado de las rutas',
            'Ver estad√≠sticas de recolecci√≥n',
            'Registrar detalles de recolecci√≥n'
        ]
    },
    'admin': {
        nombre: 'Administrador',
        permisos: [
            'Acceder al Panel de Administraci√≥n',
            'Gestionar usuarios regulares (crear, editar, desactivar)',
            'Aprobar o rechazar canjes de puntos',
            'Gestionar rutas de recolecci√≥n',
            'Ver estad√≠sticas completas del sistema',
            'Gestionar recompensas y materiales',
            'Enviar notificaciones a usuarios',
            'Monitorear sesiones activas'
        ]
    },
    'superuser': {
        nombre: 'Superusuario',
        permisos: [
            'üî• Todos los permisos del sistema',
            'Gestionar administradores y conductores',
            'Crear, editar y eliminar cualquier usuario',
            'Cambiar roles de usuarios',
            'Acceder a configuraci√≥n del sistema',
            'Suspender o reactivar usuarios',
            'Control total sobre la plataforma',
            'Gesti√≥n de seguridad y permisos'
        ]
    }
};

function mostrarPermisos() {
    const roleSelect = document.getElementById('role');
    const selectedRole = roleSelect.value;
    const permisosInfo = document.getElementById('permisosInfo');
    const permisosLista = document.getElementById('permisosLista');
    
    if (selectedRole && permisosPorRol[selectedRole]) {
        const roleData = permisosPorRol[selectedRole];
        let html = '<ul class="mb-0">';
        roleData.permisos.forEach(permiso => {
            html += `<li>${permiso}</li>`;
        });
        html += '</ul>';
        
        permisosLista.innerHTML = html;
        permisosInfo.style.display = 'block';
    } else {
        permisosInfo.style.display = 'none';
    }
}

function crearUsuarioModal() {
    // Limpiar el formulario
    document.getElementById('crearUsuarioForm').reset();
    document.getElementById('permisosInfo').style.display = 'none';
    const modalElement = document.getElementById('crearUsuarioModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

function submitCrearUsuario(event) {
    const form = document.getElementById('crearUsuarioForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Validaciones
    if (!data.username || !data.email || !data.password || !data.role) {
        alert('Por favor completa todos los campos obligatorios (*)');
        return;
    }
    
    if (data.password.length < 8) {
        alert('La contrase√±a debe tener al menos 8 caracteres');
        return;
    }
    
    // Convertir checkbox a boolean
    data.is_active = document.getElementById('is_active').checked;
    
    // Mostrar loading
    const btn = event ? event.target : document.getElementById('btnCrearUsuario');
    const btnText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
    
    fetch('{% url "crear_usuario_superuser" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = btnText;
        
        if (data.success) {
            const roleValue = document.getElementById('role').value;
            const roleName = permisosPorRol[roleValue] ? permisosPorRol[roleValue].nombre : roleValue;
            
            // Cerrar modal de creaci√≥n
            const modalElement = document.getElementById('crearUsuarioModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
            // Mostrar modal de √©xito
            mostrarModalExito(
                'Usuario Creado Exitosamente',
                'El usuario ha sido creado correctamente',
                `
                    <div class="alert alert-light border">
                        <p class="mb-2"><strong>üë§ Usuario:</strong> ${document.getElementById('username').value}</p>
                        <p class="mb-2"><strong>üìß Email:</strong> ${document.getElementById('email').value}</p>
                        <p class="mb-2"><strong>üé≠ Rol:</strong> ${roleName}</p>
                        <p class="mb-0"><strong>‚úÖ Estado:</strong> ${data.is_active ? 'Activo' : 'Inactivo'}</p>
                    </div>
                    <p class="text-muted mb-0"><i class="fas fa-info-circle"></i> El usuario puede iniciar sesi√≥n inmediatamente con sus credenciales.</p>
                `
            );
        } else {
            alert('‚ùå Error al crear usuario:\n' + data.message);
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = btnText;
        console.error('Error:', error);
        alert('‚ùå Error al crear usuario. Por favor intenta nuevamente.');
    });
}

function cambiarRolModal(userId, username, currentRole) {
    document.getElementById('user-id-to-change').value = userId;
    document.getElementById('username-to-change').textContent = username;
    document.getElementById('new-role').value = currentRole;
    const modalElement = document.getElementById('cambiarRolModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

function submitCambiarRol() {
    const userId = document.getElementById('user-id-to-change').value;
    const newRole = document.getElementById('new-role').value;
    
    fetch(`/superuser/cambiar-rol/${userId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({role: newRole})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modalElement = document.getElementById('cambiarRolModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            mostrarModalExito(
                'Rol Actualizado',
                'El rol del usuario ha sido cambiado exitosamente',
                `<p class="text-muted"><i class="fas fa-check"></i> Los permisos del usuario se han actualizado autom√°ticamente.</p>`
            );
        } else {
            alert('‚ùå Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al cambiar rol');
    });
}

function eliminarUsuario(userId, username) {
    if (confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar permanentemente al usuario "${username}"?\n\nEsta acci√≥n NO se puede deshacer.\n\n- Se eliminar√°n todos sus datos\n- Se perder√° todo su historial\n- Sus canjes y puntos ser√°n eliminados`)) {
        fetch(`/superuser/eliminar-usuario/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarModalExito(
                    'Usuario Eliminado',
                    'El usuario ha sido eliminado permanentemente',
                    `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Esta acci√≥n no se puede deshacer.</div>`
                );
            } else {
                alert('‚ùå Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al eliminar usuario');
        });
    }
}

function editarUsuario(userId) {
    document.getElementById('editUsuarioForm').reset();
    fetch(`/superuser/obtener-usuario/${userId}/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('edit_user_id').value = data.user.id;
                document.getElementById('edit_username').value = data.user.username;
                document.getElementById('edit_email').value = data.user.email;
                document.getElementById('edit_first_name').value = data.user.first_name;
                document.getElementById('edit_last_name').value = data.user.last_name;
                document.getElementById('edit_role').value = data.user.role;
                document.getElementById('edit_is_active').checked = data.user.is_active;
                document.getElementById('edit_suspended').checked = data.user.suspended;
                document.getElementById('edit_puntos_actuales').textContent = data.user.puntos || 0;
                document.getElementById('edit_puntos_cantidad').value = 0;
                document.getElementById('edit_puntos_motivo').value = '';
                const modalElement = document.getElementById('editarUsuarioModal');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                alert('‚ùå Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al obtener datos del usuario');
        });
}

function ajustarPuntos(action) {
    const userId = document.getElementById('edit_user_id').value;
    const cantidad = parseInt(document.getElementById('edit_puntos_cantidad').value) || 0;
    const motivo = document.getElementById('edit_puntos_motivo').value || '';
    
    if (cantidad <= 0) {
        alert('‚ùå Por favor ingresa una cantidad v√°lida de puntos');
        return;
    }
    
    const confirmMsg = action === 'add' 
        ? `¬øDeseas a√±adir ${cantidad} puntos a este usuario?`
        : `¬øDeseas quitar ${cantidad} puntos de este usuario?`;
    
    if (!confirm(confirmMsg)) return;
    
    // Obtener CSRF token del cookie
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
    
    console.log('Ajustando puntos:', { userId, action, cantidad, motivo });
    
    fetch(`/superuser/ajustar-puntos/${userId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            action: action,
            cantidad: cantidad,
            motivo: motivo
        })
    })
    .then(response => {
        console.log('Respuesta recibida:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Datos recibidos:', data);
        if (data.success) {
            document.getElementById('edit_puntos_actuales').textContent = data.puntos_nuevos;
            document.getElementById('edit_puntos_cantidad').value = 0;
            document.getElementById('edit_puntos_motivo').value = '';
            
            // Mostrar mensaje de √©xito
            const actionText = action === 'add' ? 'a√±adido' : 'quitado';
            alert(`‚úÖ Se han ${actionText} ${cantidad} puntos correctamente.\n\nPuntos anteriores: ${data.puntos_anteriores}\nPuntos actuales: ${data.puntos_nuevos}`);
        } else {
            alert('‚ùå Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error completo:', error);
        alert('‚ùå Error al ajustar puntos: ' + error.message);
    });
}

function submitEditarUsuario() {
    const form = document.getElementById('editUsuarioForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.is_active = document.getElementById('edit_is_active').checked;
    data.suspended = document.getElementById('edit_suspended').checked;
    if (!data.password) delete data.password;
    const userId = data.user_id;
    
    fetch(`/superuser/editar-usuario/${userId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modalElement = document.getElementById('editarUsuarioModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            mostrarModalExito(
                'Usuario Actualizado',
                'Los datos del usuario han sido actualizados correctamente',
                `<p class="text-muted"><i class="fas fa-info-circle"></i> Los cambios est√°n disponibles inmediatamente.</p>`
            );
        } else {
            alert('‚ùå Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al actualizar usuario');
    });
}

function verDetallesUsuario(userId) {
    // Limpia los campos
    document.getElementById('detalle_id').textContent = '';
    document.getElementById('detalle_username').textContent = '';
    document.getElementById('detalle_email').textContent = '';
    document.getElementById('detalle_first_name').textContent = '';
    document.getElementById('detalle_last_name').textContent = '';
    document.getElementById('detalle_role').textContent = '';
    document.getElementById('detalle_is_active').textContent = '';
    document.getElementById('detalle_suspended').textContent = '';
    
    fetch(`/superuser/obtener-usuario/${userId}/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('detalle_id').textContent = data.user.id;
                document.getElementById('detalle_username').textContent = data.user.username;
                document.getElementById('detalle_email').textContent = data.user.email;
                document.getElementById('detalle_first_name').textContent = data.user.first_name;
                document.getElementById('detalle_last_name').textContent = data.user.last_name;
                document.getElementById('detalle_role').textContent = data.user.role;
                document.getElementById('detalle_is_active').textContent = data.user.is_active ? 'S√≠' : 'No';
                document.getElementById('detalle_suspended').textContent = data.user.suspended ? 'S√≠' : 'No';
                const modalElement = document.getElementById('verDetallesUsuarioModal');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                alert('‚ùå Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al obtener detalles del usuario');
        });
}

// Exponer funciones globalmente
window.crearUsuarioModal = crearUsuarioModal;
window.submitCrearUsuario = submitCrearUsuario;
window.cambiarRolModal = cambiarRolModal;
window.submitCambiarRol = submitCambiarRol;
window.eliminarUsuario = eliminarUsuario;
window.editarUsuario = editarUsuario;
window.submitEditarUsuario = submitEditarUsuario;
window.verDetallesUsuario = verDetallesUsuario;
window.mostrarPermisos = mostrarPermisos;

// Funci√≥n para mostrar modal de √©xito
function mostrarModalExito(titulo, mensajePrincipal, detalles) {
    document.getElementById('exitoTitulo').textContent = titulo;
    document.getElementById('exitoMensajePrincipal').textContent = mensajePrincipal;
    document.getElementById('exitoDetalles').innerHTML = detalles;
    
    const modalElement = document.getElementById('exitoModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

// Funci√≥n para recargar la p√°gina
function recargarPagina() {
    location.reload();
}

window.mostrarModalExito = mostrarModalExito;
window.recargarPagina = recargarPagina;
</script>
{% endblock %}
