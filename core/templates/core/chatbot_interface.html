{% extends 'core/base.html' %}
{% load static %}

{% block title %}EcoBot - Asistente IA - EcoPuntos{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<style>
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f8f9fa;
        margin: 0;
        padding: 0;
    }

    .chat-container {
        width: 100%;
        max-width: none;
        margin: 0;
        background: white;
        border-radius: 0;
        box-shadow: none;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .chat-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 12px 16px;
        text-align: center;
        flex-shrink: 0;
        position: sticky;
        top: 0;
        z-index: 2;
    }

    .chat-header h2 {
        margin: 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 28px;
    }

    .ai-indicator {
        font-size: 24px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .chat-status {
        background: rgba(255,255,255,0.2);
        padding: 8px 16px;
        border-radius: 20px;
        display: inline-block;
        margin-top: 10px;
        font-size: 14px;
    }

    .chat-controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        justify-content: center;
    }

    .control-btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
    }

    .control-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        padding-top: 16px;
        padding-bottom: 20px;
        background: #f8f9fa;
        scroll-behavior: smooth;
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
        z-index: 1;
    }

    .message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
        animation: slideIn 0.3s ease-out;
        max-width: 85%;
        word-wrap: break-word;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user {
        justify-content: flex-end;
    }

    .message.bot {
        justify-content: flex-start;
    }

    .message.system {
        justify-content: center;
    }

    .message-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }

    .message.user .message-avatar {
        order: 2;
        margin-right: 0;
        margin-left: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .message.bot .message-avatar {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .message-content {
        max-width: 100%;
        padding: 16px 20px;
        border-radius: 18px;
        word-wrap: break-word;
        position: relative;
        line-height: 1.55;
        font-size: 16px;
        font-weight: 400;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 5px;
    }

    .message.bot .message-content {
        background: #e9ecef;
        color: #333;
        border-bottom-left-radius: 5px;
        border: 1px solid #dee2e6;
    }

    .message.system .message-content {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
        text-align: center;
        font-style: italic;
    }

    .message-meta {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .confidence-indicator {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: bold;
    }

    .confidence-high { background: #d4edda; color: #155724; }
    .confidence-medium { background: #fff3cd; color: #856404; }
    .confidence-low { background: #f8d7da; color: #721c24; }

    .typing-indicator {
        display: none !important;
        visibility: hidden;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    .chat-input {
        padding: 12px 16px;
        background: white;
        border-top: 1px solid #e9ecef;
        flex-shrink: 0;
        position: sticky;
        bottom: 0;
        z-index: 3;
    }

    .input-group {
        display: flex;
        gap: 15px;
        align-items: center;
        background: #f8f9fa;
        padding: 18px 20px;
        border-radius: 30px;
        box-shadow: 0 3px 12px rgba(0,0,0,0.1);
        border: 2px solid #dee2e6;
    }

    .message-input {
        flex: 1;
        padding: 12px 18px;
        border: 2px solid #adb5bd;
        border-radius: 20px;
        outline: none;
        font-family: 'Poppins', sans-serif;
        resize: none;
        max-height: 100px;
        min-height: 48px;
        transition: all 0.3s;
        font-size: 22px;
        font-weight: 600;
        color: #000000 !important;
        background-color: #ffffff !important;
        line-height: 1.3;
    }

    .message-input:focus {
        border-color: #28a745;
        border-width: 3px;
        box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.2);
        background-color: #ffffff !important;
        color: #000000 !important;
    }

    .message-input::placeholder {
        color: #495057 !important;
        opacity: 1;
        font-size: 18px;
        font-weight: 400;
    }

    .input-actions {
        display: flex;
        gap: 5px;
    }

    .send-btn, .human-btn {
        border: none;
        padding: 18px 28px;
        border-radius: 24px;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.2s;
        font-size: 17px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.18);
        white-space: nowrap;
        min-height: 60px;
    }

    .send-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .human-btn {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
    }

    .send-btn:hover, .human-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .quick-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .quick-action {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.2);
        padding: 8px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
    }

    .quick-action:hover {
        background: rgba(40, 167, 69, 0.2);
        transform: translateY(-1px);
    }

    .connection-status {
        position: absolute;
        top: 10px;
        right: 20px;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
    }

    .status-connected {
        background: #d4edda;
        color: #155724;
    }

    .status-disconnected {
        background: #f8d7da;
        color: #721c24;
    }

    .escalation-notice {
        background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
        color: white;
        padding: 15px;
        margin: 10px 20px;
        border-radius: 10px;
        text-align: center;
        animation: slideIn 0.5s ease-out;
    }

    .conversation-ender {
        text-align: center;
        padding: 20px;
        border-top: 1px solid #e9ecef;
        background: #f8f9fa;
    }

    .end-conversation-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
    }

    .end-conversation-btn:hover {
        background: #5a6268;
    }

    @media (max-width: 768px) {
        .chat-container {
            margin: 10px;
            height: 90vh;
        }
        
        .message-content {
            max-width: 85%;
        }
        
        .quick-actions {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status status-disconnected">
        Conectando...
    </div>
    
    <!-- Chat Header -->
    <div class="chat-header">
        <h2>
            <span class="ai-indicator">ü§ñ</span>
            EcoBot - Asistente Inteligente
        </h2>
        <div class="chat-status" id="chatStatus">
            {% if user.is_authenticated %}
                <strong>{{ user.nombre }}</strong> | üí∞ {{ user.puntos|default:0 }} puntos
            {% else %}
                Listo para ayudarte
            {% endif %}
        </div>
        <div class="chat-controls">
            <button class="control-btn" onclick="clearChat()">
                üóëÔ∏è Limpiar Chat
            </button>
            <button class="control-btn" onclick="showHistory()">
                üìú Historial
            </button>
            <button class="control-btn" onclick="showHelp()">
                ‚ùì Ayuda
            </button>
        </div>
    </div>
    
    <!-- Chat Messages -->
    <div class="chat-messages" id="chatMessages">
        <!-- Los mensajes se cargar√°n aqu√≠ din√°micamente -->
    </div>
    
    <!-- Typing Indicator -->
    <div class="typing-indicator" id="typingIndicator">
        <div class="message-avatar">ü§ñ</div>
        <span>EcoBot est√° escribiendo</span>
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>
    
    <!-- Chat Input -->
    <div class="chat-input">
        <!-- Quick Actions -->
        <div class="quick-actions" id="quickActions">
            <div class="quick-action" onclick="sendQuickMessage('¬øCu√°ntos puntos tengo?')">
                üí∞ Mis Puntos
            </div>
            <div class="quick-action" onclick="sendQuickMessage('¬øC√≥mo canjear materiales?')">
                üîÑ Canjear
            </div>
            <div class="quick-action" onclick="sendQuickMessage('¬øQu√© materiales aceptan?')">
                ‚ôªÔ∏è Materiales
            </div>
            <div class="quick-action" onclick="sendQuickMessage('¬øCu√°l es mi nivel?')">
                üèÜ Mi Nivel
            </div>
            <div class="quick-action" onclick="sendQuickMessage('Juegos disponibles')">
                üéÆ Juegos
            </div>
        </div>
        
        <!-- Token CSRF para APIs -->
        {% csrf_token %}
        
        <div class="input-group">
            <textarea 
                id="messageInput" 
                class="message-input" 
                placeholder="Escribe tu mensaje aqu√≠... (m√°ximo 1000 caracteres)"
                maxlength="1000"
                rows="1"
            ></textarea>
            <div class="input-actions">
                <button id="humanBtn" class="human-btn" onclick="requestHuman()">
                    üë§ Humano
                </button>
                <button id="sendBtn" class="send-btn" onclick="sendMessage()">
                    ‚úàÔ∏è Enviar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Conversation Ender -->
    <div class="conversation-ender">
        <button class="end-conversation-btn" onclick="endConversation()">
            ‚úã Terminar Conversaci√≥n
        </button>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
// Variables globales
let chatSocket = null;
let isConnected = false;
let userId = "{{ user.id|default:'0' }}";
let messageHistory = [];

// Configuraci√≥n de toastr
toastr.options = {
    "closeButton": true,
    "progressBar": true,
    "positionClass": "toast-top-right",
    "timeOut": "5000"
};

// Inicializar chat al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    initializeChat();
    setupInputHandlers();
    loadChatHistory();
});

// Inicializar conexi√≥n WebSocket
function initializeChat() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chatbot/`;
    
    console.log('[WebSocket] Intentando conectar a:', wsUrl);
    
    try {
        chatSocket = new WebSocket(wsUrl);
        console.log('[WebSocket] Objeto creado:', chatSocket);
        
        chatSocket.onopen = function(e) {
            console.log('Conectado al chatbot');
            isConnected = true;
            updateConnectionStatus(true);
            toastr.success('Conectado al asistente IA');
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            handleIncomingMessage(data);
        };
        
        chatSocket.onclose = function(e) {
            console.log('Desconectado del chatbot');
            isConnected = false;
            updateConnectionStatus(false);
            toastr.warning('Conexi√≥n perdida. Reintentando...');
            
            // Reconectar despu√©s de 3 segundos
            setTimeout(initializeChat, 3000);
        };
        
        chatSocket.onerror = function(e) {
            console.error('Error en WebSocket:', e);
            toastr.error('Error de conexi√≥n');
        };
        
    } catch (error) {
        console.error('Error creando WebSocket:', error);
        toastr.error('No se pudo conectar al servicio de chat');
    }
}

// Manejar mensajes entrantes
function handleIncomingMessage(data) {
    switch(data.type) {
        case 'bot_message':
            displayBotMessage(data);
            break;
        case 'system_message':
            displaySystemMessage(data.message);
            break;
        case 'error_message':
            displayErrorMessage(data.message);
            break;
        case 'typing_indicator':
            toggleTypingIndicator(data.is_typing);
            break;
        case 'escalation_success':
            displayEscalationNotice(data);
            break;
        case 'conversation_ended':
            displaySystemMessage(data.message);
            disableChat();
            break;
        default:
            console.log('Tipo de mensaje desconocido:', data.type);
    }
}

// Mostrar mensaje del bot
function displayBotMessage(data) {
    const messagesContainer = document.getElementById('chatMessages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    
    const confidenceClass = getConfidenceClass(data.confidence);
    const isWelcome = data.is_welcome ? ' (Mensaje de bienvenida)' : '';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content">
            ${formatMessage(data.message)}
            <div class="message-meta">
                <span>${formatTime(data.timestamp)}</span>
                <span class="confidence-indicator ${confidenceClass}">
                    ${Math.round(data.confidence * 100)}% confianza
                </span>
                ${data.intent ? `<span>üìä ${data.intent}</span>` : ''}
                ${isWelcome}
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
    
    // Guardar en historial
    messageHistory.push({
        type: 'bot',
        content: data.message,
        timestamp: data.timestamp,
        confidence: data.confidence,
        intent: data.intent
    });
}

// Mostrar mensaje del usuario
function displayUserMessage(message) {
    const messagesContainer = document.getElementById('chatMessages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user';
    
    messageDiv.innerHTML = `
        <div class="message-content">
            ${formatMessage(message)}
            <div class="message-meta">
                <span>${formatTime(new Date().toISOString())}</span>
            </div>
        </div>
        <div class="message-avatar">üë§</div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
    
    // Guardar en historial
    messageHistory.push({
        type: 'user',
        content: message,
        timestamp: new Date().toISOString()
    });
}

// Mostrar mensaje del sistema
function displaySystemMessage(message) {
    const messagesContainer = document.getElementById('chatMessages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message system';
    
    messageDiv.innerHTML = `
        <div class="message-content">
            ${formatMessage(message)}
            <div class="message-meta">
                <span>${formatTime(new Date().toISOString())}</span>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
}

// Mostrar mensaje de error
function displayErrorMessage(message) {
    toastr.error(message);
    displaySystemMessage(`‚ùå Error: ${message}`);
}

// Mostrar aviso de escalamiento
function displayEscalationNotice(data) {
    const messagesContainer = document.getElementById('chatMessages');
    
    const noticeDiv = document.createElement('div');
    noticeDiv.className = 'escalation-notice';
    
    noticeDiv.innerHTML = `
        <h4>üé´ Ticket de Soporte Creado</h4>
        <p>${data.message}</p>
        <small>Ticket #${data.ticket_number}</small>
    `;
    
    messagesContainer.appendChild(noticeDiv);
    scrollToBottom();
    
    toastr.info(`Ticket creado: #${data.ticket_number}`);
}

// Enviar mensaje
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) {
        return;
    }
    
    // Si chat directo est√° activo, usar esa funci√≥n
    if (chatDirectoActivo) {
        const success = await enviarMensajeChatDirecto(message);
        if (success) {
            input.value = '';
            adjustTextareaHeight(input);
        }
        return;
    }
    
    // Funci√≥n normal del chatbot - SIEMPRE funciona si hay conexi√≥n
    if (!isConnected) {
        toastr.error('No hay conexi√≥n con el chatbot');
        return;
    }
    
    // Mostrar mensaje del usuario
    displayUserMessage(message);
    
    // Enviar a trav√©s de WebSocket
    chatSocket.send(JSON.stringify({
        'type': 'chat_message',
        'message': message
    }));
    
    // Limpiar input
    input.value = '';
    adjustTextareaHeight(input);
    
    // Deshabilitar bot√≥n temporalmente
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    setTimeout(() => {
        sendBtn.disabled = false;
    }, 1000);
}

// Enviar mensaje r√°pido
function sendQuickMessage(message) {
    const input = document.getElementById('messageInput');
    input.value = message;
    sendMessage();
}

async function requestHuman() {
    if (!isConnected) {
        toastr.error('No hay conexi√≥n');
        return;
    }
    
    const reason = prompt('¬øPor qu√© necesitas hablar con un humano? (opcional)') || 'Solicitud directa del usuario';
    
    try {
        toastr.info('Solicitando agente humano...');
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('mensaje', reason);
        
        const response = await fetch('{% url "escalar_a_humano" %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.chat_activo) {
                // Ya hay un chat activo
                toastr.success('Chat directo activado');
                iniciarModoChateDirecto(data.conversation_id);
            } else if (data.pendiente) {
                toastr.success('Solicitud ya enviada. Esperando respuesta del administrador.');
                mostrarNotificacionPendiente();
            } else {
                toastr.success('Solicitud enviada al equipo de soporte');
                mostrarNotificacionPendiente();
                // Continuar verificando cada 15 segundos
                iniciarVerificacionPeriodica();
            }
        } else {
            toastr.error(data.message || 'Error al procesar solicitud');
        }
    } catch (error) {
        console.error('Error:', error);
        toastr.error('Error de conexi√≥n');
    }
}

// Terminar conversaci√≥n
function endConversation() {
    if (!confirm('¬øEst√°s seguro de que quieres terminar la conversaci√≥n?')) {
        return;
    }
    
    if (isConnected) {
        chatSocket.send(JSON.stringify({
            'type': 'end_conversation'
        }));
    }
    
    toastr.success('Conversaci√≥n terminada');
}

// Configurar manejadores de eventos
function setupInputHandlers() {
    const input = document.getElementById('messageInput');
    
    // Auto-resize textarea
    input.addEventListener('input', function() {
        adjustTextareaHeight(this);
    });
    
    // Enviar con Enter (Shift+Enter para nueva l√≠nea)
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
}

// Funciones de utilidad
function adjustTextareaHeight(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
}

function updateConnectionStatus(connected) {
    const status = document.getElementById('connectionStatus');
    
    if (connected) {
        status.className = 'connection-status status-connected';
        status.textContent = '‚úì Conectado';
    } else {
        status.className = 'connection-status status-disconnected';
        status.textContent = '‚ö† Reconectando...';
    }
}

function toggleTypingIndicator(show) {
    // Indicador deshabilitado para mejor UX
    return;
}

function getConfidenceClass(confidence) {
    if (confidence >= 0.8) return 'confidence-high';
    if (confidence >= 0.6) return 'confidence-medium';
    return 'confidence-low';
}

function formatMessage(message) {
    // Convertir URLs en links
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    message = message.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
    
    // Convertir saltos de l√≠nea
    message = message.replace(/\n/g, '<br>');
    
    return message;
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('es-CO', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

function scrollToBottom() {
    const messagesContainer = document.getElementById('chatMessages');
    if (!messagesContainer) return;
    setTimeout(() => {
        const needsScroll = messagesContainer.scrollHeight > messagesContainer.clientHeight + 10;
        if (!needsScroll) {
            // Si el contenido no supera la altura del contenedor, mantenerse arriba
            messagesContainer.scrollTop = 0;
            return;
        }
        const last = messagesContainer.lastElementChild;
        if (last && typeof last.scrollIntoView === 'function') {
            last.scrollIntoView({ behavior: 'smooth', block: 'end' });
        } else {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }, 50);
}

function disableChat() {
    document.getElementById('messageInput').disabled = true;
    document.getElementById('sendBtn').disabled = true;
    document.getElementById('humanBtn').disabled = true;
}

function clearChat() {
    if (confirm('¬øEst√°s seguro de que quieres limpiar el chat?')) {
        document.getElementById('chatMessages').innerHTML = '';
        messageHistory = [];
        toastr.info('Chat limpiado');
    }
}

function showHistory() {
    window.open('{% url "historial_chatbot" %}', '_blank');
}

function showHelp() {
    displaySystemMessage(`
        <strong>ü§ñ Comandos y Funciones de EcoBot:</strong><br><br>
        
        <strong>üí¨ Preguntas frecuentes:</strong><br>
        ‚Ä¢ "¬øCu√°ntos puntos tengo?"<br>
        ‚Ä¢ "¬øC√≥mo canjear materiales?"<br>
        ‚Ä¢ "¬øQu√© materiales aceptan?"<br>
        ‚Ä¢ "¬øCu√°l es mi nivel?"<br><br>
        
        <strong>üéÆ Juegos y Actividades:</strong><br>
        ‚Ä¢ "Juegos disponibles"<br>
        ‚Ä¢ "¬øC√≥mo jugar?"<br><br>
        
        <strong>üë§ Ayuda Humana:</strong><br>
        ‚Ä¢ Usa el bot√≥n "üë§ Humano" para hablar con una persona<br>
        ‚Ä¢ Di "quiero hablar con una persona"<br><br>
        
        <strong>‚ö° Acciones R√°pidas:</strong><br>
        ‚Ä¢ Usa los botones de acci√≥n r√°pida<br>
        ‚Ä¢ Presiona Enter para enviar mensajes<br>
        ‚Ä¢ Shift+Enter para nueva l√≠nea
    `);
}

function loadChatHistory() {
    // Verificar si hay chat directo activo al cargar la p√°gina (solo chat activo, no pendiente)
    verificarChatDirectoSoloActivo();
    
    // Aqu√≠ podr√≠as cargar mensajes recientes de conversaciones anteriores
    // Por ahora, solo mostramos un mensaje de bienvenida si no hay mensajes
    setTimeout(() => {
        const messagesContainer = document.getElementById('chatMessages');
        if (messagesContainer.children.length === 0 && !chatDirectoActivo) {
            displaySystemMessage('¬°Hola! Espera un momento mientras EcoBot se conecta...');
        }
    }, 1000);
}

// ============================================
// FUNCIONES PARA CHAT DIRECTO USUARIO-ADMIN
// ============================================

let chatDirectoActivo = false;
let conversationId = null;
let adminNombre = null;
let checkMessagesInterval = null;
let verificacionInterval = null;

async function verificarChatDirectoSoloActivo() {
    try {
        const response = await fetch('{% url "verificar_chat_directo" %}');
        const data = await response.json();
        
        console.log('Verificaci√≥n chat directo:', data);
        
        // SOLO activar si realmente hay chat activo, no pendiente
        if (data.chat_activo === true && data.conversation_id) {
            iniciarModoChateDirecto(data.conversation_id, data.admin_nombre);
        }
        // Si est√° pendiente o no hay chat, NO hacer nada, dejar que funcione el chatbot normal
    } catch (error) {
        console.error('Error verificando chat directo:', error);
        // En caso de error, asumir que no hay chat activo
    }
}

async function verificarChatDirecto() {
    try {
        const response = await fetch('{% url "verificar_chat_directo" %}');
        const data = await response.json();
        
        console.log('Verificaci√≥n chat directo completa:', data);
        
        if (data.chat_activo === true && data.conversation_id) {
            iniciarModoChateDirecto(data.conversation_id, data.admin_nombre);
            return true;
        } else if (data.pendiente === true) {
            return false; // Pendiente pero no activo
        }
        return false;
    } catch (error) {
        console.error('Error verificando chat directo:', error);
        return false;
    }
}

function iniciarVerificacionPeriodica() {
    if (verificacionInterval) {
        clearInterval(verificacionInterval);
    }
    
    // Verificar cada 10 segundos si el admin acept√≥ la solicitud
    verificacionInterval = setInterval(async () => {
        const chatActivo = await verificarChatDirecto();
        if (chatActivo) {
            clearInterval(verificacionInterval);
            verificacionInterval = null;
            // Mostrar notificaci√≥n de que el chat se activ√≥
            toastr.success('¬°Un administrador se conect√≥ contigo!');
        }
    }, 10000);
}

function mostrarNotificacionPendiente() {
    // Solo mostrar una peque√±a notificaci√≥n, NO cambiar la interfaz completamente
    displaySystemMessage(`
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin: 10px 0;">
            <strong>üì© Solicitud enviada</strong><br>
            Un administrador revisar√° tu solicitud pronto. Mientras tanto, puedes seguir usando el chatbot normalmente.
        </div>
    `);
    
    // NO cambiar el header ni deshabilitar funciones
    // El chatbot sigue funcionando con normalidad
}

function iniciarModoChateDirecto(convId, adminName = null) {
    chatDirectoActivo = true;
    conversationId = convId;
    adminNombre = adminName;
    
    // Limpiar verificaci√≥n peri√≥dica si existe
    if (verificacionInterval) {
        clearInterval(verificacionInterval);
        verificacionInterval = null;
    }
    
    // Cambiar la interfaz
    document.querySelector('.chat-header h2').innerHTML = `
        üí¨ Chat Directo con ${adminNombre || 'Administrador'} 
        <small style="font-size: 14px; opacity: 0.9;">En l√≠nea</small>
    `;
    
    // Mostrar mensaje de inicio SIN limpiar el chat anterior
    displaySystemMessage(`
        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 12px; margin: 10px 0;">
            <strong>‚úÖ Chat directo iniciado</strong><br>
            Ahora est√°s hablando directamente con ${adminNombre || 'un administrador'}.<br>
            Tus mensajes ser√°n respondidos por una persona real.
        </div>
    `);
    
    // Cargar mensajes existentes
    cargarMensajesChatDirecto();
    
    // Iniciar polling para nuevos mensajes
    if (checkMessagesInterval) {
        clearInterval(checkMessagesInterval);
    }
    checkMessagesInterval = setInterval(cargarMensajesChatDirecto, 3000);
    
    // Cambiar el placeholder del input
    document.getElementById('messageInput').placeholder = 'Escribe tu mensaje al administrador...';
    
    // Deshabilitar el bot√≥n de humano
    const humanBtn = document.getElementById('humanBtn');
    if (humanBtn) {
        humanBtn.style.display = 'none';
    }
}

function mostrarEstadoPendiente() {
    // ELIMINADA - esta funci√≥n ya no se usa
}

async function cargarMensajesChatDirecto() {
    if (!chatDirectoActivo || !conversationId) {
        console.log('Chat directo no activo, saltando carga de mensajes');
        return;
    }
    
    try {
        const response = await fetch('{% url "obtener_mensajes_chat_directo" %}');
        const data = await response.json();
        
        if (data.error) {
            console.error('Error obteniendo mensajes:', data.error);
            // Si hay error, posiblemente el chat ya no est√° activo
            if (data.error.includes('No hay chat activo') || data.error.includes('no activa')) {
                // Desactivar modo chat directo y volver al chatbot normal
                desactivarModoChateDirecto();
            }
            return;
        }
        
        if (data.mensajes) {
            mostrarMensajesChatDirecto(data.mensajes);
            if (data.admin_nombre && data.admin_nombre !== adminNombre) {
                adminNombre = data.admin_nombre;
                document.querySelector('.chat-header h2').innerHTML = `
                    üí¨ Chat Directo con ${adminNombre} 
                    <small style="font-size: 14px; opacity: 0.9;">En l√≠nea</small>
                `;
            }
        }
    } catch (error) {
        console.error('Error cargando mensajes:', error);
    }
}

function desactivarModoChateDirecto() {
    console.log('Desactivando modo chat directo');
    chatDirectoActivo = false;
    conversationId = null;
    adminNombre = null;
    
    // Limpiar intervalos
    if (checkMessagesInterval) {
        clearInterval(checkMessagesInterval);
        checkMessagesInterval = null;
    }
    
    if (verificacionInterval) {
        clearInterval(verificacionInterval);
        verificacionInterval = null;
    }
    
    // Restaurar interfaz normal
    document.querySelector('.chat-header h2').innerHTML = `
        ü§ñ EcoBot <span style="font-size: 16px; opacity: 0.9;">Asistente Virtual</span>
    `;
    
    // Restaurar placeholder
    document.getElementById('messageInput').placeholder = 'Escribe tu mensaje aqu√≠... (m√°ximo 1000 caracteres)';
    
    // Mostrar bot√≥n humano de nuevo
    const humanBtn = document.getElementById('humanBtn');
    if (humanBtn) {
        humanBtn.style.display = 'block';
    }
    
    // Mostrar mensaje de que se desconect√≥
    displaySystemMessage(`
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin: 10px 0;">
            <strong>üîå Chat directo finalizado</strong><br>
            Has vuelto al chatbot autom√°tico. Puedes seguir haciendo preguntas normalmente.
        </div>
    `);
}

function mostrarMensajesChatDirecto(mensajes) {
    const messagesContainer = document.getElementById('chatMessages');
    const mensajesExistentes = new Set();
    
    // Obtener IDs de mensajes existentes
    messagesContainer.querySelectorAll('.message').forEach(msg => {
        const id = msg.getAttribute('data-mensaje-id');
        if (id) mensajesExistentes.add(id);
    });
    
    mensajes.forEach(mensaje => {
        if (!mensajesExistentes.has(mensaje.id.toString())) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${mensaje.autor === 'usuario' ? 'user-message' : 'bot-message'}`;
            messageDiv.setAttribute('data-mensaje-id', mensaje.id);
            
            const isUser = mensaje.autor === 'usuario';
            const avatarIcon = isUser ? 'üë§' : 'üë®‚Äçüíº';
            const authorName = isUser ? 'T√∫' : mensaje.nombre;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-avatar">${avatarIcon}</span>
                    <span class="message-author">${authorName}</span>
                    <span class="message-time">${mensaje.timestamp}</span>
                </div>
                <div class="message-content">${mensaje.contenido}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }
    });
    
    scrollToBottom();
}

async function enviarMensajeChatDirecto(contenido) {
    if (!chatDirectoActivo || !conversationId) {
        console.error('Chat directo no est√° activo');
        toastr.error('Chat directo no est√° activo');
        return false;
    }
    
    try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('mensaje', contenido);
        
        const response = await fetch('{% url "enviar_mensaje_usuario_chat" %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // El mensaje se envi√≥ correctamente
            // Se cargar√° en el pr√≥ximo polling
            setTimeout(cargarMensajesChatDirecto, 500);
            return true;
        } else {
            console.error('Error enviando mensaje:', data.error);
            if (data.error && data.error.includes('No tienes un chat directo activo')) {
                // El chat ya no est√° activo, desactivar modo
                desactivarModoChateDirecto();
                toastr.warning('El chat directo se ha finalizado');
            } else {
                toastr.error(data.error || 'Error enviando mensaje');
            }
            return false;
        }
    } catch (error) {
        console.error('Error enviando mensaje:', error);
        toastr.error('Error de conexi√≥n');
        return false;
    }
}
</script>
{% endblock %}