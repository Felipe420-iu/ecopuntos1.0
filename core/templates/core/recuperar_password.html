{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña | Eco Puntos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Sweetalert2 para mensajes más atractivos -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #4caf50;
            --primary-dark: #388e3c;
            --primary-light: #c8e6c9;
            --gradient-1: linear-gradient(135deg, #43a047 0%, #7cb342 100%);
            --gradient-2: linear-gradient(135deg, #2e7d32 0%, #558b2f 100%);
            --card-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        body {
            min-height: 100vh;
            background: url('{% static "core/img/nature-3294681_1920 (1) (1).jpg" %}') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0;
            padding: 0;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0);
            backdrop-filter: blur(1px);
            z-index: 0;
        }

        .container-fluid {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 0;
        }

        .recovery-container {
            position: relative;
            z-index: 1;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            width: 100%;
            max-width: 900px;
            margin: 2rem;
        }

        .row {
            margin: 0;
        }

        .logo-side {
            background: var(--gradient-1);
            padding: 3rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
            overflow: hidden;
            min-height: 500px;
        }

        .logo-side::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: url('{% static "core/img/eco.jpg" %}') no-repeat center center;
            background-size: cover;
            opacity: 0.1;
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .logo-img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .form-side {
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 500px;
        }

        .recovery-title {
            color: var(--primary-dark);
            font-weight: 700;
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-group label {
            color: #666;
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-group input {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem 1rem 1rem 2.5rem;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
            outline: none;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 2.3rem;
            color: #666;
            z-index: 2;
        }

        .recovery-btn {
            background: var(--gradient-1);
            border: none;
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 30px;
            font-weight: 600;
            width: 100%;
            margin-top: 1rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1rem;
        }

        .recovery-btn:hover {
            background: var(--gradient-2);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
            color: white;
        }

        .back-link {
            text-align: center;
            margin-top: 2rem;
            color: #666;
        }

        .back-link a {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-link a:hover {
            color: var(--primary-dark);
        }

        .info-text {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        @media (max-width: 768px) {
            .recovery-container {
                margin: 1rem;
                max-width: 95%;
            }
            
            .logo-side {
                padding: 2rem;
                min-height: 300px;
            }
            
            .form-side {
                padding: 2rem;
                min-height: auto;
            }
            
            .container-fluid {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="recovery-container">
            <div class="row g-0">
                <!-- Lado del logo -->
                <div class="col-lg-6 logo-side">
                    <img src="{% static 'core/img/eco.jpg' %}" alt="Logo EcoPuntos" class="logo-img">
                    <h2 class="mb-3">¿Olvidaste tu contraseña?</h2>
                    <p class="text-white-50">No te preocupes, te ayudamos a recuperar el acceso a tu cuenta</p>
                </div>
                
                <!-- Lado del formulario -->
                <div class="col-lg-6 form-side">
                    <h1 class="recovery-title">Recuperar Contraseña</h1>
                    
                    <p class="info-text">
                        Ingresa tu correo electrónico y te enviaremos las instrucciones para restablecer tu contraseña.
                    </p>
                    
                    <!-- Mensajes de Django -->
                    <div id="messages-container">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Formulario de recuperación -->
                    <form id="recoveryForm" method="post" action="{% url 'recuperar_password' %}">
                        {% csrf_token %}
                        
                        <!-- Campo de email -->
                        <div class="form-group">
                            <label for="recoveryEmail"><i class="fas fa-envelope me-2"></i>Correo Electrónico</label>
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" 
                                   class="form-control" 
                                   id="recoveryEmail"
                                   name="recoveryEmail" 
                                   placeholder="tu@email.com" 
                                   required 
                                   autocomplete="email">
                        </div>
                        
                        <!-- Botón de envío -->
                        <button type="submit" class="recovery-btn" id="submitBtn">
                            <i class="fas fa-paper-plane me-2"></i>
                            Enviar Instrucciones
                        </button>
                    </form>
                    
                    <!-- Enlace de regreso -->
                    <div class="back-link">
                        <a href="{% url 'iniciosesion' %}"><i class="fas fa-arrow-left me-2"></i>Volver al inicio de sesión</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Función para obtener el token CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Función para mostrar mensajes
        function showMessage(status, message) {
            const messagesContainer = document.getElementById('messages-container');
            const alertClass = status === 'success' ? 'alert-success' : 'alert-danger';
            const alertIcon = status === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
            
            messagesContainer.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="${alertIcon} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // Función para actualizar el estado del botón
        function updateButton(isLoading = false) {
            const submitBtn = document.getElementById('submitBtn');
            if (isLoading) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
                submitBtn.disabled = true;
            } else {
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Instrucciones';
                submitBtn.disabled = false;
            }
        }

        document.getElementById('recoveryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            updateButton(true);
            
            const email = document.getElementById('recoveryEmail').value;
            
            try {
                // Enviar solicitud a la API para enviar código
                const response = await fetch('/api/password-recovery/send-code/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ email: email })
                });

                const data = await response.json();
                
                if (response.ok) {
                    // Guardar el token de sesión
                    sessionStorage.setItem('recovery_token', data.token);
                    
                    // Mostrar SweetAlert con éxito
                    const result = await Swal.fire({
                        icon: 'success',
                        title: '¡Código enviado!',
                        text: 'Hemos enviado un código de verificación a tu correo electrónico',
                        showCancelButton: true,
                        confirmButtonText: 'Ya tengo el código',
                        cancelButtonText: 'Cerrar',
                        confirmButtonColor: '#4caf50',
                        cancelButtonColor: '#777'
                    });

                    // Guardar el token en sessionStorage
                    sessionStorage.setItem('recovery_token', data.token);
                    
                    // Mostrar modal para ingresar el código
                    const { value: code } = await Swal.fire({
                        title: 'Ingresa el código de verificación',
                        input: 'text',
                        inputLabel: 'Código de 6 dígitos',
                        inputPlaceholder: 'Ingresa el código que recibiste',
                        showCancelButton: true,
                        confirmButtonText: 'Verificar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#4caf50',
                        inputValidator: (value) => {
                            if (!value) {
                                return 'Debes ingresar el código';
                            }
                        }
                    });

                    if (code) {
                        // Verificar el código
                        const verifyResponse = await fetch('/api/password-recovery/verify-code/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                email: email,
                                code: code,
                                token: sessionStorage.getItem('recovery_token')
                            })
                        });

                        const verifyData = await verifyResponse.json();

                        if (verifyResponse.ok) {
                            // Guardar el token de reset
                            sessionStorage.setItem('reset_token', verifyData.reset_token);

                            // Mostrar formulario para nueva contraseña
                            const { value: formValues } = await Swal.fire({
                                title: 'Nueva contraseña',
                                html: `
                                    <input type="password" id="swal-password" class="swal2-input" placeholder="Nueva contraseña">
                                    <input type="password" id="swal-confirm-password" class="swal2-input" placeholder="Confirmar contraseña">
                                `,
                                focusConfirm: false,
                                confirmButtonText: 'Cambiar contraseña',
                                confirmButtonColor: '#4caf50',
                                preConfirm: () => {
                                    const password = document.getElementById('swal-password').value;
                                    const confirmPassword = document.getElementById('swal-confirm-password').value;
                                    if (password !== confirmPassword) {
                                        Swal.showValidationMessage('Las contraseñas no coinciden');
                                        return false;
                                    }
                                    if (password.length < 8) {
                                        Swal.showValidationMessage('La contraseña debe tener al menos 8 caracteres');
                                        return false;
                                    }
                                    return { password };
                                }
                            });

                            if (formValues) {
                                // Cambiar la contraseña
                                const resetResponse = await fetch('/api/password-recovery/reset-password/', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCookie('csrftoken')
                                    },
                                    body: JSON.stringify({
                                        email: email,
                                        password: formValues.password,
                                        token: sessionStorage.getItem('reset_token')
                                    })
                                });

                                const resetData = await resetResponse.json();

                                if (resetResponse.ok) {
                                    await Swal.fire({
                                        icon: 'success',
                                        title: '¡Contraseña actualizada!',
                                        text: 'Tu contraseña ha sido cambiada correctamente',
                                        confirmButtonText: 'Ir al login',
                                        confirmButtonColor: '#4caf50'
                                    });

                                    // Redirigir al login
                                    window.location.href = '{% url "iniciosesion" %}';
                                } else {
                                    throw new Error(resetData.error || 'Error al cambiar la contraseña');
                                }
                            }
                        } else {
                            throw new Error(verifyData.error || 'Código inválido');
                        }
                    }
                } else {
                    throw new Error(data.error || 'Error al enviar el código');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('error', error.message || 'Error de conexión');
                
                await Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Ha ocurrido un error. Por favor, inténtalo de nuevo.',
                    confirmButtonColor: '#4caf50'
                });
            } finally {
                updateButton(false);
            }
        });
    </script>
</body>
</html>